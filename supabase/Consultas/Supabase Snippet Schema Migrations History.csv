version,statements,name
00000000000000,"[""SET statement_timeout = 0"",""SET lock_timeout = 0"",""SET idle_in_transaction_session_timeout = 0"",""SET client_encoding = 'UTF8'"",""SET standard_conforming_strings = on"",""SELECT pg_catalog.set_config('search_path', '', false)"",""SET check_function_bodies = false"",""SET xmloption = content"",""SET client_min_messages = warning"",""SET row_security = off"",""CREATE SCHEMA IF NOT EXISTS \""public\"""",""ALTER SCHEMA \""public\"" OWNER TO \""pg_database_owner\"""",""COMMENT ON SCHEMA \""public\"" IS 'standard public schema'"",""CREATE TYPE \""public\"".\""recipe_status\"" AS ENUM (\n    'draft',\n    'published',\n    'archived'\n)"",""ALTER TYPE \""public\"".\""recipe_status\"" OWNER TO \""postgres\"""",""CREATE TYPE \""public\"".\""site_type\"" AS ENUM (\n    'satellite',\n    'production_center',\n    'admin'\n)"",""ALTER TYPE \""public\"".\""site_type\"" OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""_set_updated_at\""() RETURNS \""trigger\""\n    LANGUAGE \""plpgsql\""\n    AS $$\r\nBEGIN\r\n  NEW.updated_at = now();\r\n  RETURN NEW;\r\nEND$$"",""ALTER FUNCTION \""public\"".\""_set_updated_at\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""_vento_norm\""(\""input\"" \""text\"") RETURNS \""text\""\n    LANGUAGE \""sql\"" IMMUTABLE\n    AS $_$\r\n  SELECT regexp_replace(trim(coalesce($1,'')), '\\s+', ' ', 'g')\r\n$_$"",""ALTER FUNCTION \""public\"".\""_vento_norm\""(\""input\"" \""text\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""_vento_slugify\""(\""input\"" \""text\"") RETURNS \""text\""\n    LANGUAGE \""sql\"" IMMUTABLE\n    AS $_$\r\n  SELECT trim(both '-' from regexp_replace(lower(coalesce($1,'')), '[^a-z0-9]+', '-', 'g'))\r\n$_$"",""ALTER FUNCTION \""public\"".\""_vento_slugify\""(\""input\"" \""text\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""_vento_uuid_from_text\""(\""input\"" \""text\"") RETURNS \""uuid\""\n    LANGUAGE \""sql\"" IMMUTABLE\n    AS $_$\r\n  SELECT (\r\n    substr(md5(coalesce($1,'')), 1, 8)  || '-' ||\r\n    substr(md5(coalesce($1,'')), 9, 4)  || '-' ||\r\n    substr(md5(coalesce($1,'')), 13, 4) || '-' ||\r\n    substr(md5(coalesce($1,'')), 17, 4) || '-' ||\r\n    substr(md5(coalesce($1,'')), 21, 12)\r\n  )::uuid\r\n$_$"",""ALTER FUNCTION \""public\"".\""_vento_uuid_from_text\""(\""input\"" \""text\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""can_access_area\""(\""p_area_id\"" \""uuid\"") RETURNS boolean\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\n  select p_area_id is null\r\n    or public.is_owner()\r\n    or public.is_global_manager()\r\n    or exists (\r\n      select 1\r\n      from public.employee_areas ea\r\n      join public.areas a on a.id = ea.area_id\r\n      where ea.employee_id = auth.uid()\r\n        and ea.area_id = p_area_id\r\n        and coalesce(ea.is_active, true) = true\r\n        and a.site_id = public.current_employee_selected_site_id()\r\n    )\r\n    or exists (\r\n      select 1\r\n      from public.employees e\r\n      where e.id = auth.uid()\r\n        and e.area_id = p_area_id\r\n    );\r\n$$"",""ALTER FUNCTION \""public\"".\""can_access_area\""(\""p_area_id\"" \""uuid\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""can_access_recipe_scope\""(\""p_site_id\"" \""uuid\"", \""p_area_id\"" \""uuid\"") RETURNS boolean\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\n  select\n    public.is_owner()\n    or public.is_global_manager()\n    or (\n      public.current_employee_role() = any (array['manager'::text, 'logistics'::text])\n      and p_site_id is not null\n      and public.can_access_site(p_site_id)\n    )\n    or (\n      public.is_employee()\n      and p_site_id is not null\n      and p_area_id is not null\n      and public.can_access_site(p_site_id)\n      and public.can_access_area(p_area_id)\n    );\n$$"",""ALTER FUNCTION \""public\"".\""can_access_recipe_scope\""(\""p_site_id\"" \""uuid\"", \""p_area_id\"" \""uuid\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""can_access_site\""(\""p_site_id\"" \""uuid\"") RETURNS boolean\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\n  select\r\n    case\r\n      when p_site_id is null then false\r\n      when is_owner() then true\r\n      when is_global_manager() then true\r\n      when exists (\r\n        select 1\r\n        from employee_sites es\r\n        where es.employee_id = auth.uid()\r\n          and es.site_id = p_site_id\r\n          and es.is_active = true\r\n      ) then true\r\n      when exists (\r\n        select 1\r\n        from employees e\r\n        where e.id = auth.uid()\r\n          and e.site_id = p_site_id\r\n          and (e.is_active is true or e.is_active is null)\r\n      ) then true\r\n      else false\r\n    end;\r\n$$"",""ALTER FUNCTION \""public\"".\""can_access_site\""(\""p_site_id\"" \""uuid\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""current_employee_area_id\""() RETURNS \""uuid\""\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\n  select public.current_employee_selected_area_id();\r\n$$"",""ALTER FUNCTION \""public\"".\""current_employee_area_id\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""current_employee_primary_site_id\""() RETURNS \""uuid\""\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\n  select coalesce(\r\n    (\r\n      select es.site_id\r\n      from public.employee_sites es\r\n      where es.employee_id = auth.uid()\r\n        and es.is_primary = true\r\n      limit 1\r\n    ),\r\n    (\r\n      select e.site_id\r\n      from public.employees e\r\n      where e.id = auth.uid()\r\n    )\r\n  );\r\n$$"",""ALTER FUNCTION \""public\"".\""current_employee_primary_site_id\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""current_employee_role\""() RETURNS \""text\""\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\n  select e.role\r\n  from public.employees e\r\n  where e.id = auth.uid();\r\n$$"",""ALTER FUNCTION \""public\"".\""current_employee_role\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""current_employee_selected_area_id\""() RETURNS \""uuid\""\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\n  select coalesce(\r\n    (\r\n      select s.selected_area_id\r\n      from public.employee_settings s\r\n      where s.employee_id = auth.uid()\r\n    ),\r\n    (\r\n      select ea.area_id\r\n      from public.employee_areas ea\r\n      where ea.employee_id = auth.uid()\r\n        and ea.is_primary = true\r\n      limit 1\r\n    ),\r\n    (\r\n      select e.area_id\r\n      from public.employees e\r\n      where e.id = auth.uid()\r\n    )\r\n  );\r\n$$"",""ALTER FUNCTION \""public\"".\""current_employee_selected_area_id\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""current_employee_selected_site_id\""() RETURNS \""uuid\""\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\n  select coalesce(\r\n    (\r\n      select s.selected_site_id\r\n      from public.employee_settings s\r\n      where s.employee_id = auth.uid()\r\n    ),\r\n    public.current_employee_primary_site_id()\r\n  );\r\n$$"",""ALTER FUNCTION \""public\"".\""current_employee_selected_site_id\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""current_employee_site_id\""() RETURNS \""uuid\""\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\n  select public.current_employee_selected_site_id();\r\n$$"",""ALTER FUNCTION \""public\"".\""current_employee_site_id\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""device_info_has_blocking_warnings\""(\""di\"" \""jsonb\"") RETURNS boolean\n    LANGUAGE \""sql\"" IMMUTABLE\n    AS $$\r\n  select exists (\r\n    select 1\r\n    from jsonb_array_elements_text(\r\n      case\r\n        when di is null then '[]'::jsonb\r\n        when jsonb_typeof(di->'validationWarnings') = 'array' then di->'validationWarnings'\r\n        else '[]'::jsonb\r\n      end\r\n    ) as w(txt)\r\n    where lower(w.txt) like any (\r\n      array[\r\n        '%mock%',\r\n        '%simulada%',\r\n        '%spoof%',\r\n        '%punto nulo%',\r\n        '%patron sospechoso%',\r\n        '%digitos repetidos%'\r\n      ]\r\n    )\r\n  );\r\n$$"",""ALTER FUNCTION \""public\"".\""device_info_has_blocking_warnings\""(\""di\"" \""jsonb\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""enforce_attendance_geofence\""() RETURNS \""trigger\""\n    LANGUAGE \""plpgsql\"" SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\ndeclare\r\n  v_site record;\r\n  v_emp record;\r\n\r\n  v_requires_geo boolean;\r\n  v_cap integer;\r\n  v_max_acc integer;\r\n  v_radius integer;\r\n\r\n  v_distance double precision;\r\n  v_accuracy double precision;\r\nbegin\r\n  -- Hora servidor (anti manipulación)\r\n  new.occurred_at := now();\r\n\r\n  -- Empleado: debe existir y estar activo\r\n  select id, site_id, is_active\r\n    into v_emp\r\n  from public.employees\r\n  where id = new.employee_id;\r\n\r\n  if not found then\r\n    raise exception 'Empleado no encontrado';\r\n  end if;\r\n\r\n  if v_emp.is_active is false then\r\n    raise exception 'Empleado inactivo';\r\n  end if;\r\n\r\n  -- En check_in, la sede del log debe coincidir con la sede asignada al empleado\r\n  -- (si tu operación permite multi-sede formal, esto se reemplaza luego por employee_sites)\r\n  if new.action = 'check_in' and v_emp.site_id is distinct from new.site_id then\r\n    raise exception 'No autorizado: check-in solo permitido en tu sede asignada';\r\n  end if;\r\n\r\n  -- Sede: debe existir y estar activa\r\n  select id, name, type, is_active, latitude, longitude, checkin_radius_meters\r\n    into v_site\r\n  from public.sites\r\n  where id = new.site_id;\r\n\r\n  if not found then\r\n    raise exception 'Sede no encontrada';\r\n  end if;\r\n\r\n  if v_site.is_active is false then\r\n    raise exception 'Sede inactiva';\r\n  end if;\r\n\r\n  -- Requiere geolocalización si NO es vento_group\r\n  if v_site.type <> 'vento_group' then\r\n    if v_site.latitude is null or v_site.longitude is null then\r\n      raise exception 'Configuración inválida: la sede % no tiene coordenadas', v_site.name;\r\n    end if;\r\n    v_requires_geo := true;\r\n  else\r\n    v_requires_geo := false;\r\n  end if;\r\n\r\n  if v_requires_geo then\r\n    -- Debe venir ubicación\r\n    if new.latitude is null or new.longitude is null or new.accuracy_meters is null then\r\n      raise exception 'Ubicación requerida para registrar asistencia';\r\n    end if;\r\n\r\n    -- Si el cliente reporta warnings bloqueantes, rechaza (ayuda, pero no es el “anti-mock” definitivo)\r\n    if public.device_info_has_blocking_warnings(new.device_info) then\r\n      raise exception 'Ubicación no válida: señales de ubicación simulada detectadas';\r\n    end if;\r\n\r\n    -- Política estricta\r\n    if new.action = 'check_in' then\r\n      v_cap := 30;\r\n      v_max_acc := 25;\r\n    elsif new.action = 'check_out' then\r\n      v_cap := 40;\r\n      v_max_acc := 30;\r\n    else\r\n      raise exception 'Acción inválida: %', new.action;\r\n    end if;\r\n\r\n    v_radius := least(coalesce(v_site.checkin_radius_meters, 50), v_cap);\r\n    v_accuracy := new.accuracy_meters::double precision;\r\n\r\n    if v_accuracy > v_max_acc then\r\n      raise exception 'Precisión GPS insuficiente: %m (máximo %m)', round(v_accuracy), v_max_acc;\r\n    end if;\r\n\r\n    v_distance := public.haversine_m(new.latitude, new.longitude, v_site.latitude, v_site.longitude);\r\n\r\n    -- Regla estricta de confianza: distancia + precisión <= radio\r\n    if (v_distance + v_accuracy) > v_radius then\r\n      raise exception 'Fuera de rango: %m (precisión %m) > radio %m',\r\n        round(v_distance), round(v_accuracy), v_radius;\r\n    end if;\r\n  end if;\r\n\r\n  return new;\r\nend;\r\n$$"",""ALTER FUNCTION \""public\"".\""enforce_attendance_geofence\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""enforce_attendance_sequence\""() RETURNS \""trigger\""\n    LANGUAGE \""plpgsql\""\n    AS $$\r\ndeclare\r\n  v_last_action text;\r\n  v_last_site_id uuid;\r\n  v_last_occurred_at timestamptz;\r\nbegin\r\n  -- Serializa operaciones por empleado (evita doble insert concurrente)\r\n  perform pg_advisory_xact_lock(hashtext(new.employee_id::text)::bigint);\r\n\r\n  -- Validar acción (por si entra algo raro)\r\n  if new.action not in ('check_in','check_out') then\r\n    raise exception 'Acción inválida: %', new.action;\r\n  end if;\r\n\r\n  -- Tomar el último evento del empleado (global, no solo \""hoy\"")\r\n  select action, site_id, occurred_at\r\n    into v_last_action, v_last_site_id, v_last_occurred_at\r\n  from public.attendance_logs\r\n  where employee_id = new.employee_id\r\n  order by occurred_at desc, created_at desc\r\n  limit 1;\r\n\r\n  if v_last_action is null then\r\n    -- Primer evento debe ser check_in\r\n    if new.action <> 'check_in' then\r\n      raise exception 'Secuencia inválida: el primer registro debe ser check_in';\r\n    end if;\r\n\r\n    return new;\r\n  end if;\r\n\r\n  -- (Opcional pero recomendado) evitar inserts \""hacia atrás\"" en el tiempo\r\n  if new.occurred_at < v_last_occurred_at then\r\n    raise exception 'Secuencia inválida: occurred_at no puede ser menor al último registro';\r\n  end if;\r\n\r\n  -- No permitir dos acciones iguales seguidas\r\n  if new.action = v_last_action then\r\n    raise exception 'Secuencia inválida: no puedes registrar % dos veces seguidas', new.action;\r\n  end if;\r\n\r\n  -- Si es check_out, debe cerrar el mismo sitio del check_in anterior\r\n  if new.action = 'check_out' and v_last_action = 'check_in' then\r\n    if new.site_id <> v_last_site_id then\r\n      raise exception 'Secuencia inválida: el check_out debe ser en la misma sede del check_in anterior';\r\n    end if;\r\n  end if;\r\n\r\n  return new;\r\nend;\r\n$$"",""ALTER FUNCTION \""public\"".\""enforce_attendance_sequence\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""enforce_employee_role_site\""() RETURNS \""trigger\""\n    LANGUAGE \""plpgsql\""\n    AS $$\r\ndeclare\r\n  st public.site_type;\r\nbegin\r\n  select s.site_type into st\r\n  from public.sites s\r\n  where s.id = new.site_id;\r\n\r\n  if st is null then\r\n    raise exception 'site_id inválido o sede sin site_type';\r\n  end if;\r\n\r\n  -- ADMIN (Vento Group): solo gerencia\r\n  if st = 'admin' then\r\n    if new.role not in ('owner','manager') then\r\n      raise exception 'Rol \""%\"" no permitido para site_type=\""admin\""', new.role;\r\n    end if;\r\n    return new;\r\n  end if;\r\n\r\n  -- PRODUCTION CENTER\r\n  if st = 'production_center' then\r\n    if new.role not in ('owner','manager','cook','chef','baker','pastry','warehouse','logistics') then\r\n      raise exception 'Rol \""%\"" no permitido para site_type=\""production_center\""', new.role;\r\n    end if;\r\n    return new;\r\n  end if;\r\n\r\n  -- SATELLITE\r\n  if st = 'satellite' then\r\n    if new.role not in ('owner','manager','staff','cashier','waiter','barista','cook','chef','warehouse','logistics') then\r\n      raise exception 'Rol \""%\"" no permitido para site_type=\""satellite\""', new.role;\r\n    end if;\r\n    return new;\r\n  end if;\r\n\r\n  raise exception 'site_type desconocido: %', st;\r\nend;\r\n$$"",""ALTER FUNCTION \""public\"".\""enforce_employee_role_site\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""generate_location_code\""(\""p_site_code\"" \""text\"", \""p_zone\"" \""text\"", \""p_aisle\"" \""text\"" DEFAULT NULL::\""text\"", \""p_level\"" \""text\"" DEFAULT NULL::\""text\"") RETURNS \""text\""\n    LANGUAGE \""plpgsql\"" IMMUTABLE\n    AS $$\r\nDECLARE\r\n  v_code TEXT;\r\nBEGIN\r\n  v_code := 'LOC-' || UPPER(p_site_code) || '-' || UPPER(p_zone);\r\n  IF p_aisle IS NOT NULL THEN\r\n    v_code := v_code || '-' || UPPER(p_aisle);\r\n  END IF;\r\n  IF p_level IS NOT NULL THEN\r\n    v_code := v_code || '-' || UPPER(p_level);\r\n  END IF;\r\n  RETURN v_code;\r\nEND;\r\n$$"",""ALTER FUNCTION \""public\"".\""generate_location_code\""(\""p_site_code\"" \""text\"", \""p_zone\"" \""text\"", \""p_aisle\"" \""text\"", \""p_level\"" \""text\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""generate_lpn_code\""(\""p_site_code\"" \""text\"") RETURNS \""text\""\n    LANGUAGE \""plpgsql\""\n    AS $$\r\nDECLARE\r\n  v_year_month TEXT;\r\n  v_seq INT;\r\nBEGIN\r\n  v_year_month := TO_CHAR(NOW(), 'YYMM');\r\n  v_seq := NEXTVAL('lpn_sequence');\r\n  RETURN 'LPN-' || UPPER(p_site_code) || '-' || v_year_month || '-' || LPAD(v_seq::TEXT, 4, '0');\r\nEND;\r\n$$"",""ALTER FUNCTION \""public\"".\""generate_lpn_code\""(\""p_site_code\"" \""text\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""generate_product_sku\""(\""p_product_type\"" \""text\"", \""p_site_id\"" \""uuid\"" DEFAULT NULL::\""uuid\"") RETURNS \""text\""\n    LANGUAGE \""plpgsql\"" SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\ndeclare\r\n  v_site_id uuid;\r\n  v_brand_code text;\r\n  v_type_code text;\r\n  v_next integer;\r\nbegin\r\n  v_site_id := coalesce(\r\n    p_site_id,\r\n    public.current_employee_selected_site_id(),\r\n    public.current_employee_primary_site_id()\r\n  );\r\n\r\n  if v_site_id is null then\r\n    select s.id into v_site_id\r\n    from public.sites s\r\n    where s.site_kind = 'hq'\r\n    order by s.created_at\r\n    limit 1;\r\n  end if;\r\n\r\n  if v_site_id is null then\r\n    select s.id into v_site_id\r\n    from public.sites s\r\n    order by s.created_at\r\n    limit 1;\r\n  end if;\r\n\r\n  if v_site_id is null then\r\n    raise exception 'No site available to generate SKU';\r\n  end if;\r\n\r\n  v_brand_code := public.resolve_product_sku_brand_code(v_site_id);\r\n  if v_brand_code is null or v_brand_code = '' then\r\n    raise exception 'No brand code available for site %', v_site_id;\r\n  end if;\r\n\r\n  v_type_code := public.resolve_product_sku_type_code(p_product_type);\r\n  if v_type_code is null or v_type_code = '' then\r\n    v_type_code := 'GEN';\r\n  end if;\r\n\r\n  insert into public.product_sku_sequences (brand_code, type_code, last_value, updated_at)\r\n  values (v_brand_code, v_type_code, 1, now())\r\n  on conflict (brand_code, type_code)\r\n  do update\r\n    set last_value = public.product_sku_sequences.last_value + 1,\r\n        updated_at = now()\r\n  returning last_value into v_next;\r\n\r\n  return v_brand_code || '-' || v_type_code || '-' || lpad(v_next::text, 5, '0');\r\nend;\r\n$$"",""ALTER FUNCTION \""public\"".\""generate_product_sku\""(\""p_product_type\"" \""text\"", \""p_site_id\"" \""uuid\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""grant_loyalty_points\""(\""p_user_id\"" \""uuid\"", \""p_points\"" integer, \""p_description\"" \""text\"" DEFAULT NULL::\""text\"", \""p_metadata\"" \""jsonb\"" DEFAULT '{}'::\""jsonb\"") RETURNS \""jsonb\""\n    LANGUAGE \""plpgsql\"" SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\ndeclare\r\n  v_current_balance integer;\r\n  v_new_balance integer;\r\n  v_transaction_id uuid;\r\nbegin\r\n  -- ✅ Solo staff activo\r\n  if not is_active_staff() then\r\n    return jsonb_build_object('success', false, 'error', 'No autorizado (staff requerido)');\r\n  end if;\r\n\r\n  if p_user_id is null then\r\n    return jsonb_build_object('success', false, 'error', 'user_id es requerido');\r\n  end if;\r\n\r\n  if p_points is null or p_points <= 0 then\r\n    return jsonb_build_object('success', false, 'error', 'p_points debe ser mayor a 0');\r\n  end if;\r\n\r\n  -- ✅ Lock para evitar race conditions\r\n  select u.loyalty_points\r\n    into v_current_balance\r\n  from public.users u\r\n  where u.id = p_user_id\r\n  for update;\r\n\r\n  if v_current_balance is null then\r\n    return jsonb_build_object('success', false, 'error', 'Usuario no encontrado');\r\n  end if;\r\n\r\n  v_new_balance := coalesce(v_current_balance, 0) + p_points;\r\n\r\n  insert into public.loyalty_transactions (\r\n    user_id,\r\n    kind,\r\n    points_delta,\r\n    description,\r\n    metadata\r\n  ) values (\r\n    p_user_id,\r\n    'earn',\r\n    p_points,\r\n    coalesce(p_description, 'Puntos otorgados'),\r\n    coalesce(p_metadata, '{}'::jsonb) || jsonb_build_object('staff_user_id', auth.uid())\r\n  )\r\n  returning id into v_transaction_id;\r\n\r\n  -- Mantengo tu update explícito (misma conducta que hoy)\r\n  update public.users\r\n  set loyalty_points = v_new_balance,\r\n      updated_at = now()\r\n  where id = p_user_id;\r\n\r\n  return jsonb_build_object(\r\n    'success', true,\r\n    'new_balance', v_new_balance,\r\n    'points_awarded', p_points,\r\n    'transaction_id', v_transaction_id\r\n  );\r\n\r\nexception\r\n  when others then\r\n    return jsonb_build_object('success', false, 'error', sqlerrm);\r\nend;\r\n$$"",""ALTER FUNCTION \""public\"".\""grant_loyalty_points\""(\""p_user_id\"" \""uuid\"", \""p_points\"" integer, \""p_description\"" \""text\"", \""p_metadata\"" \""jsonb\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""handle_new_user\""() RETURNS \""trigger\""\n    LANGUAGE \""plpgsql\"" SECURITY DEFINER\n    AS $$\r\nBEGIN\r\n  INSERT INTO public.users (id, email, full_name, loyalty_points)\r\n  VALUES (new.id, new.email, '', 0)\r\n  ON CONFLICT (id) DO NOTHING; -- Evita errores si ya existe\r\n  RETURN new;\r\nEND;\r\n$$"",""ALTER FUNCTION \""public\"".\""handle_new_user\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""haversine_m\""(\""lat1\"" numeric, \""lon1\"" numeric, \""lat2\"" numeric, \""lon2\"" numeric) RETURNS double precision\n    LANGUAGE \""sql\"" IMMUTABLE\n    AS $$\r\n  select 2 * 6371000::double precision *\r\n    asin(\r\n      sqrt(\r\n        power(sin((((lat2::double precision - lat1::double precision) * pi()) / 180) / 2), 2) +\r\n        cos((lat1::double precision * pi()) / 180) *\r\n        cos((lat2::double precision * pi()) / 180) *\r\n        power(sin((((lon2::double precision - lon1::double precision) * pi()) / 180) / 2), 2)\r\n      )\r\n    );\r\n$$"",""ALTER FUNCTION \""public\"".\""haversine_m\""(\""lat1\"" numeric, \""lon1\"" numeric, \""lat2\"" numeric, \""lon2\"" numeric) OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""is_active_staff\""() RETURNS boolean\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\n  select public.is_employee();\r\n$$"",""ALTER FUNCTION \""public\"".\""is_active_staff\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""is_employee\""() RETURNS boolean\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\n  select exists (\r\n    select 1\r\n    from public.employees e\r\n    where e.id = auth.uid()\r\n      and coalesce(e.is_active, true) = true\r\n  );\r\n$$"",""ALTER FUNCTION \""public\"".\""is_employee\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""is_global_manager\""() RETURNS boolean\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\n  select exists (\r\n    select 1\r\n    from employees e\r\n    join sites s on s.id = e.site_id\r\n    where e.id = auth.uid()\r\n      and e.role = 'manager'\r\n      and s.site_type = 'admin'\r\n  )\r\n  or exists (\r\n    select 1\r\n    from employee_sites es\r\n    join sites s on s.id = es.site_id\r\n    join employees e on e.id = es.employee_id\r\n    where es.employee_id = auth.uid()\r\n      and es.is_active = true\r\n      and e.role = 'manager'\r\n      and s.site_type = 'admin'\r\n  );\r\n$$"",""ALTER FUNCTION \""public\"".\""is_global_manager\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""is_manager\""() RETURNS boolean\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\n  select public.current_employee_role() = 'manager';\r\n$$"",""ALTER FUNCTION \""public\"".\""is_manager\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""is_manager_or_owner\""() RETURNS boolean\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\n  select public.current_employee_role() in ('owner', 'manager');\r\n$$"",""ALTER FUNCTION \""public\"".\""is_manager_or_owner\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""is_owner\""() RETURNS boolean\n    LANGUAGE \""sql\"" STABLE SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\n  select public.current_employee_role() = 'owner';\r\n$$"",""ALTER FUNCTION \""public\"".\""is_owner\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""process_loyalty_earning\""(\""p_order_id\"" \""uuid\"") RETURNS \""void\""\n    LANGUAGE \""plpgsql\"" SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\ndeclare\r\n  POINT_CONVERSION_RATE constant integer := 1000; -- 1 punto por cada X pesos\r\n  v_order record;\r\n  v_points integer;\r\nbegin\r\n  -- Obtener y bloquear la orden\r\n  select\r\n    o.id,\r\n    o.client_id,\r\n    o.payment_status,\r\n    o.loyalty_processed,\r\n    o.total_amount,           -- TODO: cambia al campo real de monto\r\n    o.loyalty_points_awarded  -- TODO: cambia al campo real de puntos ganados\r\n  into v_order\r\n  from public.orders o\r\n  where o.id = p_order_id\r\n  for update;\r\n\r\n  if not found then\r\n    raise exception 'Order % not found', p_order_id using errcode = 'P0001';\r\n  end if;\r\n\r\n  if v_order.payment_status <> 'paid' then\r\n    raise exception 'Order % is not paid', p_order_id using errcode = 'P0001';\r\n  end if;\r\n\r\n  if v_order.loyalty_processed then\r\n    raise exception 'Order % already processed for loyalty', p_order_id using errcode = 'P0001';\r\n  end if;\r\n\r\n  v_points := floor(coalesce(v_order.total_amount, 0) / POINT_CONVERSION_RATE);\r\n\r\n  -- Si no hay puntos, solo marcamos procesada\r\n  if v_points <= 0 then\r\n    update public.orders\r\n      set loyalty_processed = true,\r\n          loyalty_points_awarded = 0\r\n    where id = p_order_id;\r\n    return;\r\n  end if;\r\n\r\n  insert into public.loyalty_transactions (\r\n    user_id,\r\n    order_id,\r\n    kind,\r\n    points_delta,\r\n    description\r\n  ) values (\r\n    v_order.client_id,\r\n    p_order_id,\r\n    'earn',\r\n    v_points,\r\n    'Order paid: loyalty earning'\r\n  );\r\n\r\n  update public.users\r\n    set loyalty_points = coalesce(loyalty_points, 0) + v_points\r\n  where id = v_order.client_id;\r\n\r\n  update public.orders\r\n    set loyalty_processed = true,\r\n        loyalty_points_awarded = v_points\r\n  where id = p_order_id;\r\nend;\r\n$$"",""ALTER FUNCTION \""public\"".\""process_loyalty_earning\""(\""p_order_id\"" \""uuid\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""process_order_payment\""(\""p_order_id\"" \""uuid\"", \""p_site_id\"" \""uuid\"", \""p_payment_method\"" \""text\"", \""p_payment_reference\"" \""text\"" DEFAULT NULL::\""text\"") RETURNS json\n    LANGUAGE \""plpgsql\"" SECURITY DEFINER\n    AS $_$\r\nDECLARE\r\n  v_order RECORD;\r\n  v_loyalty_points INT := 0;\r\n  v_result JSON;\r\nBEGIN\r\n  -- Obtener la orden\r\n  SELECT * INTO v_order FROM orders WHERE id = p_order_id;\r\n  \r\n  IF NOT FOUND THEN\r\n    RETURN json_build_object('success', false, 'error', 'Orden no encontrada');\r\n  END IF;\r\n  \r\n  -- Calcular puntos de lealtad (1 punto por cada $1000 COP)\r\n  v_loyalty_points := FLOOR(v_order.total_amount / 1000);\r\n  \r\n  -- Actualizar estado de la orden\r\n  UPDATE orders \r\n  SET \r\n    status = 'completed',\r\n    payment_status = 'paid',\r\n    loyalty_processed = true,\r\n    loyalty_points_awarded = v_loyalty_points,\r\n    updated_at = NOW()\r\n  WHERE id = p_order_id;\r\n  \r\n  -- Registrar el pago en pos_payments\r\n  INSERT INTO pos_payments (\r\n    order_id, \r\n    payment_method, \r\n    amount, \r\n    reference,\r\n    created_at\r\n  ) VALUES (\r\n    p_order_id,\r\n    p_payment_method,\r\n    v_order.total_amount,\r\n    p_payment_reference,\r\n    NOW()\r\n  );\r\n  \r\n  -- Si el cliente tiene ID, actualizar puntos de lealtad\r\n  IF v_order.client_id IS NOT NULL AND v_loyalty_points > 0 THEN\r\n    UPDATE users \r\n    SET loyalty_points = COALESCE(loyalty_points, 0) + v_loyalty_points\r\n    WHERE id = v_order.client_id;\r\n    \r\n    -- Registrar transacción de lealtad\r\n    INSERT INTO loyalty_transactions (\r\n      user_id,\r\n      order_id,\r\n      points,\r\n      type,\r\n      created_at\r\n    ) VALUES (\r\n      v_order.client_id,\r\n      p_order_id,\r\n      v_loyalty_points,\r\n      'earned',\r\n      NOW()\r\n    );\r\n  END IF;\r\n  \r\n  RETURN json_build_object(\r\n    'success', true,\r\n    'order_id', p_order_id,\r\n    'loyalty_points_awarded', v_loyalty_points\r\n  );\r\nEND;\r\n$_$"",""ALTER FUNCTION \""public\"".\""process_order_payment\""(\""p_order_id\"" \""uuid\"", \""p_site_id\"" \""uuid\"", \""p_payment_method\"" \""text\"", \""p_payment_reference\"" \""text\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""receive_purchase_order\""(\""p_purchase_order_id\"" \""uuid\"") RETURNS \""void\""\n    LANGUAGE \""plpgsql\""\n    AS $$\r\nDECLARE\r\n  v_po record;\r\n  v_item record;\r\n\r\n  v_purchase_unit_size numeric;\r\n  v_received_base_qty numeric;\r\n\r\n  v_prev_total_qty numeric;          -- stock TOTAL antes de recibir\r\n  v_existing_cost numeric;\r\n  v_received_unit_cost_base numeric;\r\n  v_new_cost numeric;\r\n\r\n  v_line_total numeric;\r\n  v_total_amount numeric := 0;\r\nBEGIN\r\n  -- Lock PO\r\n  SELECT *\r\n  INTO v_po\r\n  FROM public.purchase_orders\r\n  WHERE id = p_purchase_order_id\r\n  FOR UPDATE;\r\n\r\n  IF NOT FOUND THEN\r\n    RAISE EXCEPTION 'Purchase order % no existe', p_purchase_order_id;\r\n  END IF;\r\n\r\n  IF v_po.status IN ('received', 'completed') THEN\r\n    RAISE EXCEPTION 'Purchase order % ya está recibida (status=%)', p_purchase_order_id, v_po.status;\r\n  END IF;\r\n\r\n  -- Procesar items recibidos\r\n  FOR v_item IN\r\n    SELECT *\r\n    FROM public.purchase_order_items\r\n    WHERE purchase_order_id = p_purchase_order_id\r\n    ORDER BY created_at ASC\r\n  LOOP\r\n    IF v_item.quantity_received IS NULL OR v_item.quantity_received <= 0 THEN\r\n      CONTINUE;\r\n    END IF;\r\n\r\n    -- purchase_unit_size por proveedor+producto\r\n    SELECT ps.purchase_unit_size\r\n    INTO v_purchase_unit_size\r\n    FROM public.product_suppliers ps\r\n    WHERE ps.supplier_id = v_po.supplier_id\r\n      AND ps.product_id = v_item.product_id\r\n    LIMIT 1;\r\n\r\n    IF v_purchase_unit_size IS NULL OR v_purchase_unit_size <= 0 THEN\r\n      RAISE EXCEPTION\r\n        'Falta purchase_unit_size en product_suppliers para supplier_id=% product_id=% (PO=%)',\r\n        v_po.supplier_id, v_item.product_id, p_purchase_order_id;\r\n    END IF;\r\n\r\n    -- Convertir a unidad base\r\n    v_received_base_qty := v_item.quantity_received * v_purchase_unit_size;\r\n\r\n    -- 1) Capturar stock total PREVIO (antes de sumar lo recibido)\r\n    SELECT COALESCE(SUM(current_qty), 0)\r\n    INTO v_prev_total_qty\r\n    FROM public.inventory_stock_by_site\r\n    WHERE product_id = v_item.product_id;\r\n\r\n    -- 2) Costo actual (promedio anterior)\r\n    SELECT COALESCE(cost, 0)\r\n    INTO v_existing_cost\r\n    FROM public.products\r\n    WHERE id = v_item.product_id;\r\n\r\n    -- 3) Costo recibido en unidad base\r\n    v_received_unit_cost_base := v_item.unit_cost / v_purchase_unit_size;\r\n\r\n    -- 4) Nuevo costo promedio ponderado (usando stock previo real)\r\n    IF (v_prev_total_qty + v_received_base_qty) > 0 THEN\r\n      v_new_cost :=\r\n        (\r\n          (v_existing_cost * v_prev_total_qty) +\r\n          (v_received_unit_cost_base * v_received_base_qty)\r\n        )\r\n        / (v_prev_total_qty + v_received_base_qty);\r\n    ELSE\r\n      v_new_cost := v_received_unit_cost_base;\r\n    END IF;\r\n\r\n    -- Kardex\r\n    INSERT INTO public.inventory_movements (\r\n      site_id,\r\n      product_id,\r\n      movement_type,\r\n      quantity,\r\n      note,\r\n      related_purchase_order_id,\r\n      related_order_id\r\n    )\r\n    VALUES (\r\n      v_po.site_id,\r\n      v_item.product_id,\r\n      'purchase_in',\r\n      v_received_base_qty,\r\n      'Recepción OC ' || p_purchase_order_id::text,\r\n      p_purchase_order_id,\r\n      NULL\r\n    );\r\n\r\n    -- Stock por sede\r\n    INSERT INTO public.inventory_stock_by_site (site_id, product_id, current_qty, updated_at)\r\n    VALUES (v_po.site_id, v_item.product_id, v_received_base_qty, now())\r\n    ON CONFLICT (site_id, product_id)\r\n    DO UPDATE SET\r\n      current_qty = public.inventory_stock_by_site.current_qty + EXCLUDED.current_qty,\r\n      updated_at = now();\r\n\r\n    -- Actualizar costo del producto\r\n    UPDATE public.products\r\n    SET cost = v_new_cost,\r\n        updated_at = now()\r\n    WHERE id = v_item.product_id;\r\n\r\n    -- Totales PO\r\n    v_line_total := v_item.unit_cost * v_item.quantity_received;\r\n    v_total_amount := v_total_amount + COALESCE(v_line_total, 0);\r\n\r\n    UPDATE public.purchase_order_items\r\n    SET line_total = v_line_total\r\n    WHERE id = v_item.id;\r\n  END LOOP;\r\n\r\n  UPDATE public.purchase_orders\r\n  SET status = 'received',\r\n      received_at = now(),\r\n      total_amount = v_total_amount\r\n  WHERE id = p_purchase_order_id;\r\n\r\nEND;\r\n$$"",""ALTER FUNCTION \""public\"".\""receive_purchase_order\""(\""p_purchase_order_id\"" \""uuid\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""resolve_product_sku_brand_code\""(\""p_site_id\"" \""uuid\"") RETURNS \""text\""\n    LANGUAGE \""plpgsql\"" STABLE\n    AS $$\r\ndeclare\r\n  v_site_type text;\r\n  v_site_code text;\r\nbegin\r\n  select s.type, s.code\r\n    into v_site_type, v_site_code\r\n  from public.sites s\r\n  where s.id = p_site_id;\r\n\r\n  if v_site_type is not null then\r\n    case lower(v_site_type)\r\n      when 'vento_group' then return 'VGR';\r\n      when 'vento_cafe' then return 'VCF';\r\n      when 'saudo' then return 'SAU';\r\n      when 'vaila_vainilla' then return 'VAI';\r\n      when 'catering' then return 'CAT';\r\n    end case;\r\n  end if;\r\n\r\n  if v_site_code is null then\r\n    return null;\r\n  end if;\r\n\r\n  return upper(regexp_replace(v_site_code, '[^A-Za-z0-9]', '', 'g'));\r\nend;\r\n$$"",""ALTER FUNCTION \""public\"".\""resolve_product_sku_brand_code\""(\""p_site_id\"" \""uuid\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""resolve_product_sku_type_code\""(\""p_product_type\"" \""text\"") RETURNS \""text\""\n    LANGUAGE \""plpgsql\"" IMMUTABLE\n    AS $$\r\ndeclare\r\n  v_raw text;\r\n  v_clean text;\r\nbegin\r\n  v_raw := coalesce(p_product_type, '');\r\n  v_clean := lower(v_raw);\r\n\r\n  if v_clean like '%venta%' then\r\n    return 'VEN';\r\n  elsif v_clean like '%insum%' then\r\n    return 'INS';\r\n  elsif v_clean like '%prepar%' then\r\n    return 'PRE';\r\n  elsif v_clean like '%empa%' then\r\n    return 'EMP';\r\n  elsif v_clean like '%limp%' then\r\n    return 'LIM';\r\n  elsif v_clean like '%mant%' then\r\n    return 'MAN';\r\n  elsif v_clean like '%acti%' then\r\n    return 'ACT';\r\n  end if;\r\n\r\n  v_clean := regexp_replace(v_clean, '[^a-z0-9]', '', 'g');\r\n  if v_clean = '' then\r\n    return 'GEN';\r\n  end if;\r\n\r\n  return upper(substr(v_clean, 1, 3));\r\nend;\r\n$$"",""ALTER FUNCTION \""public\"".\""resolve_product_sku_type_code\""(\""p_product_type\"" \""text\"") OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""set_product_sku\""() RETURNS \""trigger\""\n    LANGUAGE \""plpgsql\"" SECURITY DEFINER\n    SET \""search_path\"" TO 'public'\n    AS $$\r\nbegin\r\n  if new.sku is null or btrim(new.sku) = '' then\r\n    new.sku := public.generate_product_sku(new.product_type, null);\r\n  end if;\r\n  return new;\r\nend;\r\n$$"",""ALTER FUNCTION \""public\"".\""set_product_sku\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""tg_set_updated_at\""() RETURNS \""trigger\""\n    LANGUAGE \""plpgsql\""\n    AS $$\r\nbegin\r\n  new.updated_at := now();\r\n  return new;\r\nend $$"",""ALTER FUNCTION \""public\"".\""tg_set_updated_at\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""update_employee_shifts_updated_at\""() RETURNS \""trigger\""\n    LANGUAGE \""plpgsql\""\n    AS $$\r\nBEGIN\r\n  NEW.updated_at = now();\r\n  RETURN NEW;\r\nEND;\r\n$$"",""ALTER FUNCTION \""public\"".\""update_employee_shifts_updated_at\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""update_loyalty_balance\""() RETURNS \""trigger\""\n    LANGUAGE \""plpgsql\"" SECURITY DEFINER\n    AS $$\r\nBEGIN\r\n  -- Si insertamos una transacción, sumamos/restamos al saldo del usuario\r\n  IF (TG_OP = 'INSERT') THEN\r\n    UPDATE public.users\r\n    SET loyalty_points = loyalty_points + NEW.points_delta,\r\n        updated_at = now()\r\n    WHERE id = NEW.user_id;\r\n  END IF;\r\n  RETURN NEW;\r\nEND;\r\n$$"",""ALTER FUNCTION \""public\"".\""update_loyalty_balance\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""update_updated_at\""() RETURNS \""trigger\""\n    LANGUAGE \""plpgsql\""\n    AS $$\r\nBEGIN\r\n  NEW.updated_at = NOW();\r\n  RETURN NEW;\r\nEND;\r\n$$"",""ALTER FUNCTION \""public\"".\""update_updated_at\""() OWNER TO \""postgres\"""",""CREATE OR REPLACE FUNCTION \""public\"".\""util_column_usage\""(\""p_table\"" \""regclass\"") RETURNS TABLE(\""column_name\"" \""text\"", \""non_null_count\"" bigint, \""total_count\"" bigint, \""pct_non_null\"" numeric)\n    LANGUAGE \""plpgsql\""\n    AS $$\r\ndeclare\r\n  col record;\r\n  total bigint;\r\nbegin\r\n  execute format('select count(*) from %s', p_table) into total;\r\n\r\n  for col in\r\n    select a.attname as column_name\r\n    from pg_attribute a\r\n    where a.attrelid = p_table\r\n      and a.attnum > 0\r\n      and not a.attisdropped\r\n  loop\r\n    return query execute format(\r\n      'select %L::text,\r\n              count(%I)::bigint,\r\n              %s::bigint,\r\n              round((count(%I)::numeric / nullif(%s,0))*100, 2)\r\n       from %s',\r\n      col.column_name,\r\n      col.column_name,\r\n      total,\r\n      col.column_name,\r\n      total,\r\n      p_table\r\n    );\r\n  end loop;\r\nend $$"",""ALTER FUNCTION \""public\"".\""util_column_usage\""(\""p_table\"" \""regclass\"") OWNER TO \""postgres\"""",""SET default_tablespace = ''"",""SET default_table_access_method = \""heap\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""_backup_inventory_movements_initial_count\"" (\n    \""id\"" \""uuid\"",\n    \""site_id\"" \""uuid\"",\n    \""product_id\"" \""uuid\"",\n    \""movement_type\"" \""text\"",\n    \""quantity\"" numeric,\n    \""note\"" \""text\"",\n    \""related_order_id\"" \""uuid\"",\n    \""related_production_request_id\"" \""uuid\"",\n    \""related_restock_request_id\"" \""uuid\"",\n    \""created_at\"" timestamp with time zone,\n    \""related_purchase_order_id\"" \""uuid\"",\n    \""unit_cost\"" numeric,\n    \""related_production_batch_id\"" \""uuid\""\n)"",""ALTER TABLE \""public\"".\""_backup_inventory_movements_initial_count\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""areas\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""code\"" \""text\"" NOT NULL,\n    \""name\"" \""text\"" NOT NULL,\n    \""kind\"" \""text\"" NOT NULL,\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""areas\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""areas\"" IS 'Core – tabla canónica para áreas dentro de un site. Usa para segmentar zonas de servicio/operación dentro de cada site.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""asistencia_logs\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""empleado_nombre\"" \""text\"",\n    \""empleado_id\"" \""text\"" NOT NULL,\n    \""fecha_hora\"" timestamp with time zone NOT NULL,\n    \""sucursal\"" \""text\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""asistencia_logs\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""attendance_logs\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""employee_id\"" \""uuid\"" NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""action\"" \""text\"" NOT NULL,\n    \""source\"" \""text\"" DEFAULT 'web'::\""text\"" NOT NULL,\n    \""occurred_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""latitude\"" numeric(10,7),\n    \""longitude\"" numeric(10,7),\n    \""accuracy_meters\"" numeric(6,1),\n    \""device_info\"" \""jsonb\"" DEFAULT '{}'::\""jsonb\"",\n    \""notes\"" \""text\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    CONSTRAINT \""attendance_logs_action_check\"" CHECK ((\""action\"" = ANY (ARRAY['check_in'::\""text\"", 'check_out'::\""text\""]))),\n    CONSTRAINT \""attendance_logs_source_check\"" CHECK ((\""source\"" = ANY (ARRAY['mobile'::\""text\"", 'web'::\""text\"", 'kiosk'::\""text\"", 'system'::\""text\""])))\n)"",""ALTER TABLE \""public\"".\""attendance_logs\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""attendance_logs\"" IS 'Registro de check-in/check-out de empleados (ANIMA)'"",""COMMENT ON COLUMN \""public\"".\""attendance_logs\"".\""action\"" IS 'Tipo de acción: check_in o check_out'"",""COMMENT ON COLUMN \""public\"".\""attendance_logs\"".\""source\"" IS 'Origen del registro: mobile, web, kiosk, system'"",""COMMENT ON COLUMN \""public\"".\""attendance_logs\"".\""accuracy_meters\"" IS 'Precisión del GPS en metros'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""cost_centers\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""site_id\"" \""uuid\"",\n    \""name\"" \""text\"" NOT NULL,\n    \""monthly_budget\"" numeric DEFAULT 0,\n    \""current_month_spend\"" numeric DEFAULT 0,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""(),\n    \""is_active\"" boolean DEFAULT true\n)"",""ALTER TABLE \""public\"".\""cost_centers\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""cost_centers\"" IS 'Core – tabla canónica para centros de costo. Organización financiera por site para asociar compras y presupuestos.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""employee_areas\"" (\n    \""employee_id\"" \""uuid\"" NOT NULL,\n    \""area_id\"" \""uuid\"" NOT NULL,\n    \""is_primary\"" boolean DEFAULT false NOT NULL,\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""employee_areas\"" OWNER TO \""postgres\"""",""CREATE OR REPLACE VIEW \""public\"".\""employee_attendance_status\"" AS\n SELECT DISTINCT ON (\""employee_id\"") \""employee_id\"",\n    \""action\"" AS \""current_status\"",\n    \""occurred_at\"" AS \""last_action_at\"",\n    \""site_id\"" AS \""last_site_id\""\n   FROM \""public\"".\""attendance_logs\""\n  ORDER BY \""employee_id\"", \""occurred_at\"" DESC"",""ALTER VIEW \""public\"".\""employee_attendance_status\"" OWNER TO \""postgres\"""",""COMMENT ON VIEW \""public\"".\""employee_attendance_status\"" IS 'Estado actual de asistencia por empleado (último check-in/out)'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""employee_settings\"" (\n    \""employee_id\"" \""uuid\"" NOT NULL,\n    \""selected_site_id\"" \""uuid\"",\n    \""selected_area_id\"" \""uuid\"",\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""employee_settings\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""employee_shifts\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""employee_id\"" \""uuid\"" NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""shift_date\"" \""date\"" NOT NULL,\n    \""start_time\"" time without time zone NOT NULL,\n    \""end_time\"" time without time zone NOT NULL,\n    \""break_minutes\"" integer DEFAULT 0,\n    \""notes\"" \""text\"",\n    \""status\"" \""text\"" DEFAULT 'scheduled'::\""text\"" NOT NULL,\n    \""created_by\"" \""uuid\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    CONSTRAINT \""employee_shifts_status_check\"" CHECK ((\""status\"" = ANY (ARRAY['scheduled'::\""text\"", 'confirmed'::\""text\"", 'completed'::\""text\"", 'cancelled'::\""text\"", 'no_show'::\""text\""])))\n)"",""ALTER TABLE \""public\"".\""employee_shifts\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""employee_shifts\"" IS 'Turnos programados de empleados - ANIMA'"",""COMMENT ON COLUMN \""public\"".\""employee_shifts\"".\""shift_date\"" IS 'Fecha del turno'"",""COMMENT ON COLUMN \""public\"".\""employee_shifts\"".\""start_time\"" IS 'Hora de inicio programada'"",""COMMENT ON COLUMN \""public\"".\""employee_shifts\"".\""end_time\"" IS 'Hora de fin programada'"",""COMMENT ON COLUMN \""public\"".\""employee_shifts\"".\""break_minutes\"" IS 'Minutos de descanso dentro del turno'"",""COMMENT ON COLUMN \""public\"".\""employee_shifts\"".\""status\"" IS 'scheduled=programado, confirmed=confirmado, completed=completado, cancelled=cancelado, no_show=no se presentó'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""employee_sites\"" (\n    \""employee_id\"" \""uuid\"" NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""is_primary\"" boolean DEFAULT false NOT NULL,\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""employee_sites\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""employees\"" (\n    \""id\"" \""uuid\"" NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""role\"" \""text\"" NOT NULL,\n    \""permissions\"" \""jsonb\"" DEFAULT '{}'::\""jsonb\"",\n    \""full_name\"" \""text\"" NOT NULL,\n    \""alias\"" \""text\"",\n    \""pin_code\"" \""text\"",\n    \""is_active\"" boolean DEFAULT true,\n    \""joined_at\"" timestamp with time zone DEFAULT \""now\""(),\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""(),\n    \""area_id\"" \""uuid\"",\n    CONSTRAINT \""employees_role_check\"" CHECK ((\""role\"" = ANY (ARRAY['owner'::\""text\"", 'manager'::\""text\"", 'staff'::\""text\"", 'cashier'::\""text\"", 'waiter'::\""text\"", 'barista'::\""text\"", 'cook'::\""text\"", 'chef'::\""text\"", 'baker'::\""text\"", 'pastry'::\""text\"", 'warehouse'::\""text\"", 'logistics'::\""text\""])))\n)"",""ALTER TABLE \""public\"".\""employees\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""employees\"" IS 'Core – tabla canónica para empleados/staff. Gestión de personal por site, roles y permisos operativos.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""inventory_locations\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""code\"" \""text\"" NOT NULL,\n    \""zone\"" \""text\"" NOT NULL,\n    \""aisle\"" \""text\"",\n    \""level\"" \""text\"",\n    \""description\"" \""text\"",\n    \""is_active\"" boolean DEFAULT true,\n    \""capacity_units\"" numeric(10,2),\n    \""location_type\"" \""text\"" DEFAULT 'storage'::\""text\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""(),\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""(),\n    CONSTRAINT \""inventory_locations_location_type_check\"" CHECK ((\""location_type\"" = ANY (ARRAY['storage'::\""text\"", 'picking'::\""text\"", 'receiving'::\""text\"", 'staging'::\""text\"", 'production'::\""text\""])))\n)"",""ALTER TABLE \""public\"".\""inventory_locations\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""inventory_locations\"" IS 'Ubicaciones físicas en almacén (LOC)'"",""COMMENT ON COLUMN \""public\"".\""inventory_locations\"".\""code\"" IS 'Código único LOC-{SEDE}-{ZONA}-{PASILLO}-{NIVEL}'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""inventory_lpn_items\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""lpn_id\"" \""uuid\"" NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""quantity\"" numeric(10,2) DEFAULT 0 NOT NULL,\n    \""unit\"" \""text\"" DEFAULT 'unidad'::\""text\"" NOT NULL,\n    \""lot_number\"" \""text\"",\n    \""expiry_date\"" \""date\"",\n    \""received_at\"" timestamp with time zone DEFAULT \""now\""(),\n    \""cost_per_unit\"" numeric(12,2),\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""(),\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""()\n)"",""ALTER TABLE \""public\"".\""inventory_lpn_items\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""inventory_lpn_items\"" IS 'Contenido de cada LPN con lote y vencimiento'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""inventory_lpns\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""code\"" \""text\"" NOT NULL,\n    \""location_id\"" \""uuid\"",\n    \""status\"" \""text\"" DEFAULT 'active'::\""text\"",\n    \""container_type\"" \""text\"" DEFAULT 'box'::\""text\"",\n    \""notes\"" \""text\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""(),\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""(),\n    \""created_by\"" \""uuid\"",\n    \""label\"" \""text\"",\n    CONSTRAINT \""inventory_lpns_container_type_check\"" CHECK ((\""container_type\"" = ANY (ARRAY['box'::\""text\"", 'pallet'::\""text\"", 'bag'::\""text\"", 'tray'::\""text\"", 'bin'::\""text\"", 'other'::\""text\""]))),\n    CONSTRAINT \""inventory_lpns_status_check\"" CHECK ((\""status\"" = ANY (ARRAY['active'::\""text\"", 'empty'::\""text\"", 'consumed'::\""text\"", 'damaged'::\""text\""])))\n)"",""ALTER TABLE \""public\"".\""inventory_lpns\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""inventory_lpns\"" IS 'License Plate Numbers - Contenedores/Cajas identificables'"",""COMMENT ON COLUMN \""public\"".\""inventory_lpns\"".\""code\"" IS 'Código único LPN-{SEDE}-{AAMM}-{SEQ}'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""inventory_movement_types\"" (\n    \""code\"" \""text\"" NOT NULL,\n    \""name\"" \""text\"" NOT NULL,\n    \""description\"" \""text\"",\n    \""affects_stock\"" smallint NOT NULL,\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    CONSTRAINT \""inventory_movement_types_affects_stock_check\"" CHECK ((\""affects_stock\"" = ANY (ARRAY['-1'::integer, 0, 1])))\n)"",""ALTER TABLE \""public\"".\""inventory_movement_types\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""inventory_movements\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""movement_type\"" \""text\"" NOT NULL,\n    \""quantity\"" numeric NOT NULL,\n    \""note\"" \""text\"",\n    \""related_order_id\"" \""uuid\"",\n    \""related_production_request_id\"" \""uuid\"",\n    \""related_restock_request_id\"" \""uuid\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""related_purchase_order_id\"" \""uuid\"",\n    \""unit_cost\"" numeric,\n    \""related_production_batch_id\"" \""uuid\""\n)"",""ALTER TABLE \""public\"".\""inventory_movements\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""inventory_movements\"" IS 'Core – tabla canónica para movimientos de inventario. Registra entradas/salidas y relaciones con orders/production/restock para auditoría y conciliación.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""products\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""name\"" \""text\"" NOT NULL,\n    \""description\"" \""text\"",\n    \""sku\"" \""text\"",\n    \""price\"" numeric,\n    \""cost\"" numeric,\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""product_type\"" \""text\"" DEFAULT 'venta'::\""text\"" NOT NULL,\n    \""category_id\"" \""uuid\"" NOT NULL,\n    \""unit\"" \""text\"" NOT NULL,\n    \""cost_original\"" numeric,\n    CONSTRAINT \""products_product_type_check\"" CHECK ((\""product_type\"" = ANY (ARRAY['venta'::\""text\"", 'insumo'::\""text\"", 'preparacion'::\""text\""])))\n)"",""ALTER TABLE \""public\"".\""products\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""products\"" IS 'Core – tabla canónica para catálogo maestro de productos y preparaciones. Catálogo maestro de productos de venta, insumos y preparaciones; usar en todo el código nuevo.'"",""COMMENT ON COLUMN \""public\"".\""products\"".\""unit\"" IS 'Unidad base del producto/insumo (ej: \""g\"", \""kg\"", \""ml\"", \""L\"", \""unidades\""). \r\nMigrado desde inventory.unit (legacy).'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""sites\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""code\"" \""text\"" NOT NULL,\n    \""name\"" \""text\"" NOT NULL,\n    \""type\"" \""text\"" NOT NULL,\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""latitude\"" numeric(10,8),\n    \""longitude\"" numeric(11,8),\n    \""address\"" \""text\"",\n    \""site_type\"" \""public\"".\""site_type\"" DEFAULT 'satellite'::\""public\"".\""site_type\"" NOT NULL,\n    \""site_kind\"" \""text\"" NOT NULL,\n    \""checkin_radius_meters\"" integer DEFAULT 50,\n    \""is_public\"" boolean DEFAULT false NOT NULL\n)"",""ALTER TABLE \""public\"".\""sites\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""sites\"" IS 'Core – tabla canónica para ubicaciones (sites). Define locales/almacenes donde hay stock, movimientos y operaciones.'"",""COMMENT ON COLUMN \""public\"".\""sites\"".\""latitude\"" IS 'Latitud de la sede para LiveMap'"",""COMMENT ON COLUMN \""public\"".\""sites\"".\""longitude\"" IS 'Longitud de la sede para LiveMap'"",""COMMENT ON COLUMN \""public\"".\""sites\"".\""address\"" IS 'Dirección física de la sede'"",""COMMENT ON COLUMN \""public\"".\""sites\"".\""checkin_radius_meters\"" IS 'Radio en metros para validar check-in GPS (default 50m)'"",""CREATE OR REPLACE VIEW \""public\"".\""inventory_stock_by_location\"" AS\n SELECT \""loc\"".\""id\"" AS \""location_id\"",\n    \""loc\"".\""code\"" AS \""location_code\"",\n    \""loc\"".\""zone\"",\n    \""loc\"".\""site_id\"",\n    \""s\"".\""name\"" AS \""site_name\"",\n    \""p\"".\""id\"" AS \""product_id\"",\n    \""p\"".\""name\"" AS \""product_name\"",\n    \""p\"".\""sku\"",\n    \""sum\""(\""li\"".\""quantity\"") AS \""total_quantity\"",\n    \""li\"".\""unit\"",\n    \""min\""(\""li\"".\""expiry_date\"") AS \""nearest_expiry\""\n   FROM ((((\""public\"".\""inventory_locations\"" \""loc\""\n     JOIN \""public\"".\""sites\"" \""s\"" ON ((\""loc\"".\""site_id\"" = \""s\"".\""id\"")))\n     LEFT JOIN \""public\"".\""inventory_lpns\"" \""lpn\"" ON (((\""lpn\"".\""location_id\"" = \""loc\"".\""id\"") AND (\""lpn\"".\""status\"" = 'active'::\""text\""))))\n     LEFT JOIN \""public\"".\""inventory_lpn_items\"" \""li\"" ON ((\""li\"".\""lpn_id\"" = \""lpn\"".\""id\"")))\n     LEFT JOIN \""public\"".\""products\"" \""p\"" ON ((\""li\"".\""product_id\"" = \""p\"".\""id\"")))\n  WHERE (\""loc\"".\""is_active\"" = true)\n  GROUP BY \""loc\"".\""id\"", \""loc\"".\""code\"", \""loc\"".\""zone\"", \""loc\"".\""site_id\"", \""s\"".\""name\"", \""p\"".\""id\"", \""p\"".\""name\"", \""p\"".\""sku\"", \""li\"".\""unit\"""",""ALTER VIEW \""public\"".\""inventory_stock_by_location\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""inventory_stock_by_site\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""current_qty\"" numeric DEFAULT '0'::numeric NOT NULL,\n    \""min_qty\"" numeric DEFAULT '0'::numeric NOT NULL,\n    \""max_qty\"" numeric DEFAULT '0'::numeric NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""avg_unit_cost\"" numeric\n)"",""ALTER TABLE \""public\"".\""inventory_stock_by_site\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""inventory_stock_by_site\"" IS 'Core – tabla canónica para stock por sitio. Registra cantidades actuales y umbrales por site+product; usar para consultas de disponibilidad y reabastecimiento.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""loyalty_redemptions\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""user_id\"" \""uuid\"" NOT NULL,\n    \""order_id\"" \""uuid\"",\n    \""reward_id\"" \""uuid\"" NOT NULL,\n    \""points_spent\"" integer NOT NULL,\n    \""qr_code\"" \""text\"",\n    \""status\"" \""text\"" DEFAULT 'pending'::\""text\"" NOT NULL,\n    \""metadata\"" \""jsonb\"" DEFAULT '{}'::\""jsonb\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""validated_at\"" timestamp with time zone,\n    CONSTRAINT \""loyalty_redemptions_points_spent_check\"" CHECK ((\""points_spent\"" > 0)),\n    CONSTRAINT \""loyalty_redemptions_status_check\"" CHECK ((\""status\"" = ANY (ARRAY['pending'::\""text\"", 'validated'::\""text\"", 'cancelled'::\""text\""])))\n)"",""ALTER TABLE \""public\"".\""loyalty_redemptions\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""loyalty_redemptions\"" IS 'Core – tabla canónica para redenciones de lealtad. Registro de canjes/validaciones y estado asociado a orders y usuarios.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""loyalty_rewards\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""code\"" \""text\"" NOT NULL,\n    \""name\"" \""text\"" NOT NULL,\n    \""description\"" \""text\"",\n    \""points_cost\"" integer NOT NULL,\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""metadata\"" \""jsonb\"" DEFAULT '{}'::\""jsonb\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""site_id\"" \""uuid\"",\n    CONSTRAINT \""loyalty_rewards_points_cost_check\"" CHECK ((\""points_cost\"" > 0))\n)"",""ALTER TABLE \""public\"".\""loyalty_rewards\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""loyalty_rewards\"" IS 'Core – tabla canónica para recompensas de lealtad. Catálogo de recompensas canónicas que los usuarios pueden canjear.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""loyalty_transactions\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""user_id\"" \""uuid\"" NOT NULL,\n    \""order_id\"" \""uuid\"",\n    \""kind\"" \""text\"" NOT NULL,\n    \""points_delta\"" integer NOT NULL,\n    \""description\"" \""text\"",\n    \""metadata\"" \""jsonb\"" DEFAULT '{}'::\""jsonb\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    CONSTRAINT \""loyalty_transactions_kind_check\"" CHECK ((\""kind\"" = ANY (ARRAY['earn'::\""text\"", 'spend'::\""text\"", 'adjust'::\""text\""]))),\n    CONSTRAINT \""loyalty_transactions_points_delta_check\"" CHECK ((\""points_delta\"" <> 0))\n)"",""ALTER TABLE \""public\"".\""loyalty_transactions\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""loyalty_transactions\"" IS 'Core – tabla canónica para transacciones de lealtad. Registro de puntos ganados/gastados por user y relación con orders.'"",""CREATE SEQUENCE IF NOT EXISTS \""public\"".\""lpn_sequence\""\n    START WITH 1\n    INCREMENT BY 1\n    NO MINVALUE\n    NO MAXVALUE\n    CACHE 1"",""ALTER SEQUENCE \""public\"".\""lpn_sequence\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""order_items\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""order_id\"" \""uuid\"" NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""quantity\"" numeric DEFAULT '1'::numeric NOT NULL,\n    \""unit_price\"" numeric DEFAULT '0'::numeric NOT NULL,\n    \""total_amount\"" numeric DEFAULT '0'::numeric NOT NULL,\n    \""notes\"" \""text\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""seat_number\"" integer,\n    \""course\"" \""text\"" DEFAULT 'main'::\""text\"",\n    \""status\"" \""text\"" DEFAULT 'pending'::\""text\"",\n    \""sent_at\"" timestamp with time zone,\n    \""allergy_alert\"" \""text\"",\n    \""is_comped\"" boolean DEFAULT false,\n    \""comp_reason\"" \""text\""\n)"",""ALTER TABLE \""public\"".\""order_items\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""order_items\"" IS 'Core – tabla canónica para líneas de pedido. Detalle de productos, cantidades y precios asociados a cada order.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""orders\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""client_id\"" \""uuid\"",\n    \""order_type\"" \""text\"" DEFAULT 'dine_in'::\""text\"" NOT NULL,\n    \""source\"" \""text\"" DEFAULT 'vento_os'::\""text\"" NOT NULL,\n    \""table_number\"" \""text\"",\n    \""status\"" \""text\"" DEFAULT 'pending'::\""text\"" NOT NULL,\n    \""payment_status\"" \""text\"" DEFAULT 'unpaid'::\""text\"" NOT NULL,\n    \""total_amount\"" numeric DEFAULT '0'::numeric NOT NULL,\n    \""notes\"" \""text\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""inventory_processed\"" boolean DEFAULT false NOT NULL,\n    \""loyalty_processed\"" boolean DEFAULT false NOT NULL,\n    \""loyalty_points_awarded\"" integer DEFAULT 0 NOT NULL,\n    \""guest_info\"" \""jsonb\"" DEFAULT '{}'::\""jsonb\"",\n    \""site_id\"" \""uuid\"",\n    \""session_id\"" \""uuid\"",\n    \""server_id\"" \""uuid\"",\n    \""split_type\"" \""text\"",\n    \""discount_amount\"" numeric DEFAULT 0,\n    \""discount_reason\"" \""text\"",\n    \""voided_at\"" timestamp with time zone,\n    \""voided_by\"" \""uuid\"",\n    \""void_reason\"" \""text\""\n)"",""ALTER TABLE \""public\"".\""orders\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""orders\"" IS 'Core – tabla canónica para pedidos de clientes. Registro maestro de órdenes de venta/consumo (dine-in/takeaway) y su estado en el sistema.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""pos_cash_movements\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""shift_id\"" \""uuid\"" NOT NULL,\n    \""type\"" \""text\"" NOT NULL,\n    \""amount\"" numeric NOT NULL,\n    \""payment_method\"" \""text\"",\n    \""reference\"" \""text\"",\n    \""description\"" \""text\"",\n    \""order_id\"" \""uuid\"",\n    \""created_by\"" \""uuid\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""pos_cash_movements\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""pos_cash_shifts\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""employee_id\"" \""uuid\"" NOT NULL,\n    \""status\"" \""text\"" DEFAULT 'open'::\""text\"" NOT NULL,\n    \""opened_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""closed_at\"" timestamp with time zone,\n    \""opening_amount\"" numeric DEFAULT 0 NOT NULL,\n    \""expected_amount\"" numeric,\n    \""counted_amount\"" numeric,\n    \""difference\"" numeric,\n    \""notes\"" \""text\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""pos_cash_shifts\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""pos_modifier_options\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""modifier_id\"" \""uuid\"" NOT NULL,\n    \""name\"" \""text\"" NOT NULL,\n    \""price_adjustment\"" numeric DEFAULT 0,\n    \""display_order\"" integer DEFAULT 0,\n    \""is_default\"" boolean DEFAULT false,\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""pos_modifier_options\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""pos_modifiers\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""site_id\"" \""uuid\"",\n    \""name\"" \""text\"" NOT NULL,\n    \""type\"" \""text\"" DEFAULT 'single'::\""text\"" NOT NULL,\n    \""is_required\"" boolean DEFAULT false,\n    \""min_selections\"" integer DEFAULT 0,\n    \""max_selections\"" integer DEFAULT 1,\n    \""display_order\"" integer DEFAULT 0,\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""pos_modifiers\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""pos_order_item_modifiers\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""order_item_id\"" \""uuid\"" NOT NULL,\n    \""modifier_id\"" \""uuid\"" NOT NULL,\n    \""modifier_option_id\"" \""uuid\"",\n    \""price_adjustment\"" numeric DEFAULT 0,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""pos_order_item_modifiers\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""pos_payments\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""order_id\"" \""uuid\"" NOT NULL,\n    \""session_id\"" \""uuid\"",\n    \""shift_id\"" \""uuid\"",\n    \""payment_method\"" \""text\"" NOT NULL,\n    \""amount\"" numeric NOT NULL,\n    \""tip_amount\"" numeric DEFAULT 0,\n    \""reference\"" \""text\"",\n    \""status\"" \""text\"" DEFAULT 'completed'::\""text\"" NOT NULL,\n    \""processed_by\"" \""uuid\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""pos_payments\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""pos_product_modifiers\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""modifier_id\"" \""uuid\"" NOT NULL,\n    \""display_order\"" integer DEFAULT 0,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""pos_product_modifiers\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""pos_session_orders\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""session_id\"" \""uuid\"" NOT NULL,\n    \""order_id\"" \""uuid\"" NOT NULL,\n    \""seat_number\"" integer,\n    \""course\"" \""text\"" DEFAULT 'main'::\""text\"",\n    \""course_status\"" \""text\"" DEFAULT 'pending'::\""text\"",\n    \""fired_at\"" timestamp with time zone,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""pos_session_orders\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""pos_sessions\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""table_id\"" \""uuid\"" NOT NULL,\n    \""server_id\"" \""uuid\"",\n    \""status\"" \""text\"" DEFAULT 'open'::\""text\"" NOT NULL,\n    \""pax\"" integer DEFAULT 1,\n    \""opened_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""closed_at\"" timestamp with time zone,\n    \""notes\"" \""text\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""pos_sessions\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""pos_tables\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""zone_id\"" \""uuid\"",\n    \""name\"" \""text\"" NOT NULL,\n    \""table_number\"" integer,\n    \""shape\"" \""text\"" DEFAULT 'square'::\""text\"" NOT NULL,\n    \""capacity\"" integer DEFAULT 4 NOT NULL,\n    \""position_x\"" numeric DEFAULT 0 NOT NULL,\n    \""position_y\"" numeric DEFAULT 0 NOT NULL,\n    \""rotation\"" numeric DEFAULT 0,\n    \""width\"" numeric DEFAULT 80,\n    \""height\"" numeric DEFAULT 80,\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""pos_tables\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""pos_zones\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""name\"" \""text\"" NOT NULL,\n    \""color\"" \""text\"" DEFAULT '#00d4ff'::\""text\"",\n    \""display_order\"" integer DEFAULT 0,\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""pos_zones\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""procurement_agreed_prices\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""supplier_id\"" \""uuid\"" NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""agreed_price\"" numeric NOT NULL,\n    \""currency\"" \""text\"" DEFAULT 'COP'::\""text\"",\n    \""valid_from\"" timestamp with time zone DEFAULT \""now\""(),\n    \""valid_until\"" timestamp with time zone,\n    \""is_active\"" boolean DEFAULT true\n)"",""ALTER TABLE \""public\"".\""procurement_agreed_prices\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""procurement_agreed_prices\"" IS 'Core – tabla canónica para precios acordados con proveedores. Almacena tarifas vigentes por supplier+product para negociar/planificar compras.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""procurement_reception_items\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""reception_id\"" \""uuid\"" NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""quantity_declared\"" numeric NOT NULL,\n    \""quantity_received\"" numeric NOT NULL,\n    \""discrepancy\"" numeric GENERATED ALWAYS AS ((\""quantity_received\"" - \""quantity_declared\"")) STORED\n)"",""ALTER TABLE \""public\"".\""procurement_reception_items\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""procurement_reception_items\"" IS 'Core – tabla canónica para ítems de recepción de compra. Detalle de cantidades recibidas y discrepancias por recepción.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""procurement_receptions\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""purchase_order_id\"" \""uuid\"" NOT NULL,\n    \""received_by\"" \""uuid\"" NOT NULL,\n    \""received_at\"" timestamp with time zone DEFAULT \""now\""(),\n    \""site_id\"" \""uuid\"",\n    \""evidence_photo_url\"" \""text\"" NOT NULL,\n    \""weight_source\"" \""text\"" DEFAULT 'MANUAL'::\""text\"",\n    \""notes\"" \""text\"",\n    \""geolocation\"" \""jsonb\""\n)"",""ALTER TABLE \""public\"".\""procurement_receptions\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""procurement_receptions\"" IS 'Core – tabla canónica para recepciones de compras. Registra el acto de recepción físico/fecha/evidencia por purchase_order.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""product_categories\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""name\"" \""text\"" NOT NULL,\n    \""slug\"" \""text\"",\n    \""description\"" \""text\"",\n    \""display_order\"" integer,\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""domain\"" \""text\"",\n    \""parent_id\"" \""uuid\"",\n    \""updated_at\"" timestamp with time zone,\n    \""site_id\"" \""uuid\""\n)"",""ALTER TABLE \""public\"".\""product_categories\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""product_categories\"" IS 'Core – tabla canónica para categorías de productos. Clasificación canónica usada por products (referenciar por category_id) en nuevas implementaciones.'"",""COMMENT ON COLUMN \""public\"".\""product_categories\"".\""site_id\"" IS 'Sede específica de la categoría. NULL = categoría global compartida entre todas las sedes'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""product_inventory_profiles\"" (\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""track_inventory\"" boolean DEFAULT true NOT NULL,\n    \""inventory_kind\"" \""text\"" DEFAULT 'unclassified'::\""text\"" NOT NULL,\n    \""default_unit\"" \""text\"",\n    \""lot_tracking\"" boolean DEFAULT false NOT NULL,\n    \""expiry_tracking\"" boolean DEFAULT false NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    CONSTRAINT \""product_inventory_profiles_kind_chk\"" CHECK ((\""inventory_kind\"" = ANY (ARRAY['ingredient'::\""text\"", 'finished'::\""text\"", 'resale'::\""text\"", 'packaging'::\""text\"", 'asset'::\""text\"", 'unclassified'::\""text\""])))\n)"",""ALTER TABLE \""public\"".\""product_inventory_profiles\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""product_sku_aliases\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""sku\"" \""text\"" NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""product_sku_aliases\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""product_sku_sequences\"" (\n    \""brand_code\"" \""text\"" NOT NULL,\n    \""type_code\"" \""text\"" NOT NULL,\n    \""last_value\"" integer DEFAULT 0 NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""product_sku_sequences\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""product_suppliers\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""supplier_id\"" \""uuid\"" NOT NULL,\n    \""supplier_sku\"" \""text\"",\n    \""purchase_unit\"" \""text\"",\n    \""purchase_unit_size\"" numeric,\n    \""purchase_price\"" numeric,\n    \""currency\"" \""text\"" DEFAULT 'COP'::\""text\"" NOT NULL,\n    \""lead_time_days\"" integer,\n    \""min_order_qty\"" numeric,\n    \""is_primary\"" boolean DEFAULT false NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""product_suppliers\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""product_suppliers\"" IS 'Core – tabla canónica para relación producto↔proveedor. Define proveedores asociados a productos, SKUs proveedor y condiciones de compra.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""production_batches\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""recipe_card_id\"" \""uuid\"",\n    \""produced_qty\"" numeric NOT NULL,\n    \""produced_unit\"" \""text\"" NOT NULL,\n    \""total_cost\"" numeric,\n    \""unit_cost\"" numeric,\n    \""status\"" \""text\"" DEFAULT 'posted'::\""text\"" NOT NULL,\n    \""notes\"" \""text\"",\n    \""created_by\"" \""uuid\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""production_batches\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""production_request_items\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""request_id\"" \""uuid\"" NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""recipe_id\"" \""uuid\"",\n    \""quantity\"" numeric DEFAULT '0'::numeric,\n    \""unit\"" \""text\"",\n    \""requested_quantity\"" numeric DEFAULT '0'::numeric NOT NULL,\n    \""produced_quantity\"" numeric DEFAULT '0'::numeric NOT NULL,\n    \""loaded_quantity\"" numeric DEFAULT '0'::numeric NOT NULL,\n    \""received_quantity\"" numeric DEFAULT '0'::numeric NOT NULL,\n    \""stage_status\"" \""text\"" DEFAULT '''pending'''::\""text\"" NOT NULL\n)"",""ALTER TABLE \""public\"".\""production_request_items\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""production_request_items\"" IS 'Core – tabla canónica para ítems de producción. Detalle de productos/recetas y cantidades asociadas a cada producción.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""production_requests\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""created_by\"" \""uuid\"",\n    \""from_location\"" \""text\"" NOT NULL,\n    \""to_location\"" \""text\"" NOT NULL,\n    \""status\"" \""text\"" DEFAULT '''pending'''::\""text\"" NOT NULL,\n    \""needed_for_date\"" \""date\"",\n    \""notes\"" \""text\"",\n    \""from_site_id\"" \""uuid\"",\n    \""to_site_id\"" \""uuid\""\n)"",""ALTER TABLE \""public\"".\""production_requests\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""production_requests\"" IS 'Core – tabla canónica para solicitudes de producción. Coordina producción interna desde inventario/recetas entre sitios.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""purchase_order_items\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""purchase_order_id\"" \""uuid\"" NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""quantity_ordered\"" numeric NOT NULL,\n    \""quantity_received\"" numeric,\n    \""unit_cost\"" numeric NOT NULL,\n    \""line_total\"" numeric,\n    \""unit\"" \""text\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""purchase_order_items\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""purchase_order_items\"" IS 'Core – tabla canónica para líneas de órdenes de compra. Detalle de productos, cantidades y costos por purchase_order.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""purchase_orders\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""supplier_id\"" \""uuid\"" NOT NULL,\n    \""site_id\"" \""uuid\"" NOT NULL,\n    \""status\"" \""text\"" DEFAULT 'draft'::\""text\"" NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""expected_at\"" timestamp with time zone,\n    \""received_at\"" timestamp with time zone,\n    \""total_amount\"" numeric,\n    \""currency\"" \""text\"" DEFAULT 'COP'::\""text\"" NOT NULL,\n    \""notes\"" \""text\"",\n    \""cost_center_id\"" \""uuid\"",\n    \""approved_by\"" \""uuid\"",\n    \""approval_date\"" timestamp with time zone,\n    \""created_by\"" \""uuid\"" DEFAULT \""auth\"".\""uid\""()\n)"",""ALTER TABLE \""public\"".\""purchase_orders\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""purchase_orders\"" IS 'Core – tabla canónica para órdenes de compra a proveedores. Registra pedidos, estado y metadatos para recepción y pagos.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""recipe_cards\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""yield_qty\"" numeric DEFAULT 1 NOT NULL,\n    \""yield_unit\"" \""text\"" NOT NULL,\n    \""portion_size\"" numeric,\n    \""portion_unit\"" \""text\"",\n    \""prep_time_minutes\"" integer,\n    \""shelf_life_days\"" integer,\n    \""area\"" \""text\"",\n    \""difficulty\"" \""text\"",\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""site_id\"" \""uuid\"",\n    \""area_id\"" \""uuid\"",\n    \""recipe_description\"" \""text\"",\n    \""cover_image_path\"" \""text\"",\n    \""video_path\"" \""text\"",\n    \""status\"" \""public\"".\""recipe_status\"" DEFAULT 'draft'::\""public\"".\""recipe_status\"" NOT NULL,\n    CONSTRAINT \""recipe_cards_yield_qty_positive\"" CHECK ((\""yield_qty\"" > (0)::numeric))\n)"",""ALTER TABLE \""public\"".\""recipe_cards\"" OWNER TO \""postgres\"""",""COMMENT ON COLUMN \""public\"".\""recipe_cards\"".\""status\"" IS 'Recipe workflow status: draft (work in progress), published (visible to staff), archived (hidden)'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""recipe_steps\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""recipe_card_id\"" \""uuid\"" NOT NULL,\n    \""step_number\"" integer NOT NULL,\n    \""description\"" \""text\"" NOT NULL,\n    \""tip\"" \""text\"",\n    \""time_minutes\"" integer,\n    \""image_path\"" \""text\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    CONSTRAINT \""recipe_steps_step_number_positive\"" CHECK ((\""step_number\"" > 0)),\n    CONSTRAINT \""recipe_steps_time_minutes_positive\"" CHECK (((\""time_minutes\"" IS NULL) OR (\""time_minutes\"" >= 0)))\n)"",""ALTER TABLE \""public\"".\""recipe_steps\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""recipes\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""quantity\"" numeric DEFAULT '0'::numeric NOT NULL,\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""ingredient_product_id\"" \""uuid\""\n)"",""ALTER TABLE \""public\"".\""recipes\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""recipes\"" IS 'Core – tabla canónica para recetas/consumos. Define relaciones producto→insumo (inventory) y cantidades necesarias para producción.'"",""COMMENT ON COLUMN \""public\"".\""recipes\"".\""product_id\"" IS 'ID del producto final (pizza, bebida, preparación terminada).'"",""COMMENT ON COLUMN \""public\"".\""recipes\"".\""ingredient_product_id\"" IS 'Producto usado como ingrediente (FK a products.id). \r\nEl producto debe tener product_type = ''insumo''. \r\nEste es el campo canónico que reemplaza a inventory_id (legacy).'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""restock_request_items\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""request_id\"" \""uuid\"" NOT NULL,\n    \""product_id\"" \""uuid\"" NOT NULL,\n    \""quantity\"" numeric DEFAULT '0'::numeric NOT NULL,\n    \""unit\"" \""text\"",\n    \""transfer_unit_price\"" numeric,\n    \""transfer_currency\"" \""text\"",\n    \""transfer_total\"" numeric\n)"",""ALTER TABLE \""public\"".\""restock_request_items\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""restock_request_items\"" IS 'Core – tabla canónica para ítems de reabastecimiento. Detalle de productos y cantidades solicitadas en cada restock_request.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""restock_requests\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""created_by\"" \""uuid\"",\n    \""from_location\"" \""text\"" NOT NULL,\n    \""to_location\"" \""text\"" NOT NULL,\n    \""status\"" \""text\"" DEFAULT '''pending'''::\""text\"" NOT NULL,\n    \""expected_date\"" \""date\"",\n    \""notes\"" \""text\"",\n    \""from_site_id\"" \""uuid\"",\n    \""to_site_id\"" \""uuid\"",\n    \""pricing_mode\"" \""text\"" DEFAULT 'none'::\""text\"" NOT NULL,\n    \""pricing_status\"" \""text\"" DEFAULT 'draft'::\""text\"" NOT NULL,\n    \""internal_supplier_site_id\"" \""uuid\""\n)"",""ALTER TABLE \""public\"".\""restock_requests\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""restock_requests\"" IS 'Core – tabla canónica para solicitudes de reabastecimiento. Gestiona pedidos internos de re-stock entre ubicaciones o hacia proveedores.'"",""CREATE OR REPLACE VIEW \""public\"".\""shift_calendar_view\"" AS\n SELECT \""s\"".\""id\"",\n    \""s\"".\""employee_id\"",\n    \""e\"".\""full_name\"" AS \""employee_name\"",\n    \""e\"".\""alias\"" AS \""employee_alias\"",\n    \""s\"".\""site_id\"",\n    \""si\"".\""name\"" AS \""site_name\"",\n    \""s\"".\""shift_date\"",\n    \""s\"".\""start_time\"",\n    \""s\"".\""end_time\"",\n    \""s\"".\""break_minutes\"",\n    \""s\"".\""notes\"",\n    \""s\"".\""status\"",\n    ((EXTRACT(epoch FROM (\""s\"".\""end_time\"" - \""s\"".\""start_time\"")) / (3600)::numeric) - ((\""s\"".\""break_minutes\"")::numeric / 60.0)) AS \""scheduled_hours\"",\n    ( SELECT \""al\"".\""occurred_at\""\n           FROM \""public\"".\""attendance_logs\"" \""al\""\n          WHERE ((\""al\"".\""employee_id\"" = \""s\"".\""employee_id\"") AND (\""al\"".\""site_id\"" = \""s\"".\""site_id\"") AND (\""al\"".\""action\"" = 'check_in'::\""text\"") AND (\""date\""(\""al\"".\""occurred_at\"") = \""s\"".\""shift_date\""))\n          ORDER BY \""al\"".\""occurred_at\""\n         LIMIT 1) AS \""actual_check_in\"",\n    ( SELECT \""al\"".\""occurred_at\""\n           FROM \""public\"".\""attendance_logs\"" \""al\""\n          WHERE ((\""al\"".\""employee_id\"" = \""s\"".\""employee_id\"") AND (\""al\"".\""site_id\"" = \""s\"".\""site_id\"") AND (\""al\"".\""action\"" = 'check_out'::\""text\"") AND (\""date\""(\""al\"".\""occurred_at\"") = \""s\"".\""shift_date\""))\n          ORDER BY \""al\"".\""occurred_at\"" DESC\n         LIMIT 1) AS \""actual_check_out\"",\n    \""s\"".\""created_at\"",\n    \""s\"".\""updated_at\""\n   FROM ((\""public\"".\""employee_shifts\"" \""s\""\n     JOIN \""public\"".\""employees\"" \""e\"" ON ((\""e\"".\""id\"" = \""s\"".\""employee_id\"")))\n     JOIN \""public\"".\""sites\"" \""si\"" ON ((\""si\"".\""id\"" = \""s\"".\""site_id\"")))"",""ALTER VIEW \""public\"".\""shift_calendar_view\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""staff_invitations\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""token\"" \""text\"" NOT NULL,\n    \""email\"" \""text\"",\n    \""full_name\"" \""text\"",\n    \""staff_site_id\"" \""uuid\"",\n    \""staff_role\"" \""text\"",\n    \""staff_area\"" \""text\"",\n    \""status\"" \""text\"" DEFAULT 'pending'::\""text\"" NOT NULL,\n    \""expires_at\"" timestamp with time zone,\n    \""accepted_at\"" timestamp with time zone,\n    \""created_by\"" \""uuid\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""staff_invitations\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""staff_invitations\"" IS 'Core – tabla canónica para invitaciones de staff. Gestiona invitaciones a empleados/colaboradores y su onboarding.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""staging_insumos_import\"" (\n    \""fecha\"" \""text\"",\n    \""area\"" \""text\"",\n    \""proveedor\"" \""text\"",\n    \""producto\"" \""text\"",\n    \""presentacion_raw\"" \""text\"",\n    \""purchase_unit\"" \""text\"",\n    \""purchase_unit_size\"" \""text\"",\n    \""base_unit\"" \""text\"",\n    \""unit_token\"" \""text\"",\n    \""precio_raw\"" \""text\"",\n    \""precio_cop\"" \""text\"",\n    \""issues\"" \""text\""\n)"",""ALTER TABLE \""public\"".\""staging_insumos_import\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""suppliers\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""name\"" \""text\"" NOT NULL,\n    \""tax_id\"" \""text\"",\n    \""contact_name\"" \""text\"",\n    \""phone\"" \""text\"",\n    \""email\"" \""text\"",\n    \""address\"" \""text\"",\n    \""notes\"" \""text\"",\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""updated_at\"" timestamp with time zone\n)"",""ALTER TABLE \""public\"".\""suppliers\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""suppliers\"" IS 'Core – tabla canónica para proveedores. Datos maestros de proveedores usados en compras y acuerdos de suministro.'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""user_favorites\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""user_id\"" \""uuid\"" NOT NULL,\n    \""reward_id\"" \""uuid\"" NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL\n)"",""ALTER TABLE \""public\"".\""user_favorites\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""user_favorites\"" IS 'Tabla de productos favoritos marcados por usuarios'"",""COMMENT ON COLUMN \""public\"".\""user_favorites\"".\""user_id\"" IS 'ID del usuario que marcó el favorito'"",""COMMENT ON COLUMN \""public\"".\""user_favorites\"".\""reward_id\"" IS 'ID del producto (reward) marcado como favorito'"",""COMMENT ON COLUMN \""public\"".\""user_favorites\"".\""created_at\"" IS 'Fecha y hora en que se marcó como favorito'"",""CREATE TABLE IF NOT EXISTS \""public\"".\""user_feedback\"" (\n    \""id\"" \""uuid\"" DEFAULT \""gen_random_uuid\""() NOT NULL,\n    \""user_id\"" \""uuid\"" NOT NULL,\n    \""site_id\"" \""uuid\"",\n    \""rating\"" integer NOT NULL,\n    \""feedback_text\"" \""text\"",\n    \""category\"" \""text\"",\n    \""status\"" \""text\"" DEFAULT 'pending'::\""text\"" NOT NULL,\n    \""reviewed_by\"" \""uuid\"",\n    \""reviewed_at\"" timestamp with time zone,\n    \""resolution_notes\"" \""text\"",\n    \""metadata\"" \""jsonb\"" DEFAULT '{}'::\""jsonb\"",\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    CONSTRAINT \""user_feedback_rating_check\"" CHECK (((\""rating\"" >= 1) AND (\""rating\"" <= 5)))\n)"",""ALTER TABLE \""public\"".\""user_feedback\"" OWNER TO \""postgres\"""",""CREATE TABLE IF NOT EXISTS \""public\"".\""users\"" (\n    \""id\"" \""uuid\"" NOT NULL,\n    \""full_name\"" \""text\"",\n    \""document_id\"" \""text\"",\n    \""phone\"" \""text\"",\n    \""role\"" \""text\"" DEFAULT 'client'::\""text\"" NOT NULL,\n    \""is_active\"" boolean DEFAULT true NOT NULL,\n    \""created_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""updated_at\"" timestamp with time zone DEFAULT \""now\""() NOT NULL,\n    \""loyalty_points\"" integer DEFAULT 0 NOT NULL,\n    \""email\"" \""text\"",\n    \""document_type\"" \""text\"",\n    \""birth_date\"" \""date\"",\n    \""is_client\"" boolean DEFAULT true NOT NULL,\n    \""marketing_opt_in\"" boolean DEFAULT false NOT NULL,\n    \""has_reviewed_google\"" boolean DEFAULT false,\n    \""last_review_prompt_date\"" timestamp with time zone\n)"",""ALTER TABLE \""public\"".\""users\"" OWNER TO \""postgres\"""",""COMMENT ON TABLE \""public\"".\""users\"" IS 'Core – tabla canónica para usuarios/clients. Registro de clientes/usuarios del sistema, sus datos y relación con pedidos y lealtad.'"",""CREATE OR REPLACE VIEW \""public\"".\""v_inventory_catalog\"" AS\n SELECT \""p\"".\""id\"",\n    \""p\"".\""name\"",\n    \""p\"".\""description\"",\n    \""p\"".\""sku\"",\n    \""p\"".\""price\"",\n    \""p\"".\""cost\"",\n    \""p\"".\""unit\"",\n    \""p\"".\""product_type\"",\n    \""p\"".\""category_id\"",\n    \""pc\"".\""name\"" AS \""category_name\"",\n    \""p\"".\""is_active\"",\n    \""p\"".\""created_at\"",\n    \""p\"".\""updated_at\""\n   FROM (\""public\"".\""products\"" \""p\""\n     LEFT JOIN \""public\"".\""product_categories\"" \""pc\"" ON ((\""p\"".\""category_id\"" = \""pc\"".\""id\"")))"",""ALTER VIEW \""public\"".\""v_inventory_catalog\"" OWNER TO \""postgres\"""",""CREATE OR REPLACE VIEW \""public\"".\""v_procurement_price_book\"" AS\n SELECT \""s\"".\""id\"" AS \""supplier_id\"",\n    \""s\"".\""name\"" AS \""supplier_name\"",\n    \""p\"".\""id\"" AS \""product_id\"",\n    \""p\"".\""name\"" AS \""product_name\"",\n    \""p\"".\""unit\"",\n    \""pap\"".\""agreed_price\"",\n    \""pap\"".\""valid_from\"",\n    \""pap\"".\""valid_until\"",\n    \""pc\"".\""name\"" AS \""category_name\""\n   FROM (((\""public\"".\""procurement_agreed_prices\"" \""pap\""\n     JOIN \""public\"".\""suppliers\"" \""s\"" ON ((\""pap\"".\""supplier_id\"" = \""s\"".\""id\"")))\n     JOIN \""public\"".\""products\"" \""p\"" ON ((\""pap\"".\""product_id\"" = \""p\"".\""id\"")))\n     LEFT JOIN \""public\"".\""product_categories\"" \""pc\"" ON ((\""p\"".\""category_id\"" = \""pc\"".\""id\"")))\n  WHERE ((\""pap\"".\""is_active\"" = true) AND (\""s\"".\""is_active\"" = true) AND (\""p\"".\""is_active\"" = true))"",""ALTER VIEW \""public\"".\""v_procurement_price_book\"" OWNER TO \""postgres\"""",""ALTER TABLE ONLY \""public\"".\""areas\""\n    ADD CONSTRAINT \""areas_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""asistencia_logs\""\n    ADD CONSTRAINT \""asistencia_logs_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""attendance_logs\""\n    ADD CONSTRAINT \""attendance_logs_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""cost_centers\""\n    ADD CONSTRAINT \""cost_centers_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""employee_areas\""\n    ADD CONSTRAINT \""employee_areas_pkey\"" PRIMARY KEY (\""employee_id\"", \""area_id\"")"",""ALTER TABLE ONLY \""public\"".\""employee_settings\""\n    ADD CONSTRAINT \""employee_settings_pkey\"" PRIMARY KEY (\""employee_id\"")"",""ALTER TABLE ONLY \""public\"".\""employee_shifts\""\n    ADD CONSTRAINT \""employee_shifts_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""employee_sites\""\n    ADD CONSTRAINT \""employee_sites_pkey\"" PRIMARY KEY (\""employee_id\"", \""site_id\"")"",""ALTER TABLE ONLY \""public\"".\""employees\""\n    ADD CONSTRAINT \""employees_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_locations\""\n    ADD CONSTRAINT \""inventory_locations_code_key\"" UNIQUE (\""code\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_locations\""\n    ADD CONSTRAINT \""inventory_locations_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_lpn_items\""\n    ADD CONSTRAINT \""inventory_lpn_items_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_lpns\""\n    ADD CONSTRAINT \""inventory_lpns_code_key\"" UNIQUE (\""code\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_lpns\""\n    ADD CONSTRAINT \""inventory_lpns_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_movement_types\""\n    ADD CONSTRAINT \""inventory_movement_types_pkey\"" PRIMARY KEY (\""code\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_movements\""\n    ADD CONSTRAINT \""inventory_movements_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_stock_by_site\""\n    ADD CONSTRAINT \""inventory_stock_by_site_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_stock_by_site\""\n    ADD CONSTRAINT \""inventory_stock_by_site_site_product_unique\"" UNIQUE (\""site_id\"", \""product_id\"")"",""ALTER TABLE ONLY \""public\"".\""loyalty_redemptions\""\n    ADD CONSTRAINT \""loyalty_redemptions_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""loyalty_rewards\""\n    ADD CONSTRAINT \""loyalty_rewards_code_key\"" UNIQUE (\""code\"")"",""ALTER TABLE ONLY \""public\"".\""loyalty_rewards\""\n    ADD CONSTRAINT \""loyalty_rewards_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""loyalty_transactions\""\n    ADD CONSTRAINT \""loyalty_transactions_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""order_items\""\n    ADD CONSTRAINT \""order_items_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""orders\""\n    ADD CONSTRAINT \""orders_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_cash_movements\""\n    ADD CONSTRAINT \""pos_cash_movements_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_cash_shifts\""\n    ADD CONSTRAINT \""pos_cash_shifts_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_modifier_options\""\n    ADD CONSTRAINT \""pos_modifier_options_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_modifiers\""\n    ADD CONSTRAINT \""pos_modifiers_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_order_item_modifiers\""\n    ADD CONSTRAINT \""pos_order_item_modifiers_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_payments\""\n    ADD CONSTRAINT \""pos_payments_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_product_modifiers\""\n    ADD CONSTRAINT \""pos_product_modifiers_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_product_modifiers\""\n    ADD CONSTRAINT \""pos_product_modifiers_product_id_modifier_id_key\"" UNIQUE (\""product_id\"", \""modifier_id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_session_orders\""\n    ADD CONSTRAINT \""pos_session_orders_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_sessions\""\n    ADD CONSTRAINT \""pos_sessions_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_tables\""\n    ADD CONSTRAINT \""pos_tables_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_zones\""\n    ADD CONSTRAINT \""pos_zones_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""procurement_agreed_prices\""\n    ADD CONSTRAINT \""procurement_agreed_prices_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""procurement_reception_items\""\n    ADD CONSTRAINT \""procurement_reception_items_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""procurement_receptions\""\n    ADD CONSTRAINT \""procurement_receptions_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""product_categories\""\n    ADD CONSTRAINT \""product_categories_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""product_categories\""\n    ADD CONSTRAINT \""product_categories_slug_key\"" UNIQUE (\""slug\"")"",""ALTER TABLE ONLY \""public\"".\""product_inventory_profiles\""\n    ADD CONSTRAINT \""product_inventory_profiles_pkey\"" PRIMARY KEY (\""product_id\"")"",""ALTER TABLE ONLY \""public\"".\""product_sku_aliases\""\n    ADD CONSTRAINT \""product_sku_aliases_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""product_sku_sequences\""\n    ADD CONSTRAINT \""product_sku_sequences_pkey\"" PRIMARY KEY (\""brand_code\"", \""type_code\"")"",""ALTER TABLE ONLY \""public\"".\""product_suppliers\""\n    ADD CONSTRAINT \""product_suppliers_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""production_batches\""\n    ADD CONSTRAINT \""production_batches_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""production_request_items\""\n    ADD CONSTRAINT \""production_request_items_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""production_requests\""\n    ADD CONSTRAINT \""production_requests_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""products\""\n    ADD CONSTRAINT \""products_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""products\""\n    ADD CONSTRAINT \""products_sku_key\"" UNIQUE (\""sku\"")"",""ALTER TABLE ONLY \""public\"".\""purchase_order_items\""\n    ADD CONSTRAINT \""purchase_order_items_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""purchase_orders\""\n    ADD CONSTRAINT \""purchase_orders_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""recipe_cards\""\n    ADD CONSTRAINT \""recipe_cards_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""recipe_cards\""\n    ADD CONSTRAINT \""recipe_cards_product_id_key\"" UNIQUE (\""product_id\"")"",""ALTER TABLE ONLY \""public\"".\""recipe_steps\""\n    ADD CONSTRAINT \""recipe_steps_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""recipe_steps\""\n    ADD CONSTRAINT \""recipe_steps_unique_step\"" UNIQUE (\""recipe_card_id\"", \""step_number\"")"",""ALTER TABLE ONLY \""public\"".\""recipes\""\n    ADD CONSTRAINT \""recipes_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""restock_request_items\""\n    ADD CONSTRAINT \""restock_request_items_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""restock_requests\""\n    ADD CONSTRAINT \""restock_requests_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""sites\""\n    ADD CONSTRAINT \""sites_code_key\"" UNIQUE (\""code\"")"",""ALTER TABLE ONLY \""public\"".\""sites\""\n    ADD CONSTRAINT \""sites_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""staff_invitations\""\n    ADD CONSTRAINT \""staff_invitations_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""suppliers\""\n    ADD CONSTRAINT \""suppliers_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""employee_shifts\""\n    ADD CONSTRAINT \""unique_employee_shift_per_day\"" UNIQUE (\""employee_id\"", \""site_id\"", \""shift_date\"", \""start_time\"")"",""ALTER TABLE ONLY \""public\"".\""user_favorites\""\n    ADD CONSTRAINT \""user_favorites_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""user_favorites\""\n    ADD CONSTRAINT \""user_favorites_user_id_reward_id_key\"" UNIQUE (\""user_id\"", \""reward_id\"")"",""ALTER TABLE ONLY \""public\"".\""user_feedback\""\n    ADD CONSTRAINT \""user_feedback_pkey\"" PRIMARY KEY (\""id\"")"",""ALTER TABLE ONLY \""public\"".\""users\""\n    ADD CONSTRAINT \""users_document_id_key\"" UNIQUE (\""document_id\"")"",""ALTER TABLE ONLY \""public\"".\""users\""\n    ADD CONSTRAINT \""users_pkey\"" PRIMARY KEY (\""id\"")"",""CREATE UNIQUE INDEX \""areas_site_code_unique\"" ON \""public\"".\""areas\"" USING \""btree\"" (\""site_id\"", \""code\"")"",""CREATE INDEX \""areas_site_id_idx\"" ON \""public\"".\""areas\"" USING \""btree\"" (\""site_id\"")"",""CREATE UNIQUE INDEX \""asistencia_logs_employee_fecha_unique\"" ON \""public\"".\""asistencia_logs\"" USING \""btree\"" (\""empleado_id\"", \""fecha_hora\"")"",""CREATE INDEX \""attendance_logs_employee_occurred_at_idx\"" ON \""public\"".\""attendance_logs\"" USING \""btree\"" (\""employee_id\"", \""occurred_at\"" DESC)"",""CREATE INDEX \""employee_areas_employee_idx\"" ON \""public\"".\""employee_areas\"" USING \""btree\"" (\""employee_id\"")"",""CREATE UNIQUE INDEX \""employee_areas_one_primary\"" ON \""public\"".\""employee_areas\"" USING \""btree\"" (\""employee_id\"") WHERE (\""is_primary\"" = true)"",""CREATE INDEX \""employee_sites_employee_idx\"" ON \""public\"".\""employee_sites\"" USING \""btree\"" (\""employee_id\"")"",""CREATE UNIQUE INDEX \""employee_sites_one_primary\"" ON \""public\"".\""employee_sites\"" USING \""btree\"" (\""employee_id\"") WHERE (\""is_primary\"" = true)"",""CREATE INDEX \""employees_area_id_idx\"" ON \""public\"".\""employees\"" USING \""btree\"" (\""area_id\"")"",""CREATE INDEX \""idx_attendance_logs_employee\"" ON \""public\"".\""attendance_logs\"" USING \""btree\"" (\""employee_id\"")"",""CREATE INDEX \""idx_attendance_logs_employee_date\"" ON \""public\"".\""attendance_logs\"" USING \""btree\"" (\""employee_id\"", \""occurred_at\"" DESC)"",""CREATE INDEX \""idx_attendance_logs_occurred\"" ON \""public\"".\""attendance_logs\"" USING \""btree\"" (\""occurred_at\"" DESC)"",""CREATE INDEX \""idx_attendance_logs_site_date\"" ON \""public\"".\""attendance_logs\"" USING \""btree\"" (\""site_id\"", \""occurred_at\"" DESC)"",""CREATE INDEX \""idx_employee_shifts_date_range\"" ON \""public\"".\""employee_shifts\"" USING \""btree\"" (\""shift_date\"", \""site_id\"")"",""CREATE INDEX \""idx_employee_shifts_employee_date\"" ON \""public\"".\""employee_shifts\"" USING \""btree\"" (\""employee_id\"", \""shift_date\"" DESC)"",""CREATE INDEX \""idx_employee_shifts_site_date\"" ON \""public\"".\""employee_shifts\"" USING \""btree\"" (\""site_id\"", \""shift_date\"" DESC)"",""CREATE INDEX \""idx_employee_shifts_status\"" ON \""public\"".\""employee_shifts\"" USING \""btree\"" (\""status\"") WHERE (\""status\"" = 'scheduled'::\""text\"")"",""CREATE INDEX \""idx_inv_locations_code\"" ON \""public\"".\""inventory_locations\"" USING \""btree\"" (\""code\"")"",""CREATE INDEX \""idx_inv_locations_site\"" ON \""public\"".\""inventory_locations\"" USING \""btree\"" (\""site_id\"")"",""CREATE INDEX \""idx_inv_locations_zone\"" ON \""public\"".\""inventory_locations\"" USING \""btree\"" (\""zone\"")"",""CREATE INDEX \""idx_inv_lpn_items_expiry\"" ON \""public\"".\""inventory_lpn_items\"" USING \""btree\"" (\""expiry_date\"")"",""CREATE INDEX \""idx_inv_lpn_items_lot\"" ON \""public\"".\""inventory_lpn_items\"" USING \""btree\"" (\""lot_number\"")"",""CREATE INDEX \""idx_inv_lpn_items_lpn\"" ON \""public\"".\""inventory_lpn_items\"" USING \""btree\"" (\""lpn_id\"")"",""CREATE INDEX \""idx_inv_lpn_items_product\"" ON \""public\"".\""inventory_lpn_items\"" USING \""btree\"" (\""product_id\"")"",""CREATE INDEX \""idx_inv_lpns_code\"" ON \""public\"".\""inventory_lpns\"" USING \""btree\"" (\""code\"")"",""CREATE INDEX \""idx_inv_lpns_location\"" ON \""public\"".\""inventory_lpns\"" USING \""btree\"" (\""location_id\"")"",""CREATE INDEX \""idx_inv_lpns_site\"" ON \""public\"".\""inventory_lpns\"" USING \""btree\"" (\""site_id\"")"",""CREATE INDEX \""idx_inv_lpns_status\"" ON \""public\"".\""inventory_lpns\"" USING \""btree\"" (\""status\"")"",""CREATE INDEX \""idx_inventory_movements_movement_type\"" ON \""public\"".\""inventory_movements\"" USING \""btree\"" (\""movement_type\"")"",""CREATE INDEX \""idx_orders_table_status\"" ON \""public\"".\""orders\"" USING \""btree\"" (\""table_number\"", \""status\"") WHERE (\""status\"" <> 'paid'::\""text\"")"",""CREATE INDEX \""idx_product_categories_domain_site_id\"" ON \""public\"".\""product_categories\"" USING \""btree\"" (\""domain\"", \""site_id\"")"",""CREATE INDEX \""idx_product_categories_site_id\"" ON \""public\"".\""product_categories\"" USING \""btree\"" (\""site_id\"")"",""CREATE INDEX \""idx_recipe_cards_area_id\"" ON \""public\"".\""recipe_cards\"" USING \""btree\"" (\""area_id\"")"",""CREATE INDEX \""idx_recipe_cards_site_id\"" ON \""public\"".\""recipe_cards\"" USING \""btree\"" (\""site_id\"")"",""CREATE INDEX \""idx_recipe_cards_status\"" ON \""public\"".\""recipe_cards\"" USING \""btree\"" (\""status\"")"",""CREATE INDEX \""idx_recipe_steps_recipe_card_id\"" ON \""public\"".\""recipe_steps\"" USING \""btree\"" (\""recipe_card_id\"")"",""CREATE INDEX \""idx_recipes_ingredient_product_id\"" ON \""public\"".\""recipes\"" USING \""btree\"" (\""ingredient_product_id\"")"",""CREATE INDEX \""idx_sites_location\"" ON \""public\"".\""sites\"" USING \""btree\"" (\""latitude\"", \""longitude\"") WHERE ((\""latitude\"" IS NOT NULL) AND (\""longitude\"" IS NOT NULL))"",""CREATE INDEX \""idx_user_favorites_created_at\"" ON \""public\"".\""user_favorites\"" USING \""btree\"" (\""created_at\"" DESC)"",""CREATE INDEX \""idx_user_favorites_reward_id\"" ON \""public\"".\""user_favorites\"" USING \""btree\"" (\""reward_id\"")"",""CREATE INDEX \""idx_user_favorites_user_id\"" ON \""public\"".\""user_favorites\"" USING \""btree\"" (\""user_id\"")"",""CREATE INDEX \""idx_user_feedback_created_at\"" ON \""public\"".\""user_feedback\"" USING \""btree\"" (\""created_at\"" DESC)"",""CREATE INDEX \""idx_user_feedback_rating\"" ON \""public\"".\""user_feedback\"" USING \""btree\"" (\""rating\"")"",""CREATE INDEX \""idx_user_feedback_site_id\"" ON \""public\"".\""user_feedback\"" USING \""btree\"" (\""site_id\"")"",""CREATE INDEX \""idx_user_feedback_status\"" ON \""public\"".\""user_feedback\"" USING \""btree\"" (\""status\"")"",""CREATE INDEX \""idx_user_feedback_user_id\"" ON \""public\"".\""user_feedback\"" USING \""btree\"" (\""user_id\"")"",""CREATE INDEX \""inventory_movements_related_purchase_order_id_idx\"" ON \""public\"".\""inventory_movements\"" USING \""btree\"" (\""related_purchase_order_id\"")"",""CREATE UNIQUE INDEX \""inventory_stock_by_site_site_product_uidx\"" ON \""public\"".\""inventory_stock_by_site\"" USING \""btree\"" (\""site_id\"", \""product_id\"")"",""CREATE UNIQUE INDEX \""inventory_stock_by_site_unique_site_product\"" ON \""public\"".\""inventory_stock_by_site\"" USING \""btree\"" (\""site_id\"", \""product_id\"")"",""CREATE INDEX \""loyalty_redemptions_order_idx\"" ON \""public\"".\""loyalty_redemptions\"" USING \""btree\"" (\""order_id\"")"",""CREATE INDEX \""loyalty_redemptions_reward_idx\"" ON \""public\"".\""loyalty_redemptions\"" USING \""btree\"" (\""reward_id\"")"",""CREATE INDEX \""loyalty_redemptions_user_created_idx\"" ON \""public\"".\""loyalty_redemptions\"" USING \""btree\"" (\""user_id\"", \""created_at\"" DESC)"",""CREATE INDEX \""loyalty_transactions_order_idx\"" ON \""public\"".\""loyalty_transactions\"" USING \""btree\"" (\""order_id\"")"",""CREATE INDEX \""loyalty_transactions_user_created_idx\"" ON \""public\"".\""loyalty_transactions\"" USING \""btree\"" (\""user_id\"", \""created_at\"" DESC)"",""CREATE INDEX \""product_categories_domain_idx\"" ON \""public\"".\""product_categories\"" USING \""btree\"" (\""domain\"")"",""CREATE UNIQUE INDEX \""product_categories_domain_parent_slug_uidx\"" ON \""public\"".\""product_categories\"" USING \""btree\"" (\""domain\"", COALESCE(\""parent_id\"", '00000000-0000-0000-0000-000000000000'::\""uuid\""), \""slug\"")"",""CREATE INDEX \""product_categories_parent_id_idx\"" ON \""public\"".\""product_categories\"" USING \""btree\"" (\""parent_id\"")"",""CREATE INDEX \""product_sku_aliases_product_id_idx\"" ON \""public\"".\""product_sku_aliases\"" USING \""btree\"" (\""product_id\"")"",""CREATE UNIQUE INDEX \""product_sku_aliases_sku_key\"" ON \""public\"".\""product_sku_aliases\"" USING \""btree\"" (\""sku\"")"",""CREATE INDEX \""purchase_orders_created_by_idx\"" ON \""public\"".\""purchase_orders\"" USING \""btree\"" (\""created_by\"")"",""CREATE UNIQUE INDEX \""staff_invitations_token_key\"" ON \""public\"".\""staff_invitations\"" USING \""btree\"" (\""token\"")"",""CREATE OR REPLACE TRIGGER \""attendance_logs_00_geofence\"" BEFORE INSERT ON \""public\"".\""attendance_logs\"" FOR EACH ROW EXECUTE FUNCTION \""public\"".\""enforce_attendance_geofence\""()"",""CREATE OR REPLACE TRIGGER \""attendance_logs_enforce_sequence\"" BEFORE INSERT ON \""public\"".\""attendance_logs\"" FOR EACH ROW EXECUTE FUNCTION \""public\"".\""enforce_attendance_sequence\""()"",""CREATE OR REPLACE TRIGGER \""on_loyalty_transaction_created\"" AFTER INSERT ON \""public\"".\""loyalty_transactions\"" FOR EACH ROW EXECUTE FUNCTION \""public\"".\""update_loyalty_balance\""()"",""CREATE OR REPLACE TRIGGER \""set_updated_at_product_inventory_profiles\"" BEFORE UPDATE ON \""public\"".\""product_inventory_profiles\"" FOR EACH ROW EXECUTE FUNCTION \""public\"".\""tg_set_updated_at\""()"",""CREATE OR REPLACE TRIGGER \""trg_enforce_employee_role_site\"" BEFORE INSERT OR UPDATE OF \""role\"", \""site_id\"" ON \""public\"".\""employees\"" FOR EACH ROW EXECUTE FUNCTION \""public\"".\""enforce_employee_role_site\""()"",""CREATE OR REPLACE TRIGGER \""trg_product_categories_updated_at\"" BEFORE UPDATE ON \""public\"".\""product_categories\"" FOR EACH ROW EXECUTE FUNCTION \""public\"".\""_set_updated_at\""()"",""CREATE OR REPLACE TRIGGER \""trg_set_product_sku\"" BEFORE INSERT OR UPDATE ON \""public\"".\""products\"" FOR EACH ROW EXECUTE FUNCTION \""public\"".\""set_product_sku\""()"",""CREATE OR REPLACE TRIGGER \""trigger_employee_shifts_updated_at\"" BEFORE UPDATE ON \""public\"".\""employee_shifts\"" FOR EACH ROW EXECUTE FUNCTION \""public\"".\""update_employee_shifts_updated_at\""()"",""CREATE OR REPLACE TRIGGER \""update_inventory_locations_updated_at\"" BEFORE UPDATE ON \""public\"".\""inventory_locations\"" FOR EACH ROW EXECUTE FUNCTION \""public\"".\""update_updated_at\""()"",""CREATE OR REPLACE TRIGGER \""update_inventory_lpn_items_updated_at\"" BEFORE UPDATE ON \""public\"".\""inventory_lpn_items\"" FOR EACH ROW EXECUTE FUNCTION \""public\"".\""update_updated_at\""()"",""CREATE OR REPLACE TRIGGER \""update_inventory_lpns_updated_at\"" BEFORE UPDATE ON \""public\"".\""inventory_lpns\"" FOR EACH ROW EXECUTE FUNCTION \""public\"".\""update_updated_at\""()"",""ALTER TABLE ONLY \""public\"".\""areas\""\n    ADD CONSTRAINT \""areas_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""attendance_logs\""\n    ADD CONSTRAINT \""attendance_logs_employee_id_fkey\"" FOREIGN KEY (\""employee_id\"") REFERENCES \""public\"".\""employees\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""attendance_logs\""\n    ADD CONSTRAINT \""attendance_logs_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"") ON DELETE RESTRICT"",""ALTER TABLE ONLY \""public\"".\""cost_centers\""\n    ADD CONSTRAINT \""cost_centers_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""employee_areas\""\n    ADD CONSTRAINT \""employee_areas_area_id_fkey\"" FOREIGN KEY (\""area_id\"") REFERENCES \""public\"".\""areas\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""employee_areas\""\n    ADD CONSTRAINT \""employee_areas_employee_id_fkey\"" FOREIGN KEY (\""employee_id\"") REFERENCES \""public\"".\""employees\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""employee_settings\""\n    ADD CONSTRAINT \""employee_settings_employee_id_fkey\"" FOREIGN KEY (\""employee_id\"") REFERENCES \""public\"".\""employees\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""employee_settings\""\n    ADD CONSTRAINT \""employee_settings_selected_area_id_fkey\"" FOREIGN KEY (\""selected_area_id\"") REFERENCES \""public\"".\""areas\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""employee_settings\""\n    ADD CONSTRAINT \""employee_settings_selected_site_id_fkey\"" FOREIGN KEY (\""selected_site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""employee_shifts\""\n    ADD CONSTRAINT \""employee_shifts_created_by_fkey\"" FOREIGN KEY (\""created_by\"") REFERENCES \""public\"".\""employees\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""employee_shifts\""\n    ADD CONSTRAINT \""employee_shifts_employee_id_fkey\"" FOREIGN KEY (\""employee_id\"") REFERENCES \""public\"".\""employees\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""employee_shifts\""\n    ADD CONSTRAINT \""employee_shifts_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""employee_sites\""\n    ADD CONSTRAINT \""employee_sites_employee_id_fkey\"" FOREIGN KEY (\""employee_id\"") REFERENCES \""public\"".\""employees\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""employee_sites\""\n    ADD CONSTRAINT \""employee_sites_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""employees\""\n    ADD CONSTRAINT \""employees_area_id_fkey\"" FOREIGN KEY (\""area_id\"") REFERENCES \""public\"".\""areas\""(\""id\"") ON DELETE SET NULL"",""ALTER TABLE ONLY \""public\"".\""employees\""\n    ADD CONSTRAINT \""employees_id_fkey\"" FOREIGN KEY (\""id\"") REFERENCES \""auth\"".\""users\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""employees\""\n    ADD CONSTRAINT \""employees_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_locations\""\n    ADD CONSTRAINT \""inventory_locations_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""inventory_lpn_items\""\n    ADD CONSTRAINT \""inventory_lpn_items_lpn_id_fkey\"" FOREIGN KEY (\""lpn_id\"") REFERENCES \""public\"".\""inventory_lpns\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""inventory_lpn_items\""\n    ADD CONSTRAINT \""inventory_lpn_items_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""inventory_lpns\""\n    ADD CONSTRAINT \""inventory_lpns_created_by_fkey\"" FOREIGN KEY (\""created_by\"") REFERENCES \""public\"".\""employees\""(\""id\"") ON DELETE SET NULL"",""ALTER TABLE ONLY \""public\"".\""inventory_lpns\""\n    ADD CONSTRAINT \""inventory_lpns_location_id_fkey\"" FOREIGN KEY (\""location_id\"") REFERENCES \""public\"".\""inventory_locations\""(\""id\"") ON DELETE SET NULL"",""ALTER TABLE ONLY \""public\"".\""inventory_lpns\""\n    ADD CONSTRAINT \""inventory_lpns_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""inventory_movements\""\n    ADD CONSTRAINT \""inventory_movements_movement_type_fkey\"" FOREIGN KEY (\""movement_type\"") REFERENCES \""public\"".\""inventory_movement_types\""(\""code\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_movements\""\n    ADD CONSTRAINT \""inventory_movements_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_movements\""\n    ADD CONSTRAINT \""inventory_movements_production_batch_id_fkey\"" FOREIGN KEY (\""related_production_batch_id\"") REFERENCES \""public\"".\""production_batches\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_movements\""\n    ADD CONSTRAINT \""inventory_movements_related_order_id_fkey\"" FOREIGN KEY (\""related_order_id\"") REFERENCES \""public\"".\""orders\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_movements\""\n    ADD CONSTRAINT \""inventory_movements_related_production_request_id_fkey\"" FOREIGN KEY (\""related_production_request_id\"") REFERENCES \""public\"".\""production_requests\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_movements\""\n    ADD CONSTRAINT \""inventory_movements_related_purchase_order_id_fkey\"" FOREIGN KEY (\""related_purchase_order_id\"") REFERENCES \""public\"".\""purchase_orders\""(\""id\"") ON DELETE SET NULL"",""ALTER TABLE ONLY \""public\"".\""inventory_movements\""\n    ADD CONSTRAINT \""inventory_movements_related_restock_request_id_fkey\"" FOREIGN KEY (\""related_restock_request_id\"") REFERENCES \""public\"".\""restock_requests\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_movements\""\n    ADD CONSTRAINT \""inventory_movements_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_stock_by_site\""\n    ADD CONSTRAINT \""inventory_stock_by_site_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""inventory_stock_by_site\""\n    ADD CONSTRAINT \""inventory_stock_by_site_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""loyalty_redemptions\""\n    ADD CONSTRAINT \""loyalty_redemptions_order_id_fkey\"" FOREIGN KEY (\""order_id\"") REFERENCES \""public\"".\""orders\""(\""id\"") ON DELETE SET NULL"",""ALTER TABLE ONLY \""public\"".\""loyalty_redemptions\""\n    ADD CONSTRAINT \""loyalty_redemptions_reward_id_fkey\"" FOREIGN KEY (\""reward_id\"") REFERENCES \""public\"".\""loyalty_rewards\""(\""id\"") ON DELETE RESTRICT"",""ALTER TABLE ONLY \""public\"".\""loyalty_redemptions\""\n    ADD CONSTRAINT \""loyalty_redemptions_user_id_fkey\"" FOREIGN KEY (\""user_id\"") REFERENCES \""public\"".\""users\""(\""id\"") ON DELETE RESTRICT"",""ALTER TABLE ONLY \""public\"".\""loyalty_rewards\""\n    ADD CONSTRAINT \""loyalty_rewards_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""loyalty_transactions\""\n    ADD CONSTRAINT \""loyalty_transactions_order_id_fkey\"" FOREIGN KEY (\""order_id\"") REFERENCES \""public\"".\""orders\""(\""id\"") ON DELETE SET NULL"",""ALTER TABLE ONLY \""public\"".\""loyalty_transactions\""\n    ADD CONSTRAINT \""loyalty_transactions_user_id_fkey\"" FOREIGN KEY (\""user_id\"") REFERENCES \""public\"".\""users\""(\""id\"") ON DELETE RESTRICT"",""ALTER TABLE ONLY \""public\"".\""order_items\""\n    ADD CONSTRAINT \""order_items_order_id_fkey\"" FOREIGN KEY (\""order_id\"") REFERENCES \""public\"".\""orders\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""order_items\""\n    ADD CONSTRAINT \""order_items_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""orders\""\n    ADD CONSTRAINT \""orders_client_id_fkey\"" FOREIGN KEY (\""client_id\"") REFERENCES \""public\"".\""users\""(\""id\"") ON UPDATE RESTRICT"",""ALTER TABLE ONLY \""public\"".\""orders\""\n    ADD CONSTRAINT \""orders_server_id_fkey\"" FOREIGN KEY (\""server_id\"") REFERENCES \""public\"".\""employees\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""orders\""\n    ADD CONSTRAINT \""orders_session_id_fkey\"" FOREIGN KEY (\""session_id\"") REFERENCES \""public\"".\""pos_sessions\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""orders\""\n    ADD CONSTRAINT \""orders_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""orders\""\n    ADD CONSTRAINT \""orders_voided_by_fkey\"" FOREIGN KEY (\""voided_by\"") REFERENCES \""public\"".\""employees\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_cash_movements\""\n    ADD CONSTRAINT \""pos_cash_movements_created_by_fkey\"" FOREIGN KEY (\""created_by\"") REFERENCES \""public\"".\""employees\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_cash_movements\""\n    ADD CONSTRAINT \""pos_cash_movements_order_id_fkey\"" FOREIGN KEY (\""order_id\"") REFERENCES \""public\"".\""orders\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_cash_movements\""\n    ADD CONSTRAINT \""pos_cash_movements_shift_id_fkey\"" FOREIGN KEY (\""shift_id\"") REFERENCES \""public\"".\""pos_cash_shifts\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_cash_shifts\""\n    ADD CONSTRAINT \""pos_cash_shifts_employee_id_fkey\"" FOREIGN KEY (\""employee_id\"") REFERENCES \""public\"".\""employees\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_cash_shifts\""\n    ADD CONSTRAINT \""pos_cash_shifts_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_modifier_options\""\n    ADD CONSTRAINT \""pos_modifier_options_modifier_id_fkey\"" FOREIGN KEY (\""modifier_id\"") REFERENCES \""public\"".\""pos_modifiers\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_modifiers\""\n    ADD CONSTRAINT \""pos_modifiers_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_order_item_modifiers\""\n    ADD CONSTRAINT \""pos_order_item_modifiers_modifier_id_fkey\"" FOREIGN KEY (\""modifier_id\"") REFERENCES \""public\"".\""pos_modifiers\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_order_item_modifiers\""\n    ADD CONSTRAINT \""pos_order_item_modifiers_modifier_option_id_fkey\"" FOREIGN KEY (\""modifier_option_id\"") REFERENCES \""public\"".\""pos_modifier_options\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_order_item_modifiers\""\n    ADD CONSTRAINT \""pos_order_item_modifiers_order_item_id_fkey\"" FOREIGN KEY (\""order_item_id\"") REFERENCES \""public\"".\""order_items\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_payments\""\n    ADD CONSTRAINT \""pos_payments_order_id_fkey\"" FOREIGN KEY (\""order_id\"") REFERENCES \""public\"".\""orders\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_payments\""\n    ADD CONSTRAINT \""pos_payments_processed_by_fkey\"" FOREIGN KEY (\""processed_by\"") REFERENCES \""public\"".\""employees\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_payments\""\n    ADD CONSTRAINT \""pos_payments_session_id_fkey\"" FOREIGN KEY (\""session_id\"") REFERENCES \""public\"".\""pos_sessions\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_payments\""\n    ADD CONSTRAINT \""pos_payments_shift_id_fkey\"" FOREIGN KEY (\""shift_id\"") REFERENCES \""public\"".\""pos_cash_shifts\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_product_modifiers\""\n    ADD CONSTRAINT \""pos_product_modifiers_modifier_id_fkey\"" FOREIGN KEY (\""modifier_id\"") REFERENCES \""public\"".\""pos_modifiers\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_product_modifiers\""\n    ADD CONSTRAINT \""pos_product_modifiers_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_session_orders\""\n    ADD CONSTRAINT \""pos_session_orders_order_id_fkey\"" FOREIGN KEY (\""order_id\"") REFERENCES \""public\"".\""orders\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_session_orders\""\n    ADD CONSTRAINT \""pos_session_orders_session_id_fkey\"" FOREIGN KEY (\""session_id\"") REFERENCES \""public\"".\""pos_sessions\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_sessions\""\n    ADD CONSTRAINT \""pos_sessions_server_id_fkey\"" FOREIGN KEY (\""server_id\"") REFERENCES \""public\"".\""employees\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_sessions\""\n    ADD CONSTRAINT \""pos_sessions_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_sessions\""\n    ADD CONSTRAINT \""pos_sessions_table_id_fkey\"" FOREIGN KEY (\""table_id\"") REFERENCES \""public\"".\""pos_tables\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_tables\""\n    ADD CONSTRAINT \""pos_tables_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_tables\""\n    ADD CONSTRAINT \""pos_tables_zone_id_fkey\"" FOREIGN KEY (\""zone_id\"") REFERENCES \""public\"".\""pos_zones\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""pos_zones\""\n    ADD CONSTRAINT \""pos_zones_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""procurement_agreed_prices\""\n    ADD CONSTRAINT \""procurement_agreed_prices_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""procurement_agreed_prices\""\n    ADD CONSTRAINT \""procurement_agreed_prices_supplier_id_fkey\"" FOREIGN KEY (\""supplier_id\"") REFERENCES \""public\"".\""suppliers\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""procurement_reception_items\""\n    ADD CONSTRAINT \""procurement_reception_items_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""procurement_reception_items\""\n    ADD CONSTRAINT \""procurement_reception_items_reception_id_fkey\"" FOREIGN KEY (\""reception_id\"") REFERENCES \""public\"".\""procurement_receptions\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""procurement_receptions\""\n    ADD CONSTRAINT \""procurement_receptions_purchase_order_id_fkey\"" FOREIGN KEY (\""purchase_order_id\"") REFERENCES \""public\"".\""purchase_orders\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""procurement_receptions\""\n    ADD CONSTRAINT \""procurement_receptions_received_by_fkey\"" FOREIGN KEY (\""received_by\"") REFERENCES \""auth\"".\""users\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""procurement_receptions\""\n    ADD CONSTRAINT \""procurement_receptions_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""product_categories\""\n    ADD CONSTRAINT \""product_categories_parent_id_fkey\"" FOREIGN KEY (\""parent_id\"") REFERENCES \""public\"".\""product_categories\""(\""id\"") ON DELETE SET NULL"",""ALTER TABLE ONLY \""public\"".\""product_categories\""\n    ADD CONSTRAINT \""product_categories_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"") ON DELETE SET NULL"",""ALTER TABLE ONLY \""public\"".\""product_inventory_profiles\""\n    ADD CONSTRAINT \""product_inventory_profiles_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""product_sku_aliases\""\n    ADD CONSTRAINT \""product_sku_aliases_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""product_suppliers\""\n    ADD CONSTRAINT \""product_suppliers_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""product_suppliers\""\n    ADD CONSTRAINT \""product_suppliers_supplier_id_fkey\"" FOREIGN KEY (\""supplier_id\"") REFERENCES \""public\"".\""suppliers\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""production_batches\""\n    ADD CONSTRAINT \""production_batches_created_by_fkey\"" FOREIGN KEY (\""created_by\"") REFERENCES \""public\"".\""employees\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""production_batches\""\n    ADD CONSTRAINT \""production_batches_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""production_batches\""\n    ADD CONSTRAINT \""production_batches_recipe_card_id_fkey\"" FOREIGN KEY (\""recipe_card_id\"") REFERENCES \""public\"".\""recipe_cards\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""production_batches\""\n    ADD CONSTRAINT \""production_batches_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""production_request_items\""\n    ADD CONSTRAINT \""production_request_items_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""production_request_items\""\n    ADD CONSTRAINT \""production_request_items_recipe_id_fkey\"" FOREIGN KEY (\""recipe_id\"") REFERENCES \""public\"".\""recipes\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""production_request_items\""\n    ADD CONSTRAINT \""production_request_items_request_id_fkey\"" FOREIGN KEY (\""request_id\"") REFERENCES \""public\"".\""production_requests\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""production_requests\""\n    ADD CONSTRAINT \""production_requests_created_by_fkey\"" FOREIGN KEY (\""created_by\"") REFERENCES \""public\"".\""users\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""production_requests\""\n    ADD CONSTRAINT \""production_requests_from_site_id_fkey\"" FOREIGN KEY (\""from_site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""production_requests\""\n    ADD CONSTRAINT \""production_requests_to_site_id_fkey\"" FOREIGN KEY (\""to_site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""products\""\n    ADD CONSTRAINT \""products_category_id_fkey\"" FOREIGN KEY (\""category_id\"") REFERENCES \""public\"".\""product_categories\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""purchase_order_items\""\n    ADD CONSTRAINT \""purchase_order_items_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""purchase_order_items\""\n    ADD CONSTRAINT \""purchase_order_items_purchase_order_id_fkey\"" FOREIGN KEY (\""purchase_order_id\"") REFERENCES \""public\"".\""purchase_orders\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""purchase_orders\""\n    ADD CONSTRAINT \""purchase_orders_approved_by_fkey\"" FOREIGN KEY (\""approved_by\"") REFERENCES \""auth\"".\""users\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""purchase_orders\""\n    ADD CONSTRAINT \""purchase_orders_cost_center_id_fkey\"" FOREIGN KEY (\""cost_center_id\"") REFERENCES \""public\"".\""cost_centers\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""purchase_orders\""\n    ADD CONSTRAINT \""purchase_orders_created_by_fkey\"" FOREIGN KEY (\""created_by\"") REFERENCES \""public\"".\""employees\""(\""id\"") ON DELETE SET NULL"",""ALTER TABLE ONLY \""public\"".\""purchase_orders\""\n    ADD CONSTRAINT \""purchase_orders_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""purchase_orders\""\n    ADD CONSTRAINT \""purchase_orders_supplier_id_fkey\"" FOREIGN KEY (\""supplier_id\"") REFERENCES \""public\"".\""suppliers\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""recipe_cards\""\n    ADD CONSTRAINT \""recipe_cards_area_id_fkey\"" FOREIGN KEY (\""area_id\"") REFERENCES \""public\"".\""areas\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""recipe_cards\""\n    ADD CONSTRAINT \""recipe_cards_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""recipe_cards\""\n    ADD CONSTRAINT \""recipe_cards_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""recipe_steps\""\n    ADD CONSTRAINT \""recipe_steps_recipe_card_id_fkey\"" FOREIGN KEY (\""recipe_card_id\"") REFERENCES \""public\"".\""recipe_cards\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""recipes\""\n    ADD CONSTRAINT \""recipes_ingredient_product_id_fkey\"" FOREIGN KEY (\""ingredient_product_id\"") REFERENCES \""public\"".\""products\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""recipes\""\n    ADD CONSTRAINT \""recipes_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""restock_request_items\""\n    ADD CONSTRAINT \""restock_request_items_product_id_fkey\"" FOREIGN KEY (\""product_id\"") REFERENCES \""public\"".\""products\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""restock_request_items\""\n    ADD CONSTRAINT \""restock_request_items_request_id_fkey\"" FOREIGN KEY (\""request_id\"") REFERENCES \""public\"".\""restock_requests\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""restock_requests\""\n    ADD CONSTRAINT \""restock_requests_created_by_fkey\"" FOREIGN KEY (\""created_by\"") REFERENCES \""public\"".\""users\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""restock_requests\""\n    ADD CONSTRAINT \""restock_requests_from_site_id_fkey\"" FOREIGN KEY (\""from_site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""restock_requests\""\n    ADD CONSTRAINT \""restock_requests_internal_supplier_site_id_fkey\"" FOREIGN KEY (\""internal_supplier_site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""restock_requests\""\n    ADD CONSTRAINT \""restock_requests_to_site_id_fkey\"" FOREIGN KEY (\""to_site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""staff_invitations\""\n    ADD CONSTRAINT \""staff_invitations_created_by_fkey\"" FOREIGN KEY (\""created_by\"") REFERENCES \""public\"".\""users\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""staff_invitations\""\n    ADD CONSTRAINT \""staff_invitations_staff_site_id_fkey\"" FOREIGN KEY (\""staff_site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""user_favorites\""\n    ADD CONSTRAINT \""user_favorites_reward_id_fkey\"" FOREIGN KEY (\""reward_id\"") REFERENCES \""public\"".\""loyalty_rewards\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""user_favorites\""\n    ADD CONSTRAINT \""user_favorites_user_id_fkey\"" FOREIGN KEY (\""user_id\"") REFERENCES \""auth\"".\""users\""(\""id\"") ON DELETE CASCADE"",""ALTER TABLE ONLY \""public\"".\""user_feedback\""\n    ADD CONSTRAINT \""user_feedback_reviewed_by_fkey\"" FOREIGN KEY (\""reviewed_by\"") REFERENCES \""public\"".\""employees\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""user_feedback\""\n    ADD CONSTRAINT \""user_feedback_site_id_fkey\"" FOREIGN KEY (\""site_id\"") REFERENCES \""public\"".\""sites\""(\""id\"")"",""ALTER TABLE ONLY \""public\"".\""user_feedback\""\n    ADD CONSTRAINT \""user_feedback_user_id_fkey\"" FOREIGN KEY (\""user_id\"") REFERENCES \""public\"".\""users\""(\""id\"") ON DELETE CASCADE"",""CREATE POLICY \""Anyone can read movement types\"" ON \""public\"".\""inventory_movement_types\"" FOR SELECT TO \""authenticated\"" USING (true)"",""CREATE POLICY \""Employees can view LPN items of their sites\"" ON \""public\"".\""inventory_lpn_items\"" FOR SELECT USING ((EXISTS ( SELECT 1\n   FROM (\""public\"".\""inventory_lpns\"" \""lpn\""\n     JOIN \""public\"".\""employee_sites\"" \""es\"" ON ((\""lpn\"".\""site_id\"" = \""es\"".\""site_id\"")))\n  WHERE ((\""lpn\"".\""id\"" = \""inventory_lpn_items\"".\""lpn_id\"") AND (\""es\"".\""employee_id\"" = \""auth\"".\""uid\""())))))"",""CREATE POLICY \""Employees can view LPNs of their sites\"" ON \""public\"".\""inventory_lpns\"" FOR SELECT USING ((\""site_id\"" IN ( SELECT \""es\"".\""site_id\""\n   FROM \""public\"".\""employee_sites\"" \""es\""\n  WHERE (\""es\"".\""employee_id\"" = \""auth\"".\""uid\""()))))"",""CREATE POLICY \""Employees can view all feedback\"" ON \""public\"".\""user_feedback\"" FOR SELECT TO \""authenticated\"" USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""employees\""\n  WHERE (\""employees\"".\""id\"" = \""auth\"".\""uid\""()))))"",""CREATE POLICY \""Employees can view locations of their sites\"" ON \""public\"".\""inventory_locations\"" FOR SELECT USING ((\""site_id\"" IN ( SELECT \""es\"".\""site_id\""\n   FROM \""public\"".\""employee_sites\"" \""es\""\n  WHERE (\""es\"".\""employee_id\"" = \""auth\"".\""uid\""()))))"",""CREATE POLICY \""Owners and managers can manage locations\"" ON \""public\"".\""inventory_locations\"" USING ((EXISTS ( SELECT 1\n   FROM (\""public\"".\""employees\"" \""e\""\n     JOIN \""public\"".\""employee_sites\"" \""es\"" ON ((\""e\"".\""id\"" = \""es\"".\""employee_id\"")))\n  WHERE ((\""e\"".\""id\"" = \""auth\"".\""uid\""()) AND (\""es\"".\""site_id\"" = \""inventory_locations\"".\""site_id\"") AND (\""e\"".\""role\"" = ANY (ARRAY['owner'::\""text\"", 'manager'::\""text\"", 'admin'::\""text\""]))))))"",""CREATE POLICY \""Owners can update feedback\"" ON \""public\"".\""user_feedback\"" FOR UPDATE TO \""authenticated\"" USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""employees\""\n  WHERE ((\""employees\"".\""id\"" = \""auth\"".\""uid\""()) AND (\""employees\"".\""role\"" = 'owner'::\""text\"")))))"",""CREATE POLICY \""Staff can manage LPN items\"" ON \""public\"".\""inventory_lpn_items\"" USING ((EXISTS ( SELECT 1\n   FROM ((\""public\"".\""inventory_lpns\"" \""lpn\""\n     JOIN \""public\"".\""employees\"" \""e\"" ON ((\""e\"".\""id\"" = \""auth\"".\""uid\""())))\n     JOIN \""public\"".\""employee_sites\"" \""es\"" ON (((\""e\"".\""id\"" = \""es\"".\""employee_id\"") AND (\""lpn\"".\""site_id\"" = \""es\"".\""site_id\""))))\n  WHERE (\""lpn\"".\""id\"" = \""inventory_lpn_items\"".\""lpn_id\""))))"",""CREATE POLICY \""Staff can manage LPNs\"" ON \""public\"".\""inventory_lpns\"" USING ((EXISTS ( SELECT 1\n   FROM (\""public\"".\""employees\"" \""e\""\n     JOIN \""public\"".\""employee_sites\"" \""es\"" ON ((\""e\"".\""id\"" = \""es\"".\""employee_id\"")))\n  WHERE ((\""e\"".\""id\"" = \""auth\"".\""uid\""()) AND (\""es\"".\""site_id\"" = \""inventory_lpns\"".\""site_id\"")))))"",""CREATE POLICY \""Users can delete their own favorites\"" ON \""public\"".\""user_favorites\"" FOR DELETE USING ((\""auth\"".\""uid\""() = \""user_id\""))"",""CREATE POLICY \""Users can insert their own favorites\"" ON \""public\"".\""user_favorites\"" FOR INSERT WITH CHECK ((\""auth\"".\""uid\""() = \""user_id\""))"",""CREATE POLICY \""Users can insert their own feedback\"" ON \""public\"".\""user_feedback\"" FOR INSERT TO \""authenticated\"" WITH CHECK ((\""auth\"".\""uid\""() = \""user_id\""))"",""CREATE POLICY \""Users can insert their own redemptions\"" ON \""public\"".\""loyalty_redemptions\"" FOR INSERT TO \""authenticated\"" WITH CHECK ((\""auth\"".\""uid\""() = \""user_id\""))"",""CREATE POLICY \""Users can insert their own transactions\"" ON \""public\"".\""loyalty_transactions\"" FOR INSERT TO \""authenticated\"" WITH CHECK ((\""auth\"".\""uid\""() = \""user_id\""))"",""CREATE POLICY \""Users can view their own favorites\"" ON \""public\"".\""user_favorites\"" FOR SELECT USING ((\""auth\"".\""uid\""() = \""user_id\""))"",""CREATE POLICY \""Users can view their own feedback\"" ON \""public\"".\""user_feedback\"" FOR SELECT TO \""authenticated\"" USING ((\""auth\"".\""uid\""() = \""user_id\""))"",""ALTER TABLE \""public\"".\""areas\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""areas_select_staff\"" ON \""public\"".\""areas\"" FOR SELECT USING ((\""public\"".\""can_access_area\""(\""id\"") OR ((\""public\"".\""current_employee_role\""() = ANY (ARRAY['manager'::\""text\"", 'logistics'::\""text\""])) AND \""public\"".\""can_access_site\""(\""site_id\""))))"",""CREATE POLICY \""areas_write_owner\"" ON \""public\"".\""areas\"" USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""())) WITH CHECK ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""ALTER TABLE \""public\"".\""attendance_logs\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""attendance_logs_insert_self\"" ON \""public\"".\""attendance_logs\"" FOR INSERT TO \""authenticated\"" WITH CHECK ((\""employee_id\"" = \""auth\"".\""uid\""()))"",""CREATE POLICY \""attendance_logs_select_manager\"" ON \""public\"".\""attendance_logs\"" FOR SELECT TO \""authenticated\"" USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""employees\"" \""e\""\n  WHERE ((\""e\"".\""id\"" = \""auth\"".\""uid\""()) AND (\""e\"".\""role\"" = ANY (ARRAY['owner'::\""text\"", 'manager'::\""text\"", 'global_manager'::\""text\""])) AND ((\""e\"".\""role\"" = ANY (ARRAY['owner'::\""text\"", 'global_manager'::\""text\""])) OR (\""e\"".\""site_id\"" = \""attendance_logs\"".\""site_id\""))))))"",""CREATE POLICY \""attendance_logs_select_self\"" ON \""public\"".\""attendance_logs\"" FOR SELECT TO \""authenticated\"" USING ((\""employee_id\"" = \""auth\"".\""uid\""()))"",""ALTER TABLE \""public\"".\""cost_centers\"" ENABLE ROW LEVEL SECURITY"",""ALTER TABLE \""public\"".\""employee_areas\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""employee_areas_select_owner\"" ON \""public\"".\""employee_areas\"" FOR SELECT USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""CREATE POLICY \""employee_areas_select_self\"" ON \""public\"".\""employee_areas\"" FOR SELECT USING ((\""employee_id\"" = \""auth\"".\""uid\""()))"",""CREATE POLICY \""employee_areas_write_owner\"" ON \""public\"".\""employee_areas\"" USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""())) WITH CHECK ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""ALTER TABLE \""public\"".\""employee_settings\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""employee_settings_insert_self\"" ON \""public\"".\""employee_settings\"" FOR INSERT WITH CHECK (((\""employee_id\"" = \""auth\"".\""uid\""()) AND ((\""selected_site_id\"" IS NULL) OR \""public\"".\""can_access_site\""(\""selected_site_id\"")) AND ((\""selected_area_id\"" IS NULL) OR \""public\"".\""can_access_area\""(\""selected_area_id\""))))"",""CREATE POLICY \""employee_settings_select_owner\"" ON \""public\"".\""employee_settings\"" FOR SELECT USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""CREATE POLICY \""employee_settings_select_self\"" ON \""public\"".\""employee_settings\"" FOR SELECT USING ((\""employee_id\"" = \""auth\"".\""uid\""()))"",""CREATE POLICY \""employee_settings_update_self\"" ON \""public\"".\""employee_settings\"" FOR UPDATE USING ((\""employee_id\"" = \""auth\"".\""uid\""())) WITH CHECK (((\""employee_id\"" = \""auth\"".\""uid\""()) AND ((\""selected_site_id\"" IS NULL) OR \""public\"".\""can_access_site\""(\""selected_site_id\"")) AND ((\""selected_area_id\"" IS NULL) OR \""public\"".\""can_access_area\""(\""selected_area_id\""))))"",""ALTER TABLE \""public\"".\""employee_shifts\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""employee_shifts_select_manager\"" ON \""public\"".\""employee_shifts\"" FOR SELECT USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""employees\"" \""e\""\n  WHERE ((\""e\"".\""id\"" = \""auth\"".\""uid\""()) AND (\""e\"".\""role\"" = ANY (ARRAY['manager'::\""text\"", 'area_manager'::\""text\""])) AND (\""e\"".\""site_id\"" = \""employee_shifts\"".\""site_id\"")))))"",""CREATE POLICY \""employee_shifts_select_owner\"" ON \""public\"".\""employee_shifts\"" FOR SELECT USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""CREATE POLICY \""employee_shifts_select_self\"" ON \""public\"".\""employee_shifts\"" FOR SELECT USING ((\""employee_id\"" = \""auth\"".\""uid\""()))"",""CREATE POLICY \""employee_shifts_write_manager\"" ON \""public\"".\""employee_shifts\"" USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""employees\"" \""e\""\n  WHERE ((\""e\"".\""id\"" = \""auth\"".\""uid\""()) AND (\""e\"".\""role\"" = ANY (ARRAY['manager'::\""text\"", 'area_manager'::\""text\""])) AND (\""e\"".\""site_id\"" = \""employee_shifts\"".\""site_id\""))))) WITH CHECK ((EXISTS ( SELECT 1\n   FROM \""public\"".\""employees\"" \""e\""\n  WHERE ((\""e\"".\""id\"" = \""auth\"".\""uid\""()) AND (\""e\"".\""role\"" = ANY (ARRAY['manager'::\""text\"", 'area_manager'::\""text\""])) AND (\""e\"".\""site_id\"" = \""employee_shifts\"".\""site_id\"")))))"",""CREATE POLICY \""employee_shifts_write_owner\"" ON \""public\"".\""employee_shifts\"" USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""())) WITH CHECK ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""ALTER TABLE \""public\"".\""employee_sites\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""employee_sites_select_owner\"" ON \""public\"".\""employee_sites\"" FOR SELECT USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""CREATE POLICY \""employee_sites_select_self\"" ON \""public\"".\""employee_sites\"" FOR SELECT USING ((\""employee_id\"" = \""auth\"".\""uid\""()))"",""CREATE POLICY \""employee_sites_write_owner\"" ON \""public\"".\""employee_sites\"" USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""())) WITH CHECK ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""ALTER TABLE \""public\"".\""employees\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""employees_crud_purchase_orders\"" ON \""public\"".\""purchase_orders\"" TO \""authenticated\"" USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""employees\""\n  WHERE (\""employees\"".\""id\"" = \""auth\"".\""uid\""()))))"",""CREATE POLICY \""employees_crud_reception_items\"" ON \""public\"".\""procurement_reception_items\"" TO \""authenticated\"" USING (true)"",""CREATE POLICY \""employees_crud_receptions\"" ON \""public\"".\""procurement_receptions\"" TO \""authenticated\"" USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""employees\""\n  WHERE (\""employees\"".\""id\"" = \""auth\"".\""uid\""()))))"",""CREATE POLICY \""employees_read_agreed_prices\"" ON \""public\"".\""procurement_agreed_prices\"" FOR SELECT TO \""authenticated\"" USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""employees\""\n  WHERE (\""employees\"".\""id\"" = \""auth\"".\""uid\""()))))"",""CREATE POLICY \""employees_read_cost_centers\"" ON \""public\"".\""cost_centers\"" FOR SELECT TO \""authenticated\"" USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""employees\""\n  WHERE (\""employees\"".\""id\"" = \""auth\"".\""uid\""()))))"",""CREATE POLICY \""employees_read_suppliers\"" ON \""public\"".\""suppliers\"" FOR SELECT TO \""authenticated\"" USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""employees\""\n  WHERE (\""employees\"".\""id\"" = \""auth\"".\""uid\""()))))"",""CREATE POLICY \""employees_select_area\"" ON \""public\"".\""employees\"" FOR SELECT USING (((\""area_id\"" IS NOT NULL) AND \""public\"".\""can_access_area\""(\""area_id\"")))"",""CREATE POLICY \""employees_select_manager\"" ON \""public\"".\""employees\"" FOR SELECT USING (((\""public\"".\""is_manager_or_owner\""() OR (\""public\"".\""current_employee_role\""() = ANY (ARRAY['logistics'::\""text\""]))) AND \""public\"".\""can_access_site\""(\""site_id\"")))"",""CREATE POLICY \""employees_select_self\"" ON \""public\"".\""employees\"" FOR SELECT USING ((\""auth\"".\""uid\""() = \""id\""))"",""CREATE POLICY \""employees_write_owner\"" ON \""public\"".\""employees\"" USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""())) WITH CHECK ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""ALTER TABLE \""public\"".\""inventory_locations\"" ENABLE ROW LEVEL SECURITY"",""ALTER TABLE \""public\"".\""inventory_lpn_items\"" ENABLE ROW LEVEL SECURITY"",""ALTER TABLE \""public\"".\""inventory_lpns\"" ENABLE ROW LEVEL SECURITY"",""ALTER TABLE \""public\"".\""inventory_movement_types\"" ENABLE ROW LEVEL SECURITY"",""ALTER TABLE \""public\"".\""inventory_movements\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""inventory_movements_insert_roles\"" ON \""public\"".\""inventory_movements\"" FOR INSERT WITH CHECK (((\""public\"".\""current_employee_role\""() = ANY (ARRAY['owner'::\""text\"", 'manager'::\""text\"", 'cashier'::\""text\"", 'logistics'::\""text\""])) AND \""public\"".\""can_access_site\""(\""site_id\"")))"",""CREATE POLICY \""inventory_movements_select_site\"" ON \""public\"".\""inventory_movements\"" FOR SELECT USING ((\""public\"".\""is_employee\""() AND \""public\"".\""can_access_site\""(\""site_id\"")))"",""CREATE POLICY \""inventory_movements_update_owner\"" ON \""public\"".\""inventory_movements\"" FOR UPDATE USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""())) WITH CHECK ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""ALTER TABLE \""public\"".\""inventory_stock_by_site\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""inventory_stock_select_site\"" ON \""public\"".\""inventory_stock_by_site\"" FOR SELECT USING ((\""public\"".\""is_employee\""() AND \""public\"".\""can_access_site\""(\""site_id\"")))"",""CREATE POLICY \""inventory_stock_write_manager\"" ON \""public\"".\""inventory_stock_by_site\"" USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""() OR (\""public\"".\""is_manager\""() AND \""public\"".\""can_access_site\""(\""site_id\"")))) WITH CHECK ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""() OR (\""public\"".\""is_manager\""() AND \""public\"".\""can_access_site\""(\""site_id\""))))"",""ALTER TABLE \""public\"".\""loyalty_redemptions\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""loyalty_redemptions_select_cashier\"" ON \""public\"".\""loyalty_redemptions\"" FOR SELECT TO \""authenticated\"" USING ((EXISTS ( SELECT 1\n   FROM (\""public\"".\""employees\"" \""e\""\n     JOIN \""public\"".\""loyalty_rewards\"" \""r\"" ON ((\""r\"".\""id\"" = \""loyalty_redemptions\"".\""reward_id\"")))\n  WHERE ((\""e\"".\""id\"" = \""auth\"".\""uid\""()) AND (\""e\"".\""is_active\"" = true) AND (\""e\"".\""role\"" = ANY (ARRAY['owner'::\""text\"", 'manager'::\""text\"", 'cashier'::\""text\""])) AND ((\""e\"".\""site_id\"" = \""r\"".\""site_id\"") OR (EXISTS ( SELECT 1\n           FROM \""public\"".\""employee_sites\"" \""es\""\n          WHERE ((\""es\"".\""employee_id\"" = \""e\"".\""id\"") AND (\""es\"".\""is_active\"" = true) AND (\""es\"".\""site_id\"" = \""r\"".\""site_id\"")))))))))"",""CREATE POLICY \""loyalty_redemptions_select_own\"" ON \""public\"".\""loyalty_redemptions\"" FOR SELECT TO \""authenticated\"" USING ((\""user_id\"" = \""auth\"".\""uid\""()))"",""CREATE POLICY \""loyalty_redemptions_validate_cashier\"" ON \""public\"".\""loyalty_redemptions\"" FOR UPDATE TO \""authenticated\"" USING (((\""status\"" = 'pending'::\""text\"") AND (EXISTS ( SELECT 1\n   FROM (\""public\"".\""employees\"" \""e\""\n     JOIN \""public\"".\""loyalty_rewards\"" \""r\"" ON ((\""r\"".\""id\"" = \""loyalty_redemptions\"".\""reward_id\"")))\n  WHERE ((\""e\"".\""id\"" = \""auth\"".\""uid\""()) AND (\""e\"".\""is_active\"" = true) AND (\""e\"".\""role\"" = ANY (ARRAY['owner'::\""text\"", 'manager'::\""text\"", 'cashier'::\""text\""])) AND ((\""e\"".\""site_id\"" = \""r\"".\""site_id\"") OR (EXISTS ( SELECT 1\n           FROM \""public\"".\""employee_sites\"" \""es\""\n          WHERE ((\""es\"".\""employee_id\"" = \""e\"".\""id\"") AND (\""es\"".\""is_active\"" = true) AND (\""es\"".\""site_id\"" = \""r\"".\""site_id\"")))))))))) WITH CHECK (((\""status\"" = 'validated'::\""text\"") AND (EXISTS ( SELECT 1\n   FROM (\""public\"".\""employees\"" \""e\""\n     JOIN \""public\"".\""loyalty_rewards\"" \""r\"" ON ((\""r\"".\""id\"" = \""loyalty_redemptions\"".\""reward_id\"")))\n  WHERE ((\""e\"".\""id\"" = \""auth\"".\""uid\""()) AND (\""e\"".\""is_active\"" = true) AND (\""e\"".\""role\"" = ANY (ARRAY['owner'::\""text\"", 'manager'::\""text\"", 'cashier'::\""text\""])) AND ((\""e\"".\""site_id\"" = \""r\"".\""site_id\"") OR (EXISTS ( SELECT 1\n           FROM \""public\"".\""employee_sites\"" \""es\""\n          WHERE ((\""es\"".\""employee_id\"" = \""e\"".\""id\"") AND (\""es\"".\""is_active\"" = true) AND (\""es\"".\""site_id\"" = \""r\"".\""site_id\""))))))))))"",""ALTER TABLE \""public\"".\""loyalty_transactions\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""loyalty_transactions_select_own\"" ON \""public\"".\""loyalty_transactions\"" FOR SELECT TO \""authenticated\"" USING ((\""user_id\"" = \""auth\"".\""uid\""()))"",""ALTER TABLE \""public\"".\""order_items\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""order_items_delete_owner\"" ON \""public\"".\""order_items\"" FOR DELETE USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""CREATE POLICY \""order_items_insert_client\"" ON \""public\"".\""order_items\"" FOR INSERT WITH CHECK ((EXISTS ( SELECT 1\n   FROM \""public\"".\""orders\"" \""o\""\n  WHERE ((\""o\"".\""id\"" = \""order_items\"".\""order_id\"") AND (\""o\"".\""client_id\"" = \""auth\"".\""uid\""())))))"",""CREATE POLICY \""order_items_insert_staff\"" ON \""public\"".\""order_items\"" FOR INSERT WITH CHECK ((EXISTS ( SELECT 1\n   FROM \""public\"".\""orders\"" \""o\""\n  WHERE ((\""o\"".\""id\"" = \""order_items\"".\""order_id\"") AND \""public\"".\""is_employee\""() AND \""public\"".\""can_access_site\""(\""o\"".\""site_id\"")))))"",""CREATE POLICY \""order_items_select_client\"" ON \""public\"".\""order_items\"" FOR SELECT USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""orders\"" \""o\""\n  WHERE ((\""o\"".\""id\"" = \""order_items\"".\""order_id\"") AND (\""o\"".\""client_id\"" = \""auth\"".\""uid\""())))))"",""CREATE POLICY \""order_items_select_staff\"" ON \""public\"".\""order_items\"" FOR SELECT USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""orders\"" \""o\""\n  WHERE ((\""o\"".\""id\"" = \""order_items\"".\""order_id\"") AND \""public\"".\""is_employee\""() AND \""public\"".\""can_access_site\""(\""o\"".\""site_id\"")))))"",""CREATE POLICY \""order_items_update_staff\"" ON \""public\"".\""order_items\"" FOR UPDATE USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""orders\"" \""o\""\n  WHERE ((\""o\"".\""id\"" = \""order_items\"".\""order_id\"") AND \""public\"".\""is_employee\""() AND \""public\"".\""can_access_site\""(\""o\"".\""site_id\""))))) WITH CHECK ((EXISTS ( SELECT 1\n   FROM \""public\"".\""orders\"" \""o\""\n  WHERE ((\""o\"".\""id\"" = \""order_items\"".\""order_id\"") AND \""public\"".\""is_employee\""() AND \""public\"".\""can_access_site\""(\""o\"".\""site_id\"")))))"",""ALTER TABLE \""public\"".\""orders\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""orders_delete_owner\"" ON \""public\"".\""orders\"" FOR DELETE USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""CREATE POLICY \""orders_insert_client\"" ON \""public\"".\""orders\"" FOR INSERT WITH CHECK (((\""client_id\"" = \""auth\"".\""uid\""()) AND (\""source\"" = 'vento_pass'::\""text\"")))"",""CREATE POLICY \""orders_insert_staff\"" ON \""public\"".\""orders\"" FOR INSERT WITH CHECK ((\""public\"".\""is_employee\""() AND \""public\"".\""can_access_site\""(\""site_id\"")))"",""CREATE POLICY \""orders_select_client\"" ON \""public\"".\""orders\"" FOR SELECT USING ((\""client_id\"" = \""auth\"".\""uid\""()))"",""CREATE POLICY \""orders_select_staff\"" ON \""public\"".\""orders\"" FOR SELECT USING ((\""public\"".\""is_employee\""() AND \""public\"".\""can_access_site\""(\""site_id\"")))"",""CREATE POLICY \""orders_update_staff\"" ON \""public\"".\""orders\"" FOR UPDATE USING ((\""public\"".\""is_employee\""() AND \""public\"".\""can_access_site\""(\""site_id\""))) WITH CHECK ((\""public\"".\""is_employee\""() AND \""public\"".\""can_access_site\""(\""site_id\"")))"",""ALTER TABLE \""public\"".\""procurement_agreed_prices\"" ENABLE ROW LEVEL SECURITY"",""ALTER TABLE \""public\"".\""procurement_reception_items\"" ENABLE ROW LEVEL SECURITY"",""ALTER TABLE \""public\"".\""procurement_receptions\"" ENABLE ROW LEVEL SECURITY"",""ALTER TABLE \""public\"".\""product_categories\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""product_categories_select_client\"" ON \""public\"".\""product_categories\"" FOR SELECT USING (((EXISTS ( SELECT 1\n   FROM \""public\"".\""users\"" \""u\""\n  WHERE ((\""u\"".\""id\"" = \""auth\"".\""uid\""()) AND (\""u\"".\""is_client\"" = true)))) AND (\""is_active\"" = true)))"",""CREATE POLICY \""product_categories_select_staff\"" ON \""public\"".\""product_categories\"" FOR SELECT USING (\""public\"".\""is_employee\""())"",""CREATE POLICY \""product_categories_write_owner\"" ON \""public\"".\""product_categories\"" USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""())) WITH CHECK ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""ALTER TABLE \""public\"".\""product_inventory_profiles\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""product_inventory_profiles_select_staff\"" ON \""public\"".\""product_inventory_profiles\"" FOR SELECT USING (\""public\"".\""is_employee\""())"",""CREATE POLICY \""product_inventory_profiles_write_owner\"" ON \""public\"".\""product_inventory_profiles\"" USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""())) WITH CHECK ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""ALTER TABLE \""public\"".\""product_sku_aliases\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""product_sku_aliases_select_staff\"" ON \""public\"".\""product_sku_aliases\"" FOR SELECT TO \""authenticated\"" USING (\""public\"".\""is_employee\""())"",""ALTER TABLE \""public\"".\""product_sku_sequences\"" ENABLE ROW LEVEL SECURITY"",""ALTER TABLE \""public\"".\""product_suppliers\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""product_suppliers_select_staff\"" ON \""public\"".\""product_suppliers\"" FOR SELECT USING (\""public\"".\""is_employee\""())"",""CREATE POLICY \""product_suppliers_write_owner\"" ON \""public\"".\""product_suppliers\"" USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""())) WITH CHECK ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""ALTER TABLE \""public\"".\""production_batches\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""production_batches_select_staff\"" ON \""public\"".\""production_batches\"" FOR SELECT USING (\""public\"".\""is_employee\""())"",""CREATE POLICY \""production_batches_write_production\"" ON \""public\"".\""production_batches\"" USING (((\""public\"".\""current_employee_role\""() = ANY (ARRAY['owner'::\""text\"", 'manager'::\""text\"", 'barista'::\""text\"", 'chef'::\""text\"", 'cocinero'::\""text\"", 'panadero'::\""text\"", 'repostero'::\""text\"", 'pastelero'::\""text\""])) AND ((\""public\"".\""current_employee_role\""() = ANY (ARRAY['owner'::\""text\"", 'manager'::\""text\""])) OR (\""site_id\"" = \""public\"".\""current_employee_site_id\""())))) WITH CHECK (((\""public\"".\""current_employee_role\""() = ANY (ARRAY['owner'::\""text\"", 'manager'::\""text\"", 'barista'::\""text\"", 'chef'::\""text\"", 'cocinero'::\""text\"", 'panadero'::\""text\"", 'repostero'::\""text\"", 'pastelero'::\""text\""])) AND ((\""public\"".\""current_employee_role\""() = ANY (ARRAY['owner'::\""text\"", 'manager'::\""text\""])) OR (\""site_id\"" = \""public\"".\""current_employee_site_id\""()))))"",""ALTER TABLE \""public\"".\""production_request_items\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""production_request_items_insert_site\"" ON \""public\"".\""production_request_items\"" FOR INSERT WITH CHECK ((EXISTS ( SELECT 1\n   FROM \""public\"".\""production_requests\"" \""r\""\n  WHERE ((\""r\"".\""id\"" = \""production_request_items\"".\""request_id\"") AND \""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""r\"".\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""r\"".\""to_site_id\""))))))"",""CREATE POLICY \""production_request_items_select_site\"" ON \""public\"".\""production_request_items\"" FOR SELECT USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""production_requests\"" \""r\""\n  WHERE ((\""r\"".\""id\"" = \""production_request_items\"".\""request_id\"") AND \""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""r\"".\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""r\"".\""to_site_id\""))))))"",""CREATE POLICY \""production_request_items_update_site\"" ON \""public\"".\""production_request_items\"" FOR UPDATE USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""production_requests\"" \""r\""\n  WHERE ((\""r\"".\""id\"" = \""production_request_items\"".\""request_id\"") AND \""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""r\"".\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""r\"".\""to_site_id\"")))))) WITH CHECK ((EXISTS ( SELECT 1\n   FROM \""public\"".\""production_requests\"" \""r\""\n  WHERE ((\""r\"".\""id\"" = \""production_request_items\"".\""request_id\"") AND \""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""r\"".\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""r\"".\""to_site_id\""))))))"",""ALTER TABLE \""public\"".\""production_requests\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""production_requests_delete_owner\"" ON \""public\"".\""production_requests\"" FOR DELETE USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""CREATE POLICY \""production_requests_insert_site\"" ON \""public\"".\""production_requests\"" FOR INSERT WITH CHECK ((\""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""to_site_id\""))))"",""CREATE POLICY \""production_requests_select_site\"" ON \""public\"".\""production_requests\"" FOR SELECT USING ((\""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""to_site_id\""))))"",""CREATE POLICY \""production_requests_update_site\"" ON \""public\"".\""production_requests\"" FOR UPDATE USING ((\""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""to_site_id\"")))) WITH CHECK ((\""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""to_site_id\""))))"",""ALTER TABLE \""public\"".\""products\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""products_select_client\"" ON \""public\"".\""products\"" FOR SELECT USING (((EXISTS ( SELECT 1\n   FROM \""public\"".\""users\"" \""u\""\n  WHERE ((\""u\"".\""id\"" = \""auth\"".\""uid\""()) AND (\""u\"".\""is_client\"" = true)))) AND (\""is_active\"" = true) AND (\""product_type\"" = 'sale'::\""text\"")))"",""CREATE POLICY \""products_select_staff\"" ON \""public\"".\""products\"" FOR SELECT USING (\""public\"".\""is_employee\""())"",""CREATE POLICY \""products_write_owner\"" ON \""public\"".\""products\"" USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""())) WITH CHECK ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""ALTER TABLE \""public\"".\""purchase_orders\"" ENABLE ROW LEVEL SECURITY"",""ALTER TABLE \""public\"".\""recipe_cards\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""recipe_cards_select_staff\"" ON \""public\"".\""recipe_cards\"" FOR SELECT USING (\""public\"".\""can_access_recipe_scope\""(\""site_id\"", \""area_id\""))"",""CREATE POLICY \""recipe_cards_write_manager\"" ON \""public\"".\""recipe_cards\"" USING (((\""public\"".\""is_owner\""() OR \""public\"".\""is_manager\""()) AND \""public\"".\""can_access_recipe_scope\""(\""site_id\"", \""area_id\""))) WITH CHECK (((\""public\"".\""is_owner\""() OR \""public\"".\""is_manager\""()) AND \""public\"".\""can_access_recipe_scope\""(\""site_id\"", \""area_id\"")))"",""ALTER TABLE \""public\"".\""recipe_steps\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""recipe_steps_select_staff\"" ON \""public\"".\""recipe_steps\"" FOR SELECT USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""recipe_cards\"" \""rc\""\n  WHERE ((\""rc\"".\""id\"" = \""recipe_steps\"".\""recipe_card_id\"") AND \""public\"".\""can_access_recipe_scope\""(\""rc\"".\""site_id\"", \""rc\"".\""area_id\"")))))"",""CREATE POLICY \""recipe_steps_write_manager\"" ON \""public\"".\""recipe_steps\"" USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_manager\""())) WITH CHECK ((\""public\"".\""is_owner\""() OR \""public\"".\""is_manager\""()))"",""ALTER TABLE \""public\"".\""recipes\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""recipes_select_staff\"" ON \""public\"".\""recipes\"" FOR SELECT USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""recipe_cards\"" \""rc\""\n  WHERE ((\""rc\"".\""product_id\"" = \""recipes\"".\""product_id\"") AND \""public\"".\""can_access_recipe_scope\""(\""rc\"".\""site_id\"", \""rc\"".\""area_id\"")))))"",""CREATE POLICY \""recipes_write_manager\"" ON \""public\"".\""recipes\"" USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_manager\""())) WITH CHECK ((\""public\"".\""is_owner\""() OR \""public\"".\""is_manager\""()))"",""ALTER TABLE \""public\"".\""restock_request_items\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""restock_request_items_insert_site\"" ON \""public\"".\""restock_request_items\"" FOR INSERT WITH CHECK ((EXISTS ( SELECT 1\n   FROM \""public\"".\""restock_requests\"" \""r\""\n  WHERE ((\""r\"".\""id\"" = \""restock_request_items\"".\""request_id\"") AND \""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""r\"".\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""r\"".\""to_site_id\""))))))"",""CREATE POLICY \""restock_request_items_select_site\"" ON \""public\"".\""restock_request_items\"" FOR SELECT USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""restock_requests\"" \""r\""\n  WHERE ((\""r\"".\""id\"" = \""restock_request_items\"".\""request_id\"") AND \""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""r\"".\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""r\"".\""to_site_id\""))))))"",""CREATE POLICY \""restock_request_items_update_site\"" ON \""public\"".\""restock_request_items\"" FOR UPDATE USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""restock_requests\"" \""r\""\n  WHERE ((\""r\"".\""id\"" = \""restock_request_items\"".\""request_id\"") AND \""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""r\"".\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""r\"".\""to_site_id\"")))))) WITH CHECK ((EXISTS ( SELECT 1\n   FROM \""public\"".\""restock_requests\"" \""r\""\n  WHERE ((\""r\"".\""id\"" = \""restock_request_items\"".\""request_id\"") AND \""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""r\"".\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""r\"".\""to_site_id\""))))))"",""ALTER TABLE \""public\"".\""restock_requests\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""restock_requests_delete_owner\"" ON \""public\"".\""restock_requests\"" FOR DELETE USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""CREATE POLICY \""restock_requests_insert_site\"" ON \""public\"".\""restock_requests\"" FOR INSERT WITH CHECK ((\""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""to_site_id\""))))"",""CREATE POLICY \""restock_requests_select_site\"" ON \""public\"".\""restock_requests\"" FOR SELECT USING ((\""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""to_site_id\""))))"",""CREATE POLICY \""restock_requests_update_site\"" ON \""public\"".\""restock_requests\"" FOR UPDATE USING ((\""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""to_site_id\"")))) WITH CHECK ((\""public\"".\""is_employee\""() AND (\""public\"".\""can_access_site\""(\""from_site_id\"") OR \""public\"".\""can_access_site\""(\""to_site_id\""))))"",""ALTER TABLE \""public\"".\""sites\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""sites_select_public_vento_pass\"" ON \""public\"".\""sites\"" FOR SELECT TO \""authenticated\"", \""anon\"" USING (((\""is_active\"" = true) AND (\""is_public\"" = true)))"",""CREATE POLICY \""sites_select_staff\"" ON \""public\"".\""sites\"" FOR SELECT USING (\""public\"".\""can_access_site\""(\""id\""))"",""CREATE POLICY \""sites_write_owner\"" ON \""public\"".\""sites\"" USING ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""())) WITH CHECK ((\""public\"".\""is_owner\""() OR \""public\"".\""is_global_manager\""()))"",""CREATE POLICY \""staff_select_all_redemptions\"" ON \""public\"".\""loyalty_redemptions\"" FOR SELECT TO \""authenticated\"" USING (\""public\"".\""is_active_staff\""())"",""CREATE POLICY \""staff_select_all_users\"" ON \""public\"".\""users\"" FOR SELECT TO \""authenticated\"" USING (\""public\"".\""is_active_staff\""())"",""CREATE POLICY \""staff_validate_redemptions\"" ON \""public\"".\""loyalty_redemptions\"" FOR UPDATE TO \""authenticated\"" USING ((\""public\"".\""is_active_staff\""() AND (\""status\"" = 'pending'::\""text\""))) WITH CHECK ((\""public\"".\""is_active_staff\""() AND (\""status\"" = 'validated'::\""text\"")))"",""ALTER TABLE \""public\"".\""suppliers\"" ENABLE ROW LEVEL SECURITY"",""ALTER TABLE \""public\"".\""user_favorites\"" ENABLE ROW LEVEL SECURITY"",""ALTER TABLE \""public\"".\""user_feedback\"" ENABLE ROW LEVEL SECURITY"",""ALTER TABLE \""public\"".\""users\"" ENABLE ROW LEVEL SECURITY"",""CREATE POLICY \""users_insert_self\"" ON \""public\"".\""users\"" FOR INSERT TO \""authenticated\"" WITH CHECK ((\""id\"" = \""auth\"".\""uid\""()))"",""CREATE POLICY \""users_select_cashier\"" ON \""public\"".\""users\"" FOR SELECT TO \""authenticated\"" USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""employees\"" \""e\""\n  WHERE ((\""e\"".\""id\"" = \""auth\"".\""uid\""()) AND (\""e\"".\""is_active\"" = true) AND (\""e\"".\""role\"" = ANY (ARRAY['owner'::\""text\"", 'manager'::\""text\"", 'cashier'::\""text\""]))))))"",""CREATE POLICY \""users_select_cashier_for_qr\"" ON \""public\"".\""users\"" FOR SELECT TO \""authenticated\"" USING ((EXISTS ( SELECT 1\n   FROM \""public\"".\""employees\"" \""e\""\n  WHERE ((\""e\"".\""id\"" = \""auth\"".\""uid\""()) AND (\""e\"".\""is_active\"" = true) AND (\""e\"".\""role\"" = ANY (ARRAY['owner'::\""text\"", 'manager'::\""text\"", 'cashier'::\""text\""]))))))"",""CREATE POLICY \""users_select_self\"" ON \""public\"".\""users\"" FOR SELECT TO \""authenticated\"" USING ((\""id\"" = \""auth\"".\""uid\""()))"",""CREATE POLICY \""users_update_self\"" ON \""public\"".\""users\"" FOR UPDATE TO \""authenticated\"" USING ((\""id\"" = \""auth\"".\""uid\""())) WITH CHECK ((\""id\"" = \""auth\"".\""uid\""()))"",""GRANT USAGE ON SCHEMA \""public\"" TO \""postgres\"""",""GRANT USAGE ON SCHEMA \""public\"" TO \""anon\"""",""GRANT USAGE ON SCHEMA \""public\"" TO \""authenticated\"""",""GRANT USAGE ON SCHEMA \""public\"" TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""_set_updated_at\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""_set_updated_at\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""_set_updated_at\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""_vento_norm\""(\""input\"" \""text\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""_vento_norm\""(\""input\"" \""text\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""_vento_norm\""(\""input\"" \""text\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""_vento_slugify\""(\""input\"" \""text\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""_vento_slugify\""(\""input\"" \""text\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""_vento_slugify\""(\""input\"" \""text\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""_vento_uuid_from_text\""(\""input\"" \""text\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""_vento_uuid_from_text\""(\""input\"" \""text\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""_vento_uuid_from_text\""(\""input\"" \""text\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""can_access_area\""(\""p_area_id\"" \""uuid\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""can_access_area\""(\""p_area_id\"" \""uuid\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""can_access_area\""(\""p_area_id\"" \""uuid\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""can_access_recipe_scope\""(\""p_site_id\"" \""uuid\"", \""p_area_id\"" \""uuid\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""can_access_recipe_scope\""(\""p_site_id\"" \""uuid\"", \""p_area_id\"" \""uuid\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""can_access_recipe_scope\""(\""p_site_id\"" \""uuid\"", \""p_area_id\"" \""uuid\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""can_access_site\""(\""p_site_id\"" \""uuid\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""can_access_site\""(\""p_site_id\"" \""uuid\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""can_access_site\""(\""p_site_id\"" \""uuid\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_area_id\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_area_id\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_area_id\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_primary_site_id\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_primary_site_id\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_primary_site_id\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_role\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_role\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_role\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_selected_area_id\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_selected_area_id\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_selected_area_id\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_selected_site_id\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_selected_site_id\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_selected_site_id\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_site_id\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_site_id\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""current_employee_site_id\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""device_info_has_blocking_warnings\""(\""di\"" \""jsonb\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""device_info_has_blocking_warnings\""(\""di\"" \""jsonb\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""device_info_has_blocking_warnings\""(\""di\"" \""jsonb\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""enforce_attendance_geofence\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""enforce_attendance_geofence\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""enforce_attendance_geofence\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""enforce_attendance_sequence\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""enforce_attendance_sequence\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""enforce_attendance_sequence\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""enforce_employee_role_site\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""enforce_employee_role_site\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""enforce_employee_role_site\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""generate_location_code\""(\""p_site_code\"" \""text\"", \""p_zone\"" \""text\"", \""p_aisle\"" \""text\"", \""p_level\"" \""text\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""generate_location_code\""(\""p_site_code\"" \""text\"", \""p_zone\"" \""text\"", \""p_aisle\"" \""text\"", \""p_level\"" \""text\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""generate_location_code\""(\""p_site_code\"" \""text\"", \""p_zone\"" \""text\"", \""p_aisle\"" \""text\"", \""p_level\"" \""text\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""generate_lpn_code\""(\""p_site_code\"" \""text\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""generate_lpn_code\""(\""p_site_code\"" \""text\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""generate_lpn_code\""(\""p_site_code\"" \""text\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""generate_product_sku\""(\""p_product_type\"" \""text\"", \""p_site_id\"" \""uuid\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""generate_product_sku\""(\""p_product_type\"" \""text\"", \""p_site_id\"" \""uuid\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""generate_product_sku\""(\""p_product_type\"" \""text\"", \""p_site_id\"" \""uuid\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""grant_loyalty_points\""(\""p_user_id\"" \""uuid\"", \""p_points\"" integer, \""p_description\"" \""text\"", \""p_metadata\"" \""jsonb\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""grant_loyalty_points\""(\""p_user_id\"" \""uuid\"", \""p_points\"" integer, \""p_description\"" \""text\"", \""p_metadata\"" \""jsonb\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""grant_loyalty_points\""(\""p_user_id\"" \""uuid\"", \""p_points\"" integer, \""p_description\"" \""text\"", \""p_metadata\"" \""jsonb\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""handle_new_user\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""handle_new_user\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""handle_new_user\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""haversine_m\""(\""lat1\"" numeric, \""lon1\"" numeric, \""lat2\"" numeric, \""lon2\"" numeric) TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""haversine_m\""(\""lat1\"" numeric, \""lon1\"" numeric, \""lat2\"" numeric, \""lon2\"" numeric) TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""haversine_m\""(\""lat1\"" numeric, \""lon1\"" numeric, \""lat2\"" numeric, \""lon2\"" numeric) TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_active_staff\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_active_staff\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_active_staff\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_employee\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_employee\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_employee\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_global_manager\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_global_manager\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_global_manager\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_manager\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_manager\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_manager\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_manager_or_owner\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_manager_or_owner\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_manager_or_owner\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_owner\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_owner\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""is_owner\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""process_loyalty_earning\""(\""p_order_id\"" \""uuid\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""process_loyalty_earning\""(\""p_order_id\"" \""uuid\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""process_loyalty_earning\""(\""p_order_id\"" \""uuid\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""process_order_payment\""(\""p_order_id\"" \""uuid\"", \""p_site_id\"" \""uuid\"", \""p_payment_method\"" \""text\"", \""p_payment_reference\"" \""text\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""process_order_payment\""(\""p_order_id\"" \""uuid\"", \""p_site_id\"" \""uuid\"", \""p_payment_method\"" \""text\"", \""p_payment_reference\"" \""text\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""process_order_payment\""(\""p_order_id\"" \""uuid\"", \""p_site_id\"" \""uuid\"", \""p_payment_method\"" \""text\"", \""p_payment_reference\"" \""text\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""receive_purchase_order\""(\""p_purchase_order_id\"" \""uuid\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""receive_purchase_order\""(\""p_purchase_order_id\"" \""uuid\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""receive_purchase_order\""(\""p_purchase_order_id\"" \""uuid\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""resolve_product_sku_brand_code\""(\""p_site_id\"" \""uuid\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""resolve_product_sku_brand_code\""(\""p_site_id\"" \""uuid\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""resolve_product_sku_brand_code\""(\""p_site_id\"" \""uuid\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""resolve_product_sku_type_code\""(\""p_product_type\"" \""text\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""resolve_product_sku_type_code\""(\""p_product_type\"" \""text\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""resolve_product_sku_type_code\""(\""p_product_type\"" \""text\"") TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""set_product_sku\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""set_product_sku\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""set_product_sku\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""tg_set_updated_at\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""tg_set_updated_at\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""tg_set_updated_at\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""update_employee_shifts_updated_at\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""update_employee_shifts_updated_at\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""update_employee_shifts_updated_at\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""update_loyalty_balance\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""update_loyalty_balance\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""update_loyalty_balance\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""update_updated_at\""() TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""update_updated_at\""() TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""update_updated_at\""() TO \""service_role\"""",""GRANT ALL ON FUNCTION \""public\"".\""util_column_usage\""(\""p_table\"" \""regclass\"") TO \""anon\"""",""GRANT ALL ON FUNCTION \""public\"".\""util_column_usage\""(\""p_table\"" \""regclass\"") TO \""authenticated\"""",""GRANT ALL ON FUNCTION \""public\"".\""util_column_usage\""(\""p_table\"" \""regclass\"") TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""_backup_inventory_movements_initial_count\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""_backup_inventory_movements_initial_count\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""_backup_inventory_movements_initial_count\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""areas\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""areas\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""areas\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""asistencia_logs\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""asistencia_logs\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""attendance_logs\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""attendance_logs\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""attendance_logs\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""cost_centers\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""cost_centers\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""cost_centers\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""employee_areas\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""employee_areas\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""employee_areas\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""employee_attendance_status\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""employee_attendance_status\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""employee_attendance_status\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""employee_settings\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""employee_settings\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""employee_settings\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""employee_shifts\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""employee_shifts\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""employee_shifts\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""employee_sites\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""employee_sites\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""employee_sites\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""employees\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""employees\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""employees\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_locations\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_locations\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_locations\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_lpn_items\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_lpn_items\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_lpn_items\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_lpns\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_lpns\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_lpns\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_movement_types\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_movement_types\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_movement_types\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_movements\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_movements\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_movements\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""products\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""products\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""products\"" TO \""service_role\"""",""GRANT SELECT,MAINTAIN ON TABLE \""public\"".\""sites\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""sites\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""sites\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_stock_by_location\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_stock_by_location\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_stock_by_location\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_stock_by_site\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_stock_by_site\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""inventory_stock_by_site\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""loyalty_redemptions\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""loyalty_redemptions\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""loyalty_redemptions\"" TO \""service_role\"""",""GRANT SELECT,MAINTAIN ON TABLE \""public\"".\""loyalty_rewards\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""loyalty_rewards\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""loyalty_rewards\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""loyalty_transactions\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""loyalty_transactions\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""loyalty_transactions\"" TO \""service_role\"""",""GRANT ALL ON SEQUENCE \""public\"".\""lpn_sequence\"" TO \""anon\"""",""GRANT ALL ON SEQUENCE \""public\"".\""lpn_sequence\"" TO \""authenticated\"""",""GRANT ALL ON SEQUENCE \""public\"".\""lpn_sequence\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""order_items\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""order_items\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""order_items\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""orders\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""orders\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""orders\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""pos_cash_movements\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""pos_cash_movements\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""pos_cash_shifts\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""pos_cash_shifts\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""pos_modifier_options\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""pos_modifier_options\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""pos_modifiers\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""pos_modifiers\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""pos_order_item_modifiers\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""pos_order_item_modifiers\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""pos_payments\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""pos_payments\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""pos_product_modifiers\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""pos_product_modifiers\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""pos_session_orders\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""pos_session_orders\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""pos_sessions\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""pos_sessions\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""pos_tables\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""pos_tables\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""pos_zones\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""pos_zones\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""procurement_agreed_prices\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""procurement_agreed_prices\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""procurement_agreed_prices\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""procurement_reception_items\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""procurement_reception_items\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""procurement_reception_items\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""procurement_receptions\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""procurement_receptions\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""procurement_receptions\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""product_categories\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""product_categories\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""product_categories\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""product_inventory_profiles\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""product_inventory_profiles\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""product_inventory_profiles\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""product_sku_aliases\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""product_sku_aliases\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""product_sku_aliases\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""product_sku_sequences\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""product_sku_sequences\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""product_sku_sequences\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""product_suppliers\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""product_suppliers\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""product_suppliers\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""production_batches\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""production_batches\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""production_batches\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""production_request_items\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""production_request_items\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""production_request_items\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""production_requests\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""production_requests\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""production_requests\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""purchase_order_items\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""purchase_order_items\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""purchase_orders\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""purchase_orders\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""purchase_orders\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""recipe_cards\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""recipe_cards\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""recipe_cards\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""recipe_steps\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""recipe_steps\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""recipe_steps\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""recipes\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""recipes\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""recipes\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""restock_request_items\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""restock_request_items\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""restock_request_items\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""restock_requests\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""restock_requests\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""restock_requests\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""shift_calendar_view\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""shift_calendar_view\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""shift_calendar_view\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""staff_invitations\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""staff_invitations\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""staging_insumos_import\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""staging_insumos_import\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""suppliers\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""suppliers\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""suppliers\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""user_favorites\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""user_favorites\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""user_favorites\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""user_feedback\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""user_feedback\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""user_feedback\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""users\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""users\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""users\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""v_inventory_catalog\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""v_inventory_catalog\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""v_inventory_catalog\"" TO \""service_role\"""",""GRANT ALL ON TABLE \""public\"".\""v_procurement_price_book\"" TO \""anon\"""",""GRANT ALL ON TABLE \""public\"".\""v_procurement_price_book\"" TO \""authenticated\"""",""GRANT ALL ON TABLE \""public\"".\""v_procurement_price_book\"" TO \""service_role\"""",""ALTER DEFAULT PRIVILEGES FOR ROLE \""postgres\"" IN SCHEMA \""public\"" GRANT ALL ON SEQUENCES TO \""postgres\"""",""ALTER DEFAULT PRIVILEGES FOR ROLE \""postgres\"" IN SCHEMA \""public\"" GRANT ALL ON SEQUENCES TO \""anon\"""",""ALTER DEFAULT PRIVILEGES FOR ROLE \""postgres\"" IN SCHEMA \""public\"" GRANT ALL ON SEQUENCES TO \""authenticated\"""",""ALTER DEFAULT PRIVILEGES FOR ROLE \""postgres\"" IN SCHEMA \""public\"" GRANT ALL ON SEQUENCES TO \""service_role\"""",""ALTER DEFAULT PRIVILEGES FOR ROLE \""postgres\"" IN SCHEMA \""public\"" GRANT ALL ON FUNCTIONS TO \""postgres\"""",""ALTER DEFAULT PRIVILEGES FOR ROLE \""postgres\"" IN SCHEMA \""public\"" GRANT ALL ON FUNCTIONS TO \""anon\"""",""ALTER DEFAULT PRIVILEGES FOR ROLE \""postgres\"" IN SCHEMA \""public\"" GRANT ALL ON FUNCTIONS TO \""authenticated\"""",""ALTER DEFAULT PRIVILEGES FOR ROLE \""postgres\"" IN SCHEMA \""public\"" GRANT ALL ON FUNCTIONS TO \""service_role\"""",""ALTER DEFAULT PRIVILEGES FOR ROLE \""postgres\"" IN SCHEMA \""public\"" GRANT ALL ON TABLES TO \""postgres\"""",""ALTER DEFAULT PRIVILEGES FOR ROLE \""postgres\"" IN SCHEMA \""public\"" GRANT ALL ON TABLES TO \""anon\"""",""ALTER DEFAULT PRIVILEGES FOR ROLE \""postgres\"" IN SCHEMA \""public\"" GRANT ALL ON TABLES TO \""authenticated\"""",""ALTER DEFAULT PRIVILEGES FOR ROLE \""postgres\"" IN SCHEMA \""public\"" GRANT ALL ON TABLES TO \""service_role\""""]",baseline
20260117130000,"[""-- Core permissions model for Vento OS (roles, apps, permissions, scopes).\n\n-- Permission scopes\ndo $$\nbegin\n  if not exists (select 1 from pg_type where typname = 'permission_scope_type') then\n    create type public.permission_scope_type as enum (\n      'global',\n      'site',\n      'site_type',\n      'area',\n      'area_kind'\n    );\n  end if;\nend$$"",""-- Area kinds catalog\ncreate table if not exists public.area_kinds (\n  code text primary key,\n  name text not null,\n  description text,\n  is_active boolean not null default true,\n  created_at timestamptz not null default now(),\n  updated_at timestamptz not null default now()\n)"",""comment on table public.area_kinds is 'Catalogo canonico de tipos de area para produccion y remisiones.'"",""insert into public.area_kinds (code, name, description) values\n  ('contabilidad', 'Contabilidad', 'Contabilidad y finanzas'),\n  ('panaderia', 'Panaderia', 'Panaderia'),\n  ('bar', 'Bar', 'Bar y bebidas'),\n  ('cocina_bar', 'Cocina Bar', 'Cocina de bar'),\n  ('caja', 'Caja', 'Caja'),\n  ('mostrador', 'Mostrador', 'Mostrador'),\n  ('general', 'General', 'Area generica'),\n  ('cocina', 'Cocina', 'Cocina'),\n  ('cocina_caliente', 'Cocina Caliente', 'Cocina caliente'),\n  ('liderazgo', 'Liderazgo', 'Liderazgo'),\n  ('logistica', 'Logistica', 'Logistica'),\n  ('gerencia', 'Gerencia', 'Gerencia'),\n  ('marketing', 'Marketing', 'Marketing'),\n  ('reposteria', 'Reposteria', 'Reposteria/Pasteleria'),\n  ('salon', 'Salon', 'Salon y servicio'),\n  ('bodega', 'Bodega', 'Bodega y almacenamiento')\non conflict (code) do nothing"",""-- Normalize areas.kind\nupdate public.areas\nset kind = case\n  when kind is null or btrim(kind) = '' then 'general'\n  when replace(public._vento_slugify(kind), '-', '_') in (\n    'contabilidad','panaderia','bar','cocina_bar','caja','mostrador','general','cocina','cocina_caliente',\n    'liderazgo','logistica','gerencia','marketing','reposteria','salon','bodega'\n  ) then replace(public._vento_slugify(kind), '-', '_')\n  when replace(public._vento_slugify(kind), '-', '_') in ('accounting','contador') then 'contabilidad'\n  when replace(public._vento_slugify(kind), '-', '_') in ('bakery','baker','panaderia') then 'panaderia'\n  when replace(public._vento_slugify(kind), '-', '_') in ('bar_kitchen','kitchen_bar','cocina_bar') then 'cocina_bar'\n  when replace(public._vento_slugify(kind), '-', '_') in ('kitchen_hot','hot_kitchen','cocina_caliente') then 'cocina_caliente'\n  when replace(public._vento_slugify(kind), '-', '_') in ('kitchen','cocina') then 'cocina'\n  when replace(public._vento_slugify(kind), '-', '_') in ('pastry','pasteleria','reposteria') then 'reposteria'\n  when replace(public._vento_slugify(kind), '-', '_') in ('warehouse','storage','almacen','bodega') then 'bodega'\n  when replace(public._vento_slugify(kind), '-', '_') in ('cashier','caja') then 'caja'\n  when replace(public._vento_slugify(kind), '-', '_') in ('counter','mostrador') then 'mostrador'\n  when replace(public._vento_slugify(kind), '-', '_') in ('bar','barra') then 'bar'\n  when replace(public._vento_slugify(kind), '-', '_') in ('marketing','mercadeo') then 'marketing'\n  when replace(public._vento_slugify(kind), '-', '_') in ('logistics','logistica') then 'logistica'\n  when replace(public._vento_slugify(kind), '-', '_') in ('management','gerencia','gestion') then 'gerencia'\n  when replace(public._vento_slugify(kind), '-', '_') in ('leadership','liderazgo') then 'liderazgo'\n  when replace(public._vento_slugify(kind), '-', '_') in ('salon','dining','floor') then 'salon'\n  else 'general'\nend"",""alter table public.areas\n  drop constraint if exists areas_kind_fkey"",""alter table public.areas\n  add constraint areas_kind_fkey\n  foreign key (kind) references public.area_kinds(code)"",""-- Production area kind on products and requests\nalter table public.products\n  add column if not exists production_area_kind text"",""alter table public.products\n  alter column production_area_kind set default 'general'"",""update public.products\nset production_area_kind = coalesce(production_area_kind, 'general')"",""alter table public.products\n  drop constraint if exists products_production_area_kind_fkey"",""alter table public.products\n  add constraint products_production_area_kind_fkey\n  foreign key (production_area_kind) references public.area_kinds(code)"",""alter table public.production_request_items\n  add column if not exists production_area_kind text"",""alter table public.production_request_items\n  alter column production_area_kind set default 'general'"",""update public.production_request_items pri\nset production_area_kind = coalesce(pri.production_area_kind, p.production_area_kind, 'general')\nfrom public.products p\nwhere pri.product_id = p.id"",""update public.production_request_items\nset production_area_kind = 'general'\nwhere production_area_kind is null"",""alter table public.production_request_items\n  drop constraint if exists production_request_items_area_kind_fkey"",""alter table public.production_request_items\n  add constraint production_request_items_area_kind_fkey\n  foreign key (production_area_kind) references public.area_kinds(code)"",""alter table public.restock_request_items\n  add column if not exists production_area_kind text"",""alter table public.restock_request_items\n  alter column production_area_kind set default 'general'"",""update public.restock_request_items rri\nset production_area_kind = coalesce(rri.production_area_kind, p.production_area_kind, 'general')\nfrom public.products p\nwhere rri.product_id = p.id"",""update public.restock_request_items\nset production_area_kind = 'general'\nwhere production_area_kind is null"",""alter table public.restock_request_items\n  drop constraint if exists restock_request_items_area_kind_fkey"",""alter table public.restock_request_items\n  add constraint restock_request_items_area_kind_fkey\n  foreign key (production_area_kind) references public.area_kinds(code)"",""-- Roles catalog\ncreate table if not exists public.roles (\n  code text primary key,\n  name text not null,\n  description text,\n  is_active boolean not null default true,\n  created_at timestamptz not null default now(),\n  updated_at timestamptz not null default now()\n)"",""comment on table public.roles is 'Catalogo canonico de roles de staff.'"",""insert into public.roles (code, name, description) values\n  ('propietario', 'Propietario', 'Dueno y gerente general'),\n  ('gerente_general', 'Gerente General', 'Gerencia global multi-sede'),\n  ('gerente', 'Gerente', 'Gerente de sede'),\n  ('bodeguero', 'Bodeguero', 'Bodega e inventario'),\n  ('conductor', 'Conductor', 'Transporte y remisiones'),\n  ('cajero', 'Cajero', 'Caja y cobros'),\n  ('mesero', 'Mesero', 'Servicio en sala'),\n  ('barista', 'Barista', 'Barista'),\n  ('cocinero', 'Cocinero', 'Cocina'),\n  ('panadero', 'Panadero', 'Panaderia'),\n  ('repostero', 'Repostero', 'Reposteria'),\n  ('pastelero', 'Pastelero', 'Pasteleria'),\n  ('contador', 'Contador', 'Finanzas y contabilidad'),\n  ('marketing', 'Marketing', 'Marketing y growth')\non conflict (code) do nothing"",""-- Temporarily remove legacy role enforcement trigger to allow normalization\ndrop trigger if exists trg_enforce_employee_role_site on public.employees"",""-- Remove legacy role check before normalization\nalter table public.employees\n  drop constraint if exists employees_role_check"",""-- Normalize legacy roles (employees)\nwith normalized as (\n  select id, replace(public._vento_slugify(role), '-', '_') as slug\n  from public.employees\n)\nupdate public.employees e\nset role = case\n  when n.slug in ('propietario', 'owner') then 'propietario'\n  when n.slug in ('gerente_general', 'global_manager') then 'gerente_general'\n  when n.slug in ('gerente', 'manager', 'admin', 'area_manager') then 'gerente'\n  when n.slug in ('bodeguero', 'logistics', 'warehouse', 'bodega', 'almacen') then 'bodeguero'\n  when n.slug in ('conductor', 'driver') then 'conductor'\n  when n.slug in ('cajero', 'cashier') then 'cajero'\n  when n.slug in ('mesero', 'mesera', 'waiter', 'staff', 'personal') then 'mesero'\n  when n.slug in ('barista') then 'barista'\n  when n.slug in ('cocinero', 'cocinera', 'cook', 'chef') then 'cocinero'\n  when n.slug in ('panadero', 'panadera', 'baker') then 'panadero'\n  when n.slug in ('repostero', 'repostera', 'pastry') then 'repostero'\n  when n.slug in ('pastelero', 'pastelera') then 'pastelero'\n  when n.slug in ('contador', 'accountant') then 'contador'\n  when n.slug in ('marketing', 'mercadeo') then 'marketing'\n  else e.role\nend\nfrom normalized n\nwhere e.id = n.id"",""-- Normalize legacy roles (staff_invitations)\nwith normalized as (\n  select id, replace(public._vento_slugify(staff_role), '-', '_') as slug\n  from public.staff_invitations\n  where staff_role is not null\n)\nupdate public.staff_invitations s\nset staff_role = case\n  when n.slug in ('propietario', 'owner') then 'propietario'\n  when n.slug in ('gerente_general', 'global_manager') then 'gerente_general'\n  when n.slug in ('gerente', 'manager', 'admin', 'area_manager') then 'gerente'\n  when n.slug in ('bodeguero', 'logistics', 'warehouse', 'bodega', 'almacen') then 'bodeguero'\n  when n.slug in ('conductor', 'driver') then 'conductor'\n  when n.slug in ('cajero', 'cashier') then 'cajero'\n  when n.slug in ('mesero', 'mesera', 'waiter', 'staff', 'personal') then 'mesero'\n  when n.slug in ('barista') then 'barista'\n  when n.slug in ('cocinero', 'cocinera', 'cook', 'chef') then 'cocinero'\n  when n.slug in ('panadero', 'panadera', 'baker') then 'panadero'\n  when n.slug in ('repostero', 'repostera', 'pastry') then 'repostero'\n  when n.slug in ('pastelero', 'pastelera') then 'pastelero'\n  when n.slug in ('contador', 'accountant') then 'contador'\n  when n.slug in ('marketing', 'mercadeo') then 'marketing'\n  else s.staff_role\nend\nfrom normalized n\nwhere s.id = n.id"",""do $$\ndeclare\n  v_invalid text;\nbegin\n  select string_agg(distinct role, ', ') into v_invalid\n  from public.employees\n  where role is not null\n    and role not in (select code from public.roles);\n\n  if v_invalid is not null then\n    raise exception 'Roles invalidos en employees: %', v_invalid;\n  end if;\nend$$"",""do $$\ndeclare\n  v_invalid text;\nbegin\n  select string_agg(distinct staff_role, ', ') into v_invalid\n  from public.staff_invitations\n  where staff_role is not null\n    and staff_role not in (select code from public.roles);\n\n  if v_invalid is not null then\n    raise exception 'Roles invalidos en staff_invitations: %', v_invalid;\n  end if;\nend$$"",""-- Enforce roles via FK instead of CHECK constraint\nalter table public.employees\n  drop constraint if exists employees_role_fkey"",""alter table public.employees\n  add constraint employees_role_fkey\n  foreign key (role) references public.roles(code)"",""alter table public.staff_invitations\n  drop constraint if exists staff_invitations_role_fkey"",""alter table public.staff_invitations\n  add constraint staff_invitations_role_fkey\n  foreign key (staff_role) references public.roles(code)"",""-- Temporarily remove legacy role enforcement trigger to allow normalization\ndrop trigger if exists trg_enforce_employee_role_site on public.employees"",""-- Update role helper functions to new codes\ncreate or replace function public.is_owner() returns boolean\nlanguage sql stable security definer\nset search_path to 'public'\nas $$\n  select public.current_employee_role() = 'propietario';\n$$"",""create or replace function public.is_global_manager() returns boolean\nlanguage sql stable security definer\nset search_path to 'public'\nas $$\n  select public.current_employee_role() = 'gerente_general';\n$$"",""create or replace function public.is_manager() returns boolean\nlanguage sql stable security definer\nset search_path to 'public'\nas $$\n  select public.current_employee_role() = 'gerente';\n$$"",""create or replace function public.is_manager_or_owner() returns boolean\nlanguage sql stable security definer\nset search_path to 'public'\nas $$\n  select public.current_employee_role() in ('propietario', 'gerente', 'gerente_general');\n$$"",""create or replace function public.can_access_recipe_scope(p_site_id uuid, p_area_id uuid) returns boolean\nlanguage sql stable security definer\nset search_path to 'public'\nas $$\n  select\n    public.is_owner()\n    or public.is_global_manager()\n    or (\n      public.current_employee_role() = any (array['gerente'::text, 'bodeguero'::text])\n      and p_site_id is not null\n      and public.can_access_site(p_site_id)\n    )\n    or (\n      public.is_employee()\n      and p_site_id is not null\n      and p_area_id is not null\n      and public.can_access_site(p_site_id)\n      and public.can_access_area(p_area_id)\n    );\n$$"",""-- Allowed roles by site_type (replaces hardcoded lists)\ncreate table if not exists public.role_site_type_rules (\n  role text not null references public.roles(code) on delete cascade,\n  site_type public.site_type not null,\n  is_allowed boolean not null default true,\n  created_at timestamptz not null default now(),\n  primary key (role, site_type)\n)"",""insert into public.role_site_type_rules (role, site_type) values\n  ('propietario', 'admin'),\n  ('gerente_general', 'admin'),\n  ('gerente', 'admin'),\n  ('contador', 'admin'),\n  ('marketing', 'admin'),\n  ('propietario', 'production_center'),\n  ('gerente_general', 'production_center'),\n  ('gerente', 'production_center'),\n  ('bodeguero', 'production_center'),\n  ('conductor', 'production_center'),\n  ('cocinero', 'production_center'),\n  ('panadero', 'production_center'),\n  ('repostero', 'production_center'),\n  ('pastelero', 'production_center'),\n  ('propietario', 'satellite'),\n  ('gerente_general', 'satellite'),\n  ('gerente', 'satellite'),\n  ('bodeguero', 'satellite'),\n  ('conductor', 'satellite'),\n  ('cajero', 'satellite'),\n  ('mesero', 'satellite'),\n  ('barista', 'satellite'),\n  ('cocinero', 'satellite')\non conflict (role, site_type) do nothing"",""create or replace function public.enforce_employee_role_site()\nreturns trigger\nlanguage plpgsql\nas $$\ndeclare\n  st public.site_type;\nbegin\n  select s.site_type into st\n  from public.sites s\n  where s.id = new.site_id;\n\n  if st is null then\n    raise exception 'site_id invalido o sede sin site_type';\n  end if;\n\n  if not exists (\n    select 1\n    from public.role_site_type_rules r\n    where r.role = new.role\n      and r.site_type = st\n      and r.is_allowed = true\n  ) then\n    raise exception 'Rol \""%\"" no permitido para site_type=\""%\""', new.role, st;\n  end if;\n\n  return new;\nend;\n$$"",""create trigger trg_enforce_employee_role_site\n  before insert or update of role, site_id on public.employees\n  for each row execute function public.enforce_employee_role_site()"",""-- Apps catalog\ncreate table if not exists public.apps (\n  id uuid primary key default gen_random_uuid(),\n  code text not null unique,\n  name text not null,\n  description text,\n  is_active boolean not null default true,\n  created_at timestamptz not null default now(),\n  updated_at timestamptz not null default now()\n)"",""comment on table public.apps is 'Catalogo de aplicaciones Vento OS.'"",""insert into public.apps (code, name, description) values\n  ('shell', 'Vento OS', 'Hub y SSO'),\n  ('nexo', 'NEXO', 'Inventario y logistica'),\n  ('pass', 'Vento Pass', 'Fidelizacion'),\n  ('anima', 'ANIMA', 'Asistencia'),\n  ('fogo', 'FOGO', 'Produccion'),\n  ('pulso', 'PULSO', 'POS'),\n  ('viso', 'VISO', 'Gerencia'),\n  ('origo', 'ORIGO', 'Compras'),\n  ('aura', 'AURA', 'Marketing')\non conflict (code) do nothing"",""-- Permissions catalog\ncreate table if not exists public.app_permissions (\n  id uuid primary key default gen_random_uuid(),\n  app_id uuid not null references public.apps(id) on delete cascade,\n  code text not null,\n  name text not null,\n  description text,\n  is_active boolean not null default true,\n  created_at timestamptz not null default now(),\n  updated_at timestamptz not null default now(),\n  unique (app_id, code)\n)"",""comment on table public.app_permissions is 'Catalogo de permisos por app (vistas/acciones).'"",""-- Base access permission per app\ninsert into public.app_permissions (app_id, code, name, description)\nselect id, 'access', 'Access', 'Acceso base a la app'\nfrom public.apps\non conflict (app_id, code) do nothing"",""-- NEXO inventory permissions\ninsert into public.app_permissions (app_id, code, name, description)\nselect id, 'inventory.stock', 'Stock', 'Vista de stock por sede'\nfrom public.apps where code = 'nexo'\non conflict (app_id, code) do nothing"",""insert into public.app_permissions (app_id, code, name, description)\nselect id, 'inventory.movements', 'Movimientos', 'Ledger de movimientos'\nfrom public.apps where code = 'nexo'\non conflict (app_id, code) do nothing"",""insert into public.app_permissions (app_id, code, name, description)\nselect id, 'inventory.locations', 'LOCs', 'Ubicaciones de inventario'\nfrom public.apps where code = 'nexo'\non conflict (app_id, code) do nothing"",""insert into public.app_permissions (app_id, code, name, description)\nselect id, 'inventory.lpns', 'LPNs', 'Contenedores LPN y contenido'\nfrom public.apps where code = 'nexo'\non conflict (app_id, code) do nothing"",""insert into public.app_permissions (app_id, code, name, description)\nselect id, 'inventory.counts', 'Conteos', 'Conteos y ajustes derivados'\nfrom public.apps where code = 'nexo'\non conflict (app_id, code) do nothing"",""insert into public.app_permissions (app_id, code, name, description)\nselect id, 'inventory.adjustments', 'Ajustes', 'Ajustes manuales controlados'\nfrom public.apps where code = 'nexo'\non conflict (app_id, code) do nothing"",""insert into public.app_permissions (app_id, code, name, description)\nselect id, 'inventory.remissions', 'Remisiones', 'Solicitudes y remisiones internas'\nfrom public.apps where code = 'nexo'\non conflict (app_id, code) do nothing"",""-- FOGO production permissions\ninsert into public.app_permissions (app_id, code, name, description)\nselect id, 'production.recipes', 'Recetas', 'Consulta de recetas'\nfrom public.apps where code = 'fogo'\non conflict (app_id, code) do nothing"",""insert into public.app_permissions (app_id, code, name, description)\nselect id, 'production.orders', 'Ordenes', 'Ordenes de produccion'\nfrom public.apps where code = 'fogo'\non conflict (app_id, code) do nothing"",""-- PULSO POS permission\ninsert into public.app_permissions (app_id, code, name, description)\nselect id, 'pos.main', 'POS', 'Operacion de punto de venta'\nfrom public.apps where code = 'pulso'\non conflict (app_id, code) do nothing"",""-- Role permissions\ncreate table if not exists public.role_permissions (\n  id uuid primary key default gen_random_uuid(),\n  role text not null references public.roles(code) on delete cascade,\n  permission_id uuid not null references public.app_permissions(id) on delete cascade,\n  scope_type public.permission_scope_type not null default 'site',\n  scope_site_type public.site_type,\n  scope_area_kind text references public.area_kinds(code),\n  is_allowed boolean not null default true,\n  created_at timestamptz not null default now(),\n  unique (role, permission_id, scope_type, scope_site_type, scope_area_kind)\n)"",""comment on table public.role_permissions is 'Permisos base por rol.'"",""-- Employee-specific permissions (overrides)\ncreate table if not exists public.employee_permissions (\n  id uuid primary key default gen_random_uuid(),\n  employee_id uuid not null references public.employees(id) on delete cascade,\n  permission_id uuid not null references public.app_permissions(id) on delete cascade,\n  is_allowed boolean not null default true,\n  scope_type public.permission_scope_type not null default 'site',\n  scope_site_id uuid references public.sites(id),\n  scope_area_id uuid references public.areas(id),\n  scope_site_type public.site_type,\n  scope_area_kind text references public.area_kinds(code),\n  created_at timestamptz not null default now(),\n  unique (employee_id, permission_id, scope_type, scope_site_id, scope_area_id, scope_site_type, scope_area_kind)\n)"",""comment on table public.employee_permissions is 'Overrides de permisos por empleado.'"",""-- Seed role permissions (baseline)\n-- propietario/gerente_general: all permissions, global scope\ninsert into public.role_permissions (role, permission_id, scope_type)\nselect r.code, ap.id, 'global'::public.permission_scope_type\nfrom public.roles r\njoin public.app_permissions ap on true\nwhere r.code in ('propietario', 'gerente_general')\non conflict do nothing"",""-- gerente: all permissions for their sites\ninsert into public.role_permissions (role, permission_id, scope_type)\nselect 'gerente', ap.id, 'site'::public.permission_scope_type\nfrom public.app_permissions ap\non conflict do nothing"",""-- bodeguero: full NEXO inventory in their sites\ninsert into public.role_permissions (role, permission_id, scope_type)\nselect 'bodeguero', ap.id, 'site'::public.permission_scope_type\nfrom public.app_permissions ap\njoin public.apps a on a.id = ap.app_id\nwhere a.code = 'nexo'\n  and ap.code in (\n    'access',\n    'inventory.stock',\n    'inventory.movements',\n    'inventory.locations',\n    'inventory.lpns',\n    'inventory.counts',\n    'inventory.adjustments',\n    'inventory.remissions'\n  )\non conflict do nothing"",""-- conductor: remisiones en NEXO\ninsert into public.role_permissions (role, permission_id, scope_type)\nselect 'conductor', ap.id, 'site'::public.permission_scope_type\nfrom public.app_permissions ap\njoin public.apps a on a.id = ap.app_id\nwhere a.code = 'nexo'\n  and ap.code in ('access', 'inventory.remissions')\non conflict do nothing"",""-- cajero/mesero: POS only (satellite)\ninsert into public.role_permissions (role, permission_id, scope_type, scope_site_type)\nselect r.role, ap.id, 'site_type'::public.permission_scope_type, 'satellite'::public.site_type\nfrom public.app_permissions ap\njoin public.apps a on a.id = ap.app_id\njoin (select 'cajero'::text as role union all select 'mesero') r on true\nwhere a.code = 'pulso' and ap.code in ('access', 'pos.main')\non conflict do nothing"",""-- barista (satellite): recipes + POS\ninsert into public.role_permissions (role, permission_id, scope_type, scope_site_type)\nselect 'barista', ap.id, 'site_type'::public.permission_scope_type, 'satellite'::public.site_type\nfrom public.app_permissions ap\njoin public.apps a on a.id = ap.app_id\nwhere a.code = 'fogo' and ap.code in ('access', 'production.recipes')\non conflict do nothing"",""insert into public.role_permissions (role, permission_id, scope_type, scope_site_type)\nselect 'barista', ap.id, 'site_type'::public.permission_scope_type, 'satellite'::public.site_type\nfrom public.app_permissions ap\njoin public.apps a on a.id = ap.app_id\nwhere a.code = 'pulso' and ap.code in ('access', 'pos.main')\non conflict do nothing"",""-- cocinero (satellite): recipes + POS + remisiones\ninsert into public.role_permissions (role, permission_id, scope_type, scope_site_type)\nselect 'cocinero', ap.id, 'site_type'::public.permission_scope_type, 'satellite'::public.site_type\nfrom public.app_permissions ap\njoin public.apps a on a.id = ap.app_id\nwhere a.code = 'fogo' and ap.code in ('access', 'production.recipes')\non conflict do nothing"",""insert into public.role_permissions (role, permission_id, scope_type, scope_site_type)\nselect 'cocinero', ap.id, 'site_type'::public.permission_scope_type, 'satellite'::public.site_type\nfrom public.app_permissions ap\njoin public.apps a on a.id = ap.app_id\nwhere a.code = 'pulso' and ap.code in ('access', 'pos.main')\non conflict do nothing"",""insert into public.role_permissions (role, permission_id, scope_type, scope_site_type)\nselect 'cocinero', ap.id, 'site_type'::public.permission_scope_type, 'satellite'::public.site_type\nfrom public.app_permissions ap\njoin public.apps a on a.id = ap.app_id\nwhere a.code = 'nexo' and ap.code in ('access', 'inventory.remissions')\non conflict do nothing"",""-- cocinero/production_center: recipes + orders\ninsert into public.role_permissions (role, permission_id, scope_type, scope_site_type)\nselect 'cocinero', ap.id, 'site_type'::public.permission_scope_type, 'production_center'::public.site_type\nfrom public.app_permissions ap\njoin public.apps a on a.id = ap.app_id\nwhere a.code = 'fogo' and ap.code in ('access', 'production.recipes', 'production.orders')\non conflict do nothing"",""-- production center roles: recipes + orders\ninsert into public.role_permissions (role, permission_id, scope_type, scope_site_type)\nselect r.role, ap.id, 'site_type'::public.permission_scope_type, 'production_center'::public.site_type\nfrom public.app_permissions ap\njoin public.apps a on a.id = ap.app_id\njoin (\n  select 'panadero'::text as role\n  union all select 'repostero'\n  union all select 'pastelero'\n) r on true\nwhere a.code = 'fogo' and ap.code in ('access', 'production.recipes', 'production.orders')\non conflict do nothing"",""-- contador (admin): viso access\ninsert into public.role_permissions (role, permission_id, scope_type, scope_site_type)\nselect 'contador', ap.id, 'site_type'::public.permission_scope_type, 'admin'::public.site_type\nfrom public.app_permissions ap\njoin public.apps a on a.id = ap.app_id\nwhere a.code = 'viso' and ap.code = 'access'\non conflict do nothing"",""-- marketing (admin): aura access\ninsert into public.role_permissions (role, permission_id, scope_type, scope_site_type)\nselect 'marketing', ap.id, 'site_type'::public.permission_scope_type, 'admin'::public.site_type\nfrom public.app_permissions ap\njoin public.apps a on a.id = ap.app_id\nwhere a.code = 'aura' and ap.code = 'access'\non conflict do nothing"",""-- Permission scope evaluation helper\ncreate or replace function public.permission_scope_matches(\n  p_scope_type public.permission_scope_type,\n  p_context_site_id uuid,\n  p_context_area_id uuid,\n  p_scope_site_id uuid,\n  p_scope_area_id uuid,\n  p_scope_site_type public.site_type,\n  p_scope_area_kind text\n)\nreturns boolean\nlanguage plpgsql\nstable security definer\nset search_path to 'public'\nas $$\ndeclare\n  v_site_type public.site_type;\n  v_area_kind text;\nbegin\n  if p_scope_type = 'global' then\n    return true;\n  end if;\n\n  if p_scope_type = 'site' then\n    if p_context_site_id is null then\n      return false;\n    end if;\n    if p_scope_site_id is not null and p_scope_site_id <> p_context_site_id then\n      return false;\n    end if;\n    return public.can_access_site(p_context_site_id);\n  end if;\n\n  if p_scope_type = 'site_type' then\n    if p_context_site_id is null then\n      return false;\n    end if;\n    if not public.can_access_site(p_context_site_id) then\n      return false;\n    end if;\n    select site_type into v_site_type from public.sites where id = p_context_site_id;\n    return v_site_type = p_scope_site_type;\n  end if;\n\n  if p_scope_type = 'area' then\n    if p_context_area_id is null then\n      return false;\n    end if;\n    if p_scope_area_id is not null and p_scope_area_id <> p_context_area_id then\n      return false;\n    end if;\n    return public.can_access_area(p_context_area_id);\n  end if;\n\n  if p_scope_type = 'area_kind' then\n    if p_context_area_id is null then\n      return false;\n    end if;\n    if not public.can_access_area(p_context_area_id) then\n      return false;\n    end if;\n    select kind into v_area_kind from public.areas where id = p_context_area_id;\n    return v_area_kind = p_scope_area_kind;\n  end if;\n\n  return false;\nend;\n$$"",""-- Permission check for current user\ncreate or replace function public.has_permission(\n  p_permission_code text,\n  p_site_id uuid default null,\n  p_area_id uuid default null\n)\nreturns boolean\nlanguage plpgsql\nstable security definer\nset search_path to 'public'\nas $$\ndeclare\n  v_employee_id uuid;\n  v_role text;\n  v_permission_id uuid;\n  v_site_id uuid;\n  v_area_id uuid;\n  v_denied boolean;\n  v_allowed boolean;\nbegin\n  v_employee_id := auth.uid();\n  if v_employee_id is null then\n    return false;\n  end if;\n\n  select e.role into v_role\n  from public.employees e\n  where e.id = v_employee_id\n    and e.is_active = true;\n\n  if v_role is null then\n    return false;\n  end if;\n\n  select ap.id into v_permission_id\n  from public.app_permissions ap\n  join public.apps a on a.id = ap.app_id\n  where (a.code || '.' || ap.code) = p_permission_code\n    and a.is_active = true\n    and ap.is_active = true;\n\n  if v_permission_id is null then\n    return false;\n  end if;\n\n  v_site_id := coalesce(p_site_id, public.current_employee_site_id());\n  v_area_id := p_area_id;\n\n  select exists (\n    select 1\n    from public.employee_permissions ep\n    where ep.employee_id = v_employee_id\n      and ep.permission_id = v_permission_id\n      and ep.is_allowed = false\n      and public.permission_scope_matches(\n        ep.scope_type,\n        v_site_id,\n        v_area_id,\n        ep.scope_site_id,\n        ep.scope_area_id,\n        ep.scope_site_type,\n        ep.scope_area_kind\n      )\n  ) into v_denied;\n\n  if v_denied then\n    return false;\n  end if;\n\n  select exists (\n    select 1\n    from public.employee_permissions ep\n    where ep.employee_id = v_employee_id\n      and ep.permission_id = v_permission_id\n      and ep.is_allowed = true\n      and public.permission_scope_matches(\n        ep.scope_type,\n        v_site_id,\n        v_area_id,\n        ep.scope_site_id,\n        ep.scope_area_id,\n        ep.scope_site_type,\n        ep.scope_area_kind\n      )\n  ) into v_allowed;\n\n  if v_allowed then\n    return true;\n  end if;\n\n  select exists (\n    select 1\n    from public.role_permissions rp\n    where rp.role = v_role\n      and rp.permission_id = v_permission_id\n      and rp.is_allowed = true\n      and public.permission_scope_matches(\n        rp.scope_type,\n        v_site_id,\n        v_area_id,\n        null,\n        null,\n        rp.scope_site_type,\n        rp.scope_area_kind\n      )\n  ) into v_allowed;\n\n  return coalesce(v_allowed, false);\nend;\n$$"",""-- Update role-based policies to new codes\ndrop policy if exists \""Owners and managers can manage locations\"" on public.inventory_locations"",""create policy \""Owners and managers can manage locations\"" on public.inventory_locations\n  using ((exists (\n    select 1\n    from public.employees e\n    join public.employee_sites es on e.id = es.employee_id\n    where e.id = auth.uid()\n      and es.site_id = inventory_locations.site_id\n      and e.role = any (array['propietario'::text, 'gerente'::text, 'gerente_general'::text])\n  )))"",""drop policy if exists \""Owners can update feedback\"" on public.user_feedback"",""create policy \""Owners can update feedback\"" on public.user_feedback for update to authenticated\n  using (exists (\n    select 1\n    from public.employees\n    where employees.id = auth.uid()\n      and employees.role = 'propietario'::text\n  ))"",""drop policy if exists \""areas_select_staff\"" on public.areas"",""create policy \""areas_select_staff\"" on public.areas for select\n  using (\n    public.can_access_area(id)\n    or (\n      public.current_employee_role() = any (array['gerente'::text, 'bodeguero'::text])\n      and public.can_access_site(site_id)\n    )\n  )"",""drop policy if exists \""attendance_logs_select_manager\"" on public.attendance_logs"",""create policy \""attendance_logs_select_manager\"" on public.attendance_logs for select to authenticated\n  using (exists (\n    select 1\n    from public.employees e\n    where e.id = auth.uid()\n      and e.role = any (array['propietario'::text, 'gerente'::text, 'gerente_general'::text])\n      and (\n        e.role = any (array['propietario'::text, 'gerente_general'::text])\n        or e.site_id = attendance_logs.site_id\n      )\n  ))"",""drop policy if exists \""employee_shifts_select_manager\"" on public.employee_shifts"",""create policy \""employee_shifts_select_manager\"" on public.employee_shifts for select\n  using (exists (\n    select 1\n    from public.employees e\n    where e.id = auth.uid()\n      and e.role = any (array['gerente'::text])\n      and e.site_id = employee_shifts.site_id\n  ))"",""drop policy if exists \""employee_shifts_write_manager\"" on public.employee_shifts"",""create policy \""employee_shifts_write_manager\"" on public.employee_shifts\n  using (exists (\n    select 1\n    from public.employees e\n    where e.id = auth.uid()\n      and e.role = any (array['gerente'::text])\n      and e.site_id = employee_shifts.site_id\n  ))\n  with check (exists (\n    select 1\n    from public.employees e\n    where e.id = auth.uid()\n      and e.role = any (array['gerente'::text])\n      and e.site_id = employee_shifts.site_id\n  ))"",""drop policy if exists \""employees_select_manager\"" on public.employees"",""create policy \""employees_select_manager\"" on public.employees for select\n  using (\n    (public.is_manager_or_owner() or (public.current_employee_role() = any (array['bodeguero'::text])))\n    and public.can_access_site(site_id)\n  )"",""drop policy if exists \""inventory_movements_insert_roles\"" on public.inventory_movements"",""create policy \""inventory_movements_insert_roles\"" on public.inventory_movements for insert\n  with check (\n    public.current_employee_role() = any (array['propietario'::text, 'gerente'::text, 'gerente_general'::text, 'cajero'::text, 'bodeguero'::text])\n    and public.can_access_site(site_id)\n  )"",""drop policy if exists \""loyalty_redemptions_select_cashier\"" on public.loyalty_redemptions"",""create policy \""loyalty_redemptions_select_cashier\"" on public.loyalty_redemptions for select to authenticated\n  using (exists (\n    select 1\n    from public.employees e\n    join public.loyalty_rewards r on r.id = loyalty_redemptions.reward_id\n    where e.id = auth.uid()\n      and e.is_active = true\n      and e.role = any (array['propietario'::text, 'gerente'::text, 'gerente_general'::text, 'cajero'::text])\n      and (\n        e.site_id = r.site_id\n        or exists (\n          select 1\n          from public.employee_sites es\n          where es.employee_id = e.id\n            and es.is_active = true\n            and es.site_id = r.site_id\n        )\n      )\n  ))"",""drop policy if exists \""loyalty_redemptions_validate_cashier\"" on public.loyalty_redemptions"",""create policy \""loyalty_redemptions_validate_cashier\"" on public.loyalty_redemptions for update to authenticated\n  using (\n    status = 'pending'::text\n    and exists (\n      select 1\n      from public.employees e\n      join public.loyalty_rewards r on r.id = loyalty_redemptions.reward_id\n      where e.id = auth.uid()\n        and e.is_active = true\n        and e.role = any (array['propietario'::text, 'gerente'::text, 'gerente_general'::text, 'cajero'::text])\n        and (\n          e.site_id = r.site_id\n          or exists (\n            select 1\n            from public.employee_sites es\n            where es.employee_id = e.id\n              and es.is_active = true\n              and es.site_id = r.site_id\n          )\n        )\n    )\n  )\n  with check (\n    status = 'validated'::text\n    and exists (\n      select 1\n      from public.employees e\n      join public.loyalty_rewards r on r.id = loyalty_redemptions.reward_id\n      where e.id = auth.uid()\n        and e.is_active = true\n        and e.role = any (array['propietario'::text, 'gerente'::text, 'gerente_general'::text, 'cajero'::text])\n        and (\n          e.site_id = r.site_id\n          or exists (\n            select 1\n            from public.employee_sites es\n            where es.employee_id = e.id\n              and es.is_active = true\n              and es.site_id = r.site_id\n          )\n        )\n    )\n  )"",""drop policy if exists \""production_batches_write_production\"" on public.production_batches"",""create policy \""production_batches_write_production\"" on public.production_batches\n  using (\n    public.current_employee_role() = any (\n      array[\n        'propietario'::text,\n        'gerente'::text,\n        'gerente_general'::text,\n        'barista'::text,\n        'cocinero'::text,\n        'panadero'::text,\n        'repostero'::text,\n        'pastelero'::text\n      ]\n    )\n    and (\n      public.current_employee_role() = any (array['propietario'::text, 'gerente'::text, 'gerente_general'::text])\n      or site_id = public.current_employee_site_id()\n    )\n  )\n  with check (\n    public.current_employee_role() = any (\n      array[\n        'propietario'::text,\n        'gerente'::text,\n        'gerente_general'::text,\n        'barista'::text,\n        'cocinero'::text,\n        'panadero'::text,\n        'repostero'::text,\n        'pastelero'::text\n      ]\n    )\n    and (\n      public.current_employee_role() = any (array['propietario'::text, 'gerente'::text, 'gerente_general'::text])\n      or site_id = public.current_employee_site_id()\n    )\n  )"",""drop policy if exists \""users_select_cashier\"" on public.users"",""create policy \""users_select_cashier\"" on public.users for select to authenticated\n  using (exists (\n    select 1\n    from public.employees e\n    where e.id = auth.uid()\n      and e.is_active = true\n      and e.role = any (array['propietario'::text, 'gerente'::text, 'gerente_general'::text, 'cajero'::text])\n  ))"",""drop policy if exists \""users_select_cashier_for_qr\"" on public.users"",""create policy \""users_select_cashier_for_qr\"" on public.users for select to authenticated\n  using (exists (\n    select 1\n    from public.employees e\n    where e.id = auth.uid()\n      and e.is_active = true\n      and e.role = any (array['propietario'::text, 'gerente'::text, 'gerente_general'::text, 'cajero'::text])\n  ))"",""-- RLS for new tables\nalter table public.area_kinds enable row level security"",""alter table public.roles enable row level security"",""alter table public.role_site_type_rules enable row level security"",""alter table public.apps enable row level security"",""alter table public.app_permissions enable row level security"",""alter table public.role_permissions enable row level security"",""alter table public.employee_permissions enable row level security"",""create policy \""area_kinds_select_all\"" on public.area_kinds\n  for select to authenticated\n  using (true)"",""create policy \""area_kinds_manage_owner\"" on public.area_kinds\n  for all to authenticated\n  using (public.is_owner() or public.is_global_manager())\n  with check (public.is_owner() or public.is_global_manager())"",""create policy \""roles_select_all\"" on public.roles\n  for select to authenticated\n  using (true)"",""create policy \""roles_manage_owner\"" on public.roles\n  for all to authenticated\n  using (public.is_owner() or public.is_global_manager())\n  with check (public.is_owner() or public.is_global_manager())"",""create policy \""role_site_type_rules_select_all\"" on public.role_site_type_rules\n  for select to authenticated\n  using (true)"",""create policy \""role_site_type_rules_manage_owner\"" on public.role_site_type_rules\n  for all to authenticated\n  using (public.is_owner() or public.is_global_manager())\n  with check (public.is_owner() or public.is_global_manager())"",""create policy \""apps_select_all\"" on public.apps\n  for select to authenticated\n  using (true)"",""create policy \""apps_manage_owner\"" on public.apps\n  for all to authenticated\n  using (public.is_owner() or public.is_global_manager())\n  with check (public.is_owner() or public.is_global_manager())"",""create policy \""app_permissions_select_all\"" on public.app_permissions\n  for select to authenticated\n  using (true)"",""create policy \""app_permissions_manage_owner\"" on public.app_permissions\n  for all to authenticated\n  using (public.is_owner() or public.is_global_manager())\n  with check (public.is_owner() or public.is_global_manager())"",""create policy \""role_permissions_select_all\"" on public.role_permissions\n  for select to authenticated\n  using (true)"",""create policy \""role_permissions_manage_owner\"" on public.role_permissions\n  for all to authenticated\n  using (public.is_owner() or public.is_global_manager())\n  with check (public.is_owner() or public.is_global_manager())"",""create policy \""employee_permissions_select_self\"" on public.employee_permissions\n  for select to authenticated\n  using (employee_id = auth.uid())"",""create policy \""employee_permissions_select_owner\"" on public.employee_permissions\n  for select to authenticated\n  using (public.is_owner() or public.is_global_manager())"",""create policy \""employee_permissions_manage_owner\"" on public.employee_permissions\n  for all to authenticated\n  using (public.is_owner() or public.is_global_manager())\n  with check (public.is_owner() or public.is_global_manager())"",""grant execute on function public.permission_scope_matches(\n  public.permission_scope_type,\n  uuid,\n  uuid,\n  uuid,\n  uuid,\n  public.site_type,\n  text\n) to authenticated"",""grant execute on function public.has_permission(text, uuid, uuid) to authenticated""]",permissions_core
20260118193000,"[""-- Remisiones NEXO + lotes de produccion (manual) y etiquetas.\n\n-- Restock requests: workflow + tracking\nalter table public.restock_requests\n  add column if not exists request_code text,\n  add column if not exists requested_by_site_id uuid references public.sites(id),\n  add column if not exists status_updated_at timestamptz default now(),\n  add column if not exists prepared_at timestamptz,\n  add column if not exists prepared_by uuid references public.employees(id),\n  add column if not exists in_transit_at timestamptz,\n  add column if not exists in_transit_by uuid references public.employees(id),\n  add column if not exists received_at timestamptz,\n  add column if not exists received_by uuid references public.employees(id),\n  add column if not exists cancelled_at timestamptz,\n  add column if not exists closed_at timestamptz,\n  add column if not exists priority text default 'normal',\n  add column if not exists request_type text default 'internal'"",""update public.restock_requests\nset requested_by_site_id = coalesce(requested_by_site_id, to_site_id)\nwhere requested_by_site_id is null"",""-- Restock items: quantities per etapa\nalter table public.restock_request_items\n  add column if not exists prepared_quantity numeric not null default 0,\n  add column if not exists shipped_quantity numeric not null default 0,\n  add column if not exists received_quantity numeric not null default 0,\n  add column if not exists shortage_quantity numeric not null default 0,\n  add column if not exists item_status text not null default 'pending',\n  add column if not exists notes text"",""-- Supply routes (satellite -> fulfillment site)\ncreate table if not exists public.site_supply_routes (\n  id uuid primary key default gen_random_uuid(),\n  requesting_site_id uuid not null references public.sites(id),\n  fulfillment_site_id uuid not null references public.sites(id),\n  is_active boolean not null default true,\n  created_at timestamptz not null default now(),\n  updated_at timestamptz not null default now(),\n  unique (requesting_site_id, fulfillment_site_id)\n)"",""comment on table public.site_supply_routes is 'Mapa de sede solicitante -> sede que abastece remisiones.'"",""alter table public.site_supply_routes enable row level security"",""create policy \""site_supply_routes_select_all\"" on public.site_supply_routes\n  for select to authenticated\n  using (true)"",""create policy \""site_supply_routes_manage_owner\"" on public.site_supply_routes\n  for all to authenticated\n  using (public.is_owner() or public.is_global_manager())\n  with check (public.is_owner() or public.is_global_manager())"",""-- Production batches: code + expiracion\nalter table public.production_batches\n  add column if not exists batch_code text,\n  add column if not exists expires_at timestamptz"",""create or replace function public.set_production_batch_code()\nreturns trigger\nlanguage plpgsql\nas $$\nbegin\n  if new.id is null then\n    new.id := gen_random_uuid();\n  end if;\n\n  if new.batch_code is null or btrim(new.batch_code) = '' then\n    new.batch_code := 'BATCH-' || upper(substr(replace(new.id::text, '-', ''), 1, 8));\n  end if;\n\n  return new;\nend;\n$$"",""drop trigger if exists trg_set_production_batch_code on public.production_batches"",""create trigger trg_set_production_batch_code\n  before insert on public.production_batches\n  for each row execute function public.set_production_batch_code()"",""-- Inventory movements for remisiones\ncreate or replace function public.apply_restock_shipment(p_request_id uuid)\nreturns void\nlanguage plpgsql\nsecurity definer\nset search_path to 'public'\nas $$\ndeclare\n  v_request record;\n  v_item record;\n  v_qty numeric;\nbegin\n  select *\n  into v_request\n  from public.restock_requests\n  where id = p_request_id;\n\n  if v_request.id is null then\n    raise exception 'restock_request not found: %', p_request_id;\n  end if;\n\n  if v_request.from_site_id is null then\n    raise exception 'from_site_id requerido para salida de remision';\n  end if;\n\n  for v_item in\n    select *\n    from public.restock_request_items\n    where request_id = p_request_id\n  loop\n    v_qty := coalesce(v_item.shipped_quantity, 0);\n    if v_qty <= 0 then\n      continue;\n    end if;\n\n    insert into public.inventory_movements (\n      site_id,\n      product_id,\n      movement_type,\n      quantity,\n      note,\n      related_restock_request_id\n    )\n    values (\n      v_request.from_site_id,\n      v_item.product_id,\n      'transfer_out',\n      v_qty,\n      'Salida remision ' || p_request_id::text,\n      p_request_id\n    );\n\n    insert into public.inventory_stock_by_site (site_id, product_id, current_qty, updated_at)\n    values (v_request.from_site_id, v_item.product_id, -v_qty, now())\n    on conflict (site_id, product_id)\n    do update set\n      current_qty = public.inventory_stock_by_site.current_qty + excluded.current_qty,\n      updated_at = now();\n  end loop;\nend;\n$$"",""create or replace function public.apply_restock_receipt(p_request_id uuid)\nreturns void\nlanguage plpgsql\nsecurity definer\nset search_path to 'public'\nas $$\ndeclare\n  v_request record;\n  v_item record;\n  v_qty numeric;\nbegin\n  select *\n  into v_request\n  from public.restock_requests\n  where id = p_request_id;\n\n  if v_request.id is null then\n    raise exception 'restock_request not found: %', p_request_id;\n  end if;\n\n  if v_request.to_site_id is null then\n    raise exception 'to_site_id requerido para recepcion de remision';\n  end if;\n\n  for v_item in\n    select *\n    from public.restock_request_items\n    where request_id = p_request_id\n  loop\n    v_qty := coalesce(v_item.received_quantity, 0);\n    if v_qty <= 0 then\n      continue;\n    end if;\n\n    insert into public.inventory_movements (\n      site_id,\n      product_id,\n      movement_type,\n      quantity,\n      note,\n      related_restock_request_id\n    )\n    values (\n      v_request.to_site_id,\n      v_item.product_id,\n      'transfer_in',\n      v_qty,\n      'Recepcion remision ' || p_request_id::text,\n      p_request_id\n    );\n\n    insert into public.inventory_stock_by_site (site_id, product_id, current_qty, updated_at)\n    values (v_request.to_site_id, v_item.product_id, v_qty, now())\n    on conflict (site_id, product_id)\n    do update set\n      current_qty = public.inventory_stock_by_site.current_qty + excluded.current_qty,\n      updated_at = now();\n  end loop;\nend;\n$$"",""grant execute on function public.apply_restock_shipment(uuid) to authenticated"",""grant execute on function public.apply_restock_receipt(uuid) to authenticated""]",remissions_production
20260118195000,"[""-- NEXO RLS hardening + audit for Fase 1\n\n-- Minimal audit column for movements\nalter table public.inventory_movements\n  add column if not exists created_by uuid references public.employees(id)"",""alter table public.inventory_movements\n  alter column created_by set default auth.uid()"",""-- Inventory movements\ndrop policy if exists \""inventory_movements_insert_roles\"" on public.inventory_movements"",""drop policy if exists \""inventory_movements_select_site\"" on public.inventory_movements"",""drop policy if exists \""inventory_movements_update_owner\"" on public.inventory_movements"",""create policy \""inventory_movements_select_permission\"" on public.inventory_movements\n  for select to authenticated\n  using (\n    public.has_permission('nexo.inventory.movements', site_id)\n  )"",""create policy \""inventory_movements_insert_permission\"" on public.inventory_movements\n  for insert to authenticated\n  with check (\n    public.has_permission('nexo.inventory.movements', site_id)\n    or public.has_permission('nexo.inventory.remissions.prepare', site_id)\n    or public.has_permission('nexo.inventory.remissions.receive', site_id)\n    or public.has_permission('nexo.inventory.production_batches', site_id)\n  )"",""-- Inventory stock by site\ndrop policy if exists \""inventory_stock_select_site\"" on public.inventory_stock_by_site"",""drop policy if exists \""inventory_stock_write_manager\"" on public.inventory_stock_by_site"",""create policy \""inventory_stock_select_permission\"" on public.inventory_stock_by_site\n  for select to authenticated\n  using (\n    public.has_permission('nexo.inventory.stock', site_id)\n  )"",""create policy \""inventory_stock_insert_permission\"" on public.inventory_stock_by_site\n  for insert to authenticated\n  with check (\n    public.has_permission('nexo.inventory.stock', site_id)\n    or public.has_permission('nexo.inventory.remissions.prepare', site_id)\n    or public.has_permission('nexo.inventory.remissions.receive', site_id)\n    or public.has_permission('nexo.inventory.production_batches', site_id)\n  )"",""create policy \""inventory_stock_update_permission\"" on public.inventory_stock_by_site\n  for update to authenticated\n  using (\n    public.has_permission('nexo.inventory.stock', site_id)\n    or public.has_permission('nexo.inventory.remissions.prepare', site_id)\n    or public.has_permission('nexo.inventory.remissions.receive', site_id)\n    or public.has_permission('nexo.inventory.production_batches', site_id)\n  )\n  with check (\n    public.has_permission('nexo.inventory.stock', site_id)\n    or public.has_permission('nexo.inventory.remissions.prepare', site_id)\n    or public.has_permission('nexo.inventory.remissions.receive', site_id)\n    or public.has_permission('nexo.inventory.production_batches', site_id)\n  )"",""-- Inventory locations (LOC)\ndrop policy if exists \""Employees can view locations of their sites\"" on public.inventory_locations"",""drop policy if exists \""Owners and managers can manage locations\"" on public.inventory_locations"",""create policy \""inventory_locations_select_permission\"" on public.inventory_locations\n  for select to authenticated\n  using (\n    public.has_permission('nexo.inventory.locations', site_id)\n  )"",""create policy \""inventory_locations_insert_permission\"" on public.inventory_locations\n  for insert to authenticated\n  with check (\n    public.has_permission('nexo.inventory.locations', site_id)\n  )"",""create policy \""inventory_locations_update_permission\"" on public.inventory_locations\n  for update to authenticated\n  using (\n    public.has_permission('nexo.inventory.locations', site_id)\n  )\n  with check (\n    public.has_permission('nexo.inventory.locations', site_id)\n  )"",""create policy \""inventory_locations_delete_permission\"" on public.inventory_locations\n  for delete to authenticated\n  using (\n    public.has_permission('nexo.inventory.locations', site_id)\n  )"",""-- Inventory LPNs\ndrop policy if exists \""Employees can view LPNs of their sites\"" on public.inventory_lpns"",""drop policy if exists \""Staff can manage LPNs\"" on public.inventory_lpns"",""create policy \""inventory_lpns_select_permission\"" on public.inventory_lpns\n  for select to authenticated\n  using (\n    public.has_permission('nexo.inventory.lpns', site_id)\n  )"",""create policy \""inventory_lpns_insert_permission\"" on public.inventory_lpns\n  for insert to authenticated\n  with check (\n    public.has_permission('nexo.inventory.lpns', site_id)\n  )"",""create policy \""inventory_lpns_update_permission\"" on public.inventory_lpns\n  for update to authenticated\n  using (\n    public.has_permission('nexo.inventory.lpns', site_id)\n  )\n  with check (\n    public.has_permission('nexo.inventory.lpns', site_id)\n  )"",""create policy \""inventory_lpns_delete_permission\"" on public.inventory_lpns\n  for delete to authenticated\n  using (\n    public.has_permission('nexo.inventory.lpns', site_id)\n  )"",""-- Procurement receptions\ndrop policy if exists \""employees_crud_receptions\"" on public.procurement_receptions"",""drop policy if exists \""employees_crud_reception_items\"" on public.procurement_reception_items"",""create policy \""procurement_receptions_select_permission\"" on public.procurement_receptions\n  for select to authenticated\n  using (\n    public.has_permission('nexo.inventory.stock', site_id)\n  )"",""create policy \""procurement_receptions_insert_permission\"" on public.procurement_receptions\n  for insert to authenticated\n  with check (\n    public.has_permission('nexo.inventory.stock', site_id)\n  )"",""create policy \""procurement_receptions_update_permission\"" on public.procurement_receptions\n  for update to authenticated\n  using (\n    public.has_permission('nexo.inventory.stock', site_id)\n  )\n  with check (\n    public.has_permission('nexo.inventory.stock', site_id)\n  )"",""create policy \""procurement_receptions_delete_permission\"" on public.procurement_receptions\n  for delete to authenticated\n  using (\n    public.has_permission('nexo.inventory.stock', site_id)\n  )"",""create policy \""procurement_reception_items_select_permission\"" on public.procurement_reception_items\n  for select to authenticated\n  using (\n    exists (\n      select 1\n      from public.procurement_receptions pr\n      where pr.id = procurement_reception_items.reception_id\n        and public.has_permission('nexo.inventory.stock', pr.site_id)\n    )\n  )"",""create policy \""procurement_reception_items_insert_permission\"" on public.procurement_reception_items\n  for insert to authenticated\n  with check (\n    exists (\n      select 1\n      from public.procurement_receptions pr\n      where pr.id = procurement_reception_items.reception_id\n        and public.has_permission('nexo.inventory.stock', pr.site_id)\n    )\n  )"",""create policy \""procurement_reception_items_update_permission\"" on public.procurement_reception_items\n  for update to authenticated\n  using (\n    exists (\n      select 1\n      from public.procurement_receptions pr\n      where pr.id = procurement_reception_items.reception_id\n        and public.has_permission('nexo.inventory.stock', pr.site_id)\n    )\n  )\n  with check (\n    exists (\n      select 1\n      from public.procurement_receptions pr\n      where pr.id = procurement_reception_items.reception_id\n        and public.has_permission('nexo.inventory.stock', pr.site_id)\n    )\n  )"",""create policy \""procurement_reception_items_delete_permission\"" on public.procurement_reception_items\n  for delete to authenticated\n  using (\n    exists (\n      select 1\n      from public.procurement_receptions pr\n      where pr.id = procurement_reception_items.reception_id\n        and public.has_permission('nexo.inventory.stock', pr.site_id)\n    )\n  )"",""-- Restock requests (remisiones)\ndrop policy if exists \""restock_requests_delete_owner\"" on public.restock_requests"",""drop policy if exists \""restock_requests_insert_site\"" on public.restock_requests"",""drop policy if exists \""restock_requests_select_site\"" on public.restock_requests"",""drop policy if exists \""restock_requests_update_site\"" on public.restock_requests"",""create policy \""restock_requests_select_permission\"" on public.restock_requests\n  for select to authenticated\n  using (\n    public.has_permission('nexo.inventory.remissions', from_site_id)\n    or public.has_permission('nexo.inventory.remissions', to_site_id)\n    or public.has_permission('nexo.inventory.remissions.all_sites')\n  )"",""create policy \""restock_requests_insert_permission\"" on public.restock_requests\n  for insert to authenticated\n  with check (\n    to_site_id is not null\n    and public.has_permission('nexo.inventory.remissions.request', to_site_id)\n  )"",""create policy \""restock_requests_update_permission\"" on public.restock_requests\n  for update to authenticated\n  using (\n    public.has_permission('nexo.inventory.remissions.prepare', from_site_id)\n    or public.has_permission('nexo.inventory.remissions.receive', to_site_id)\n    or public.has_permission('nexo.inventory.remissions.cancel')\n  )\n  with check (\n    public.has_permission('nexo.inventory.remissions.prepare', from_site_id)\n    or public.has_permission('nexo.inventory.remissions.receive', to_site_id)\n    or public.has_permission('nexo.inventory.remissions.cancel')\n  )"",""create policy \""restock_requests_delete_permission\"" on public.restock_requests\n  for delete to authenticated\n  using (\n    public.has_permission('nexo.inventory.remissions.cancel')\n  )"",""drop policy if exists \""restock_request_items_insert_site\"" on public.restock_request_items"",""drop policy if exists \""restock_request_items_select_site\"" on public.restock_request_items"",""drop policy if exists \""restock_request_items_update_site\"" on public.restock_request_items"",""create policy \""restock_request_items_select_permission\"" on public.restock_request_items\n  for select to authenticated\n  using (\n    exists (\n      select 1\n      from public.restock_requests r\n      where r.id = restock_request_items.request_id\n        and (\n          public.has_permission('nexo.inventory.remissions', r.from_site_id)\n          or public.has_permission('nexo.inventory.remissions', r.to_site_id)\n          or public.has_permission('nexo.inventory.remissions.all_sites')\n        )\n    )\n  )"",""create policy \""restock_request_items_insert_permission\"" on public.restock_request_items\n  for insert to authenticated\n  with check (\n    exists (\n      select 1\n      from public.restock_requests r\n      where r.id = restock_request_items.request_id\n        and (\n          public.has_permission('nexo.inventory.remissions.request', r.to_site_id)\n          or public.has_permission('nexo.inventory.remissions.prepare', r.from_site_id)\n          or public.has_permission('nexo.inventory.remissions.receive', r.to_site_id)\n          or public.has_permission('nexo.inventory.remissions.cancel')\n        )\n    )\n  )"",""create policy \""restock_request_items_update_permission\"" on public.restock_request_items\n  for update to authenticated\n  using (\n    exists (\n      select 1\n      from public.restock_requests r\n      where r.id = restock_request_items.request_id\n        and (\n          public.has_permission('nexo.inventory.remissions.request', r.to_site_id)\n          or public.has_permission('nexo.inventory.remissions.prepare', r.from_site_id)\n          or public.has_permission('nexo.inventory.remissions.receive', r.to_site_id)\n          or public.has_permission('nexo.inventory.remissions.cancel')\n        )\n    )\n  )\n  with check (\n    exists (\n      select 1\n      from public.restock_requests r\n      where r.id = restock_request_items.request_id\n        and (\n          public.has_permission('nexo.inventory.remissions.request', r.to_site_id)\n          or public.has_permission('nexo.inventory.remissions.prepare', r.from_site_id)\n          or public.has_permission('nexo.inventory.remissions.receive', r.to_site_id)\n          or public.has_permission('nexo.inventory.remissions.cancel')\n        )\n    )\n  )"",""-- Remissions movement application permissions\ncreate or replace function public.apply_restock_shipment(p_request_id uuid)\nreturns void\nlanguage plpgsql\nsecurity definer\nset search_path to 'public'\nas $$\ndeclare\n  v_request record;\n  v_item record;\n  v_qty numeric;\nbegin\n  select *\n  into v_request\n  from public.restock_requests\n  where id = p_request_id;\n\n  if v_request.id is null then\n    raise exception 'restock_request not found: %', p_request_id;\n  end if;\n\n  if v_request.from_site_id is null then\n    raise exception 'from_site_id requerido para salida de remision';\n  end if;\n\n  if not public.has_permission('nexo.inventory.remissions.prepare', v_request.from_site_id) then\n    raise exception 'permission denied: remissions.prepare';\n  end if;\n\n  for v_item in\n    select *\n    from public.restock_request_items\n    where request_id = p_request_id\n  loop\n    v_qty := coalesce(v_item.shipped_quantity, 0);\n    if v_qty <= 0 then\n      continue;\n    end if;\n\n    insert into public.inventory_movements (\n      site_id,\n      product_id,\n      movement_type,\n      quantity,\n      note,\n      related_restock_request_id\n    )\n    values (\n      v_request.from_site_id,\n      v_item.product_id,\n      'transfer_out',\n      v_qty,\n      'Salida remision ' || p_request_id::text,\n      p_request_id\n    );\n\n    insert into public.inventory_stock_by_site (site_id, product_id, current_qty, updated_at)\n    values (v_request.from_site_id, v_item.product_id, -v_qty, now())\n    on conflict (site_id, product_id)\n    do update set\n      current_qty = public.inventory_stock_by_site.current_qty + excluded.current_qty,\n      updated_at = now();\n  end loop;\nend;\n$$"",""create or replace function public.apply_restock_receipt(p_request_id uuid)\nreturns void\nlanguage plpgsql\nsecurity definer\nset search_path to 'public'\nas $$\ndeclare\n  v_request record;\n  v_item record;\n  v_qty numeric;\nbegin\n  select *\n  into v_request\n  from public.restock_requests\n  where id = p_request_id;\n\n  if v_request.id is null then\n    raise exception 'restock_request not found: %', p_request_id;\n  end if;\n\n  if v_request.to_site_id is null then\n    raise exception 'to_site_id requerido para recepcion de remision';\n  end if;\n\n  if not public.has_permission('nexo.inventory.remissions.receive', v_request.to_site_id) then\n    raise exception 'permission denied: remissions.receive';\n  end if;\n\n  for v_item in\n    select *\n    from public.restock_request_items\n    where request_id = p_request_id\n  loop\n    v_qty := coalesce(v_item.received_quantity, 0);\n    if v_qty <= 0 then\n      continue;\n    end if;\n\n    insert into public.inventory_movements (\n      site_id,\n      product_id,\n      movement_type,\n      quantity,\n      note,\n      related_restock_request_id\n    )\n    values (\n      v_request.to_site_id,\n      v_item.product_id,\n      'transfer_in',\n      v_qty,\n      'Recepcion remision ' || p_request_id::text,\n      p_request_id\n    );\n\n    insert into public.inventory_stock_by_site (site_id, product_id, current_qty, updated_at)\n    values (v_request.to_site_id, v_item.product_id, v_qty, now())\n    on conflict (site_id, product_id)\n    do update set\n      current_qty = public.inventory_stock_by_site.current_qty + excluded.current_qty,\n      updated_at = now();\n  end loop;\nend;\n$$""]",nexo_rls_permissions